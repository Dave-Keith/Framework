---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r analysis, echo=F, include=F, paged.print=FALSE,cache=F}
require(ggplot2)
require(dplyr)
require(tidyr)
load("C:/Users/keyserf/Documents/temp_data/testing_results_framework2.RData")
framework2 <- list(SS.summary=SS.summary, merged.survey.obj=merged.survey.obj, survey.obj=survey.obj, cf.data=cf.data)
load("C:/Users/keyserf/Documents/temp_data/testing_results_framework3.RData") #75-90
framework3 <- list(SS.summary=SS.summary, merged.survey.obj=merged.survey.obj, survey.obj=survey.obj, cf.data=cf.data)
# load("C:/Users/keyserf/Documents/temp_data/testing_results_framework4.RData") # 80-95
# framework4 <- list(SS.summary=SS.summary, merged.survey.obj=merged.survey.obj, survey.obj=survey.obj, cf.data=cf.data)
nickname <- "fw3"

load("Y:/Offshore/Assessment/Data/Fishery_data/Summary/2022/OSAC_tidy_logs.RData")

plotsGo <- "Y:/Offshore/Assessment/Framework/SFA_25_26_2024/DataInputs/"

french <- T # set to T for french
if(french == T) {
  nickname <- paste0(nickname, "_fr")
}

require(rosettafish)
funs <- c("https://raw.githubusercontent.com/freyakeyser/rosetta_shell/main/terms.csv")
# Now run through a quick loop to load each one, just be sure that your working directory is read/write!
for(fun in funs) 
{
  download.file(fun,destfile = basename(fun))
  rosetta_terms <- read.csv(paste0(getwd(),"/",basename(fun)))
  file.remove(paste0(getwd(),"/",basename(fun)))
}

```

```{r}
# effect of recruit size bin on abundances

for (b in c("BBn", "BBs", "Sab", "Ban", "Mid")){
  framework2$survey.obj[[b]]$model.dat$recruitsize <- "85-95"
  framework3$survey.obj[[b]]$model.dat$recruitsize <- "75-90"
  framework4$survey.obj[[b]]$model.dat$recruitsize <- "80-95"
  compare <- full_join(framework2$survey.obj[[b]]$model.dat, framework3$survey.obj[[b]]$model.dat)
  compare <- full_join(compare, framework4$survey.obj[[b]]$model.dat)
  compare <- select(compare, year, NPR, NR, N, IPR, IR, I, CS, RS, recruitsize)
  compare <- pivot_longer(compare, cols=names(compare)[!names(compare) %in% c("CS", "RS", "recruitsize", "year")])

  compare$name <- factor(compare$name, levels=c("IPR", "IR", "I", "NPR", "NR", "N"))
    
  print(ggplot() + 
          geom_line(data=compare, aes(year, value, colour=recruitsize, group=recruitsize)) + 
          geom_point(data=compare, aes(year, value, colour=recruitsize, group=recruitsize)) + 
          facet_wrap(~name, scales="free_y") + 
          ggtitle(b))
}
```

```{r bankpertow, echo=F, include=F}
# Abundance and Biomass TS, FR only

# prep data for TS plotting
bankpertow <- NULL

# Mid, Ban
for(bank in c("Mid", "Ban")){
  df <- SS.summary[[bank]] %>%
    dplyr::select(bank, year, n, N, NR, NPR, N.cv, NR.cv, NPR.cv, I, IR, IPR, I.cv, IR.cv, IPR.cv)
  bankpertow <- rbind(bankpertow, df)
}

dim(bankpertow)

# Ger
dim(merged.survey.obj)
bankpertow <- merged.survey.obj %>%
  dplyr::mutate(bank="Ger") %>%
  dplyr::select(bank, year, n, N, NR, NPR, N.cv, NR.cv, NPR.cv, I, IR, IPR, I.cv, IR.cv, IPR.cv) %>%
  full_join(bankpertow)

dim(bankpertow)

dim(survey.obj$Ger$model.dat)
bankpertow <- survey.obj$Ger$model.dat %>%
  dplyr::mutate(bank="Ger") %>%
  dplyr::select(bank, year, n, N, NR, NPR, N.cv, NR.cv, NPR.cv, I, IR, IPR, I.cv, IR.cv, IPR.cv) %>%
  full_join(bankpertow)

dim(bankpertow)

bankpertow <- full_join(bankpertow, data.frame(bank="Ger", year=2020))

# BBn, BBs
for(b in c("BBn", "BBs")){
  print(dim(survey.obj[[b]]$bankpertow))
  bankpertow <- survey.obj[[b]]$bankpertow %>%
    dplyr::mutate(bank=b) %>%
    dplyr::select(bank, year, N, NR, NPR, N.se, NR.se, NPR.se, I, IR, IPR, I.se, IR.se, IPR.se) %>%
    rename(N.cv=N.se, NR.cv=NR.se, NPR.cv=NPR.se, I.cv=I.se, IR.cv = IR.se, IPR.cv=IPR.se)%>%
    full_join(bankpertow)

  bankpertow <- full_join(bankpertow, data.frame(bank=b, year=2020))

  print(dim(bankpertow))
}

# Sab
source("~/GitHub/Assessment_fns/Survey_and_OSAC/survey.ts.r", echo=TRUE)
npertow <- survey.ts(
  survey.obj$Sab[[1]],
  min(survey.obj$Sab[[1]]$year, na.rm = T):yr,
  pdf = F,
  areas = surv.info$towable_area[surv.info$startyear==2018],
  se = T) %>%
  mutate(bank="Sab") 
ipertow <- survey.ts(
  survey.obj$Sab[[1]],
  min(survey.obj$Sab[[1]]$year, na.rm = T):yr,
  pdf = F,
  areas = surv.info$towable_area[surv.info$startyear==2018],
  se = T,
  type="B") %>%
  mutate(bank="Sab") 

bankpertow <- full_join(npertow, ipertow) %>%
  full_join(bankpertow)


bankpertow <- bankpertow %>%
  pivot_longer(cols=c("N", "NR", "NPR", "I", "IPR", "IR"), values_to = "index.val", names_to="index")

cv <- bankpertow %>%
  dplyr::select(bank, year, n, N.cv, NR.cv, NPR.cv, I.cv, IPR.cv, IR.cv) %>%
  pivot_longer(cols=c("N.cv", "NR.cv", "NPR.cv", "I.cv", "IPR.cv", "IR.cv"), values_to = "cv.val", names_to="index") %>%
  dplyr::select(bank, year, n, index, cv.val)
cv$index <- gsub(x=cv$index, ".cv", "")

bankpertow <- bankpertow %>%
  dplyr::select(bank, year, n, index, index.val) %>%
  full_join(cv)

bankpertow$sfa[bankpertow$bank %in% c("Ban", "Mid", "Sab")] <- 25
bankpertow$sfa[bankpertow$bank %in% c("BBn", "BBs", "Ger")] <- 26

bankpertow$size[bankpertow$index %in% c("N", "I")] <- "FR"
bankpertow$size[bankpertow$index %in% c("NPR", "IPR")] <- "PR"
bankpertow$size[bankpertow$index %in% c("NR", "IR")] <- "R"

bankpertow$index <- gsub(x=bankpertow$index, "P", "")
bankpertow$index <- gsub(x=bankpertow$index, "R", "")


bankpertow$size <- factor(bankpertow$size,
                          levels=c("PR", "R", "FR"))
if(french==F) {
  bankpertow$size2 <- factor(bankpertow$size,
                             levels=c("PR", "R", "FR"),
                             labels=c("Pre-recruit", "Recruit", "Fully recruited"))
  
  bankpertow$index2 <- factor(bankpertow$index,
                              levels=c("N", "I"),
                              labels=c(expression(frac("N", "tow")),
                                       expression(frac("g", "tow"))))
}
if(french==T) {
  bankpertow$size2 <- factor(bankpertow$size,
                             levels=c("PR", "R", "FR"),
                             labels=c(en2fr("Pre-recruit", custom_terms=rosetta_terms), 
                                      en2fr("Recruit",  custom_terms=rosetta_terms), 
                                      en2fr("Fully recruited", custom_terms=rosetta_terms)))
  
  bankpertow$index2 <- factor(bankpertow$index,
                              levels=c("N", "I"),
                              labels=c(expression(frac("N", "trait")),
                                       expression(frac("g", "trait"))))
}

if(french==F) man.unit <- "Management\nunit"
if(french==T) man.unit <- "Zone de\ngestion"

sfa <- c(25,26)
for(sfa in sfa){
  
  N <- ggplot() + geom_line(data=bankpertow[bankpertow$sfa==sfa & bankpertow$index=="N",],
                            aes(year, index.val, colour=bank)) +
    geom_point(data=bankpertow[bankpertow$sfa==sfa & bankpertow$index=="N",],
               aes(year, index.val, colour=bank)) +
    #geom_errorbar(data=bankpertow, aes(year, ymax=NPR+(NPR*NPR.cv), ymin=NPR-(NPR*NPR.cv), colour=bank), width=0) +
    geom_ribbon(data=bankpertow[bankpertow$sfa==sfa & bankpertow$index=="N",],
                aes(year, ymax=index.val+cv.val, ymin=index.val-cv.val, fill=bank), alpha=0.3)+
    theme_bw() +
    # facet_grid(factor(index, levels=c("N", "I"))~factor(size, levels=c("PR", "R", "FR")),
    #            scales="free_y")
    facet_wrap(~size2, ncol=1,
               scales="free_y",
               strip.position="top") +
    theme(strip.background=element_blank()) +
    scale_colour_manual(values=c("black", "darkorange", "blue"), name=man.unit) +
    scale_fill_manual(values=c("black", "darkorange", "blue"), name=man.unit) +
    #scale_y_log10() +
    xlab(en2fr("Year", translate = french, custom_terms=rosetta_terms)) +
    guides(colour = "none", fill="none") +
    ylab(parse(text=as.character(unique(bankpertow$index2[bankpertow$index=="N"]))))
  
  I <- ggplot() + geom_line(data=bankpertow[bankpertow$sfa==sfa & bankpertow$index=="I",],
                            aes(year, index.val, colour=bank)) +
    geom_point(data=bankpertow[bankpertow$sfa==sfa & bankpertow$index=="I",],
               aes(year, index.val, colour=bank)) +
    #geom_errorbar(data=bankpertow, aes(year, ymax=NPR+(NPR*NPR.cv), ymin=NPR-(NPR*NPR.cv), colour=bank), width=0) +
    geom_ribbon(data=bankpertow[bankpertow$sfa==sfa & bankpertow$index=="I",],
                aes(year, ymax=index.val+cv.val, ymin=index.val-cv.val, fill=bank), alpha=0.3)+
    theme_bw() +
    # facet_grid(factor(index, levels=c("N", "I"))~factor(size, levels=c("PR", "R", "FR")),
    #            scales="free_y")
    facet_wrap(~size2, ncol=1,
               scales="free_y",
               strip.position="top") +
    theme(strip.background=element_blank()) +
    scale_colour_manual(values=c("black", "darkorange", "blue"), name=man.unit) +
    scale_fill_manual(values=c("black", "darkorange", "blue"), name=man.unit) +
    #scale_y_log10() +
    xlab(en2fr("Year",translate = french, custom_terms=rosetta_terms)) +
    ylab(parse(text=as.character(unique(bankpertow$index2[bankpertow$index=="I"]))))
  
  require(patchwork)
  png(filename=paste0(plotsGo, "/timeseries_", sfa, "_", nickname, ".png"), width=12, height=8, units = "in", res=420)
  print(N+I + plot_layout(guides="collect") & theme(legend.position="right"))
  dev.off()
}


# condition

banks <- c("Sab", "Mid", "Ban", "BBn", "BBs", "Ger")



# prep data for TS plotting
cfts <- NULL

for(b in c("Mid", "Ban", "Sab", "BBn", "BBs")){
  df <- survey.obj[[b]]$model.dat %>%
    dplyr::select(year, CF) %>%
    dplyr::mutate(bank=b)
  df <- df %>%
    full_join(expand.grid(year=seq(min(df$year), max(df$year), 1), bank=b)) %>%
    dplyr::mutate(type="lined")
  cfts <- rbind(cfts, df)
}

# Ger
cfts <- cf.data$Ger$CFyrs %>%
  dplyr::select(year, CF, CF2) %>%
  dplyr::mutate(bank="Ger") %>%
  full_join(expand.grid(year=seq(min(cf.data$Ger$CFyrs$year), max(cf.data$Ger$CFyrs$year), 1), bank="Ger")) %>%
  dplyr::mutate(type=ifelse(year<2008, "unlined", "lined"))%>%
  dplyr::mutate(CF = ifelse(is.na(CF) & !is.na(CF2), CF2, CF))%>%
  dplyr::select(bank, year, CF, type) %>%
  full_join(cfts)

cfts$sfa[cfts$bank %in% c("Ban", "Mid", "Sab")] <- 25
cfts$sfa[cfts$bank %in% c("BBn", "BBs", "Ger")] <- 26

if(french==F) cflab <- expression(paste("Condition factor  ",bgroup("(",frac(g,dm^3)   ,")")))
if(french==T) cflab <- expression(paste("Coefficient de condition  ",bgroup("(",frac(g,dm^3)   ,")")))

png(filename=paste0(plotsGo, "/cfts_26", "_", nickname, ".png"), width=8, height=4, units = "in", res=420)
print(ggplot() + geom_point(data=cfts[cfts$sfa==26,], aes(year, CF, colour=bank)) +
        geom_line(data=cfts[cfts$sfa==26,], aes(year, CF, colour=bank, linetype=type)) +
        xlab(en2fr("Year", translate = french, custom_terms=rosetta_terms)) + 
        ylab(cflab) +
        theme_bw() +
        scale_linetype_discrete(name="", labels=en2fr(c("lined", "unlined"), translate = french, custom_terms=rosetta_terms)) +
        guides(linetype = guide_legend(override.aes = list(colour = "blue")))+ 
        scale_colour_manual(name=man.unit, values=c("black", "darkorange", "blue")) 
)
dev.off()

png(filename=paste0(plotsGo, "/cfts_25", "_", nickname, ".png"), width=8, height=4, units = "in", res=420)
print(ggplot() + geom_point(data=cfts[cfts$sfa==25,], aes(year, CF, colour=bank)) +
        geom_line(data=cfts[cfts$sfa==25,], aes(year, CF, colour=bank)) +
        xlab(en2fr("Year", translate = french, custom_terms=rosetta_terms)) + 
        ylab(cflab) +
        theme_bw() +
        scale_colour_manual(name=man.unit, values=c("black", "darkorange", "blue"))
)
dev.off()

```

```{r fishery-ts, echo=F, include=F}
fishery <- fish.dat %>% 
  filter(!is.na(bank)) %>%
  group_by(bank, year) %>%
  summarize(catch = sum(pro.repwt),
            effort=sum(hm))

fishery$sfa[fishery$bank %in% c("Sab", "Ban", "Mid")] <- 25
fishery$sfa[fishery$bank %in% c("BBn", "BBs", "Ger", "BB")] <- 26

ggplot() + geom_point(data=fishery[fishery$sfa==25 & !is.na(fishery$bank),], aes(year, catch, colour=bank)) +
  geom_line(data=fishery[fishery$sfa==25 & !is.na(fishery$bank),], aes(year, catch, colour=bank))

ggplot() + geom_point(data=fishery[fishery$sfa==26 & !is.na(fishery$bank),], aes(year, catch, colour=bank)) +
  geom_line(data=fishery[fishery$sfa==26 & !is.na(fishery$bank),], aes(year, catch, colour=bank))

table(fish.dat[fish.dat$bank=="BBn" & fish.dat$year==2020,]$surv.year) 

```