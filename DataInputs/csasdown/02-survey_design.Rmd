---
output: 
  pdf_document:
    fig_caption: yes
    extra_dependencies: ["float"]
linkcolor: blue
params:
  bank: NA
  banknum: NA
  surv.year: NA
header-includes:
 - \usepackage{float}
editor_options: 
  chunk_output_type: console
---

```{r, include=F, echo=F}
# knitr::opts_knit$set(eval.after = "fig.cap")
# knitr::opts_chunk$set(fig.pos = 'H')
# options(knitr.kable.NA = '')
require(tidyverse)
options(tinytex.verbose = TRUE)

direct_fns <- "C:/Users/keyserf/Documents/Github/Assessment_fns/"

year <- 2022

load("data/summary4.Rdata")
source(paste0(direct_fns, "/Other_functions/ScallopRound.R"))

ntows <- summary_data$ntows
highlights <- summary_data$highlights
sizes <- summary_data$sizes
dates <- summary_data$dates
yeartable <- summary_data$yeartable
spatial.sum.stats <- summary_data$spatial.sum.stats

bank <- data.frame(lab = c("Ban", "BanIce", "Mid", "Sab", "Ger", "BBn", "BBs", "GB", "GBa", "GBb"), name=NA)
bank$name[bank$lab=="Ban"] <- "Banquereau (Sea scallop)"
bank$name[bank$lab=="BanIce"] <- "Banquereau (Icelandic scallop)"
bank$name[bank$lab=="Mid"] <- "Middle Bank"
bank$name[bank$lab=="Sab"] <- "Sable Bank"
bank$name[bank$lab=="Ger"] <- "German Bank"
bank$name[bank$lab=="BBn"] <- "Browns Bank North"
bank$name[bank$lab=="BBs"] <- "Browns Bank South"
bank$name[bank$lab=="GB"] <- "Georges Bank (monitoring stations)"
bank$name[bank$lab=="GBa"] <- "Georges Bank 'a'"
bank$name[bank$lab=="GBb"] <- "Georges Bank 'b'"

# bankname <- bank$name[bank$lab==params$bank]
# bank$towtype1[bank$lab %in% c("Ban", "BanIce", "GB", "Mid")] <- "fixed"
# bank$towtype1[bank$lab %in% c("BBn", "BBs", "GBa", "GBb", "Sab")] <- "stratified random"
# bank$towtype1[bank$lab=="Ger"] <- "random"

# if(length(ntows$Freq[ntows$bank==params$bank])==2 & !params$bank %in% c("Ger", "GB")) surv.description <- paste0(ntows$Freq[ntows$bank==params$bank & ntows$Var1==1], " ", bank$towtype1[bank$lab==params$bank],  " stations, and ", ntows$Freq[ntows$bank==params$bank & !ntows$Var1==1], " ", "exploratory stations.")
# if(length(ntows$Freq[ntows$bank==params$bank])==1 & !params$bank == "Ger") surv.description <- paste0(ntows$Freq[ntows$bank==params$bank & ntows$Var1==1], " ", bank$towtype1[bank$lab==params$bank],  " stations.")
# if(length(ntows$Freq[ntows$bank==params$bank])==2 & params$bank == "Ger") surv.description <- paste0(ntows$Freq[ntows$bank==params$bank & ntows$Var1==1], " ", bank$towtype1[bank$lab==params$bank],  " stations within the survey domain, and ", ntows$Freq[ntows$bank==params$bank & ntows$Var1==3], " ", "stations repeated from the previous survey.")
# if(length(ntows$Freq[ntows$bank==params$bank])>2 & params$bank == "Ger") surv.description <- paste0(ntows$Freq[ntows$bank==params$bank & ntows$Var1==1], " ", bank$towtype1[bank$lab==params$bank],  " stations within the survey domain, ", ntows$Freq[ntows$bank==params$bank & ntows$Var1==3], " ", "stations repeated from the previous survey, and ", ntows$Freq[ntows$bank==params$bank & !ntows$Var1 %in% c(1, 3)], " exploratory stations.")
# if(length(ntows$Freq[ntows$bank==params$bank])==2 & params$bank =="GB") surv.description <- paste0(ntows$Freq[ntows$bank==params$bank & ntows$Var1==3], " ", bank$towtype1[bank$lab==params$bank],  " stations, and ", ntows$Freq[ntows$bank==params$bank & !ntows$Var1==3], " ", "exploratory stations.")
# if(length(ntows$Freq[ntows$bank==params$bank])==1 & params$bank =="GB") surv.description <- paste0(ntows$Freq[ntows$bank==params$bank & ntows$Var1==3], " ", bank$towtype1[bank$lab==params$bank],  " stations.")
# 
# 
# if(params$bank=="Ger") {
#   bank$towtype1[bank$lab==params$bank] <- "sampling with partial replacement"
#   ltm_ts <- "The horizontal dashed lines are the long term medians."
# }
# 
# if(!params$bank=="Ger") {
#   ltm_ts <- "The dashed line is the long term median."
# }
# 
# maxbin <- strsplit(highlights$word[highlights$variable=="maxbin" & highlights$bank==params$bank], "(", fixed=T)[[1]][1]
# 
# mwshltm <- strsplit(highlights$nearLTM[highlights$variable=="CF" & highlights$bank==params$bank], " (", fixed=T)[[1]][1]
# 
# tabnum <- 5*(params$banknum-1) + 1:5
# fignum <- 12*(params$banknum-1) + 1:12
# 
# table <- highlights[#highlights$bank==params$bank &
#   highlights$variable %in% c("NPR", "NR", "N", "IPR", "IR", "I"), ]
# 
# table$word[as.numeric(table$thisyearraw) < as.numeric(table$lastyearraw)] <- "decreased"
# table$word[as.numeric(table$thisyearraw) > as.numeric(table$lastyearraw)] <- "increased"
# 
# table$perc[table$word=="increased"] <-
#   (as.numeric(table$thisyearraw[table$word=="increased"]) - as.numeric(table$lastyearraw[table$word=="increased"]))/
#   as.numeric(table$lastyearraw[table$word=="increased"]) *100
# 
# table$perc[table$word=="decreased"] <-
#   (as.numeric(table$lastyearraw[table$word=="decreased"]) - as.numeric(table$thisyearraw[table$word=="decreased"]))/
#   as.numeric(table$lastyearraw[table$word=="decreased"]) *100
# 
# table$perclab <- ScallopRound(table$perc, 2)
# 
# table$perclab[table$perc>0 & table$perc < 0.01] <- "<0.01"
# #table$perclab[table$perc>99] <- ">99"
# 
# table$state <- paste0(table$word, " by ", table$perclab, "% since")
# 
# table$state[is.na(table$perc)] <- "was similar to"
# 
# highlights$lastyear[highlights$variable %in% c("N", "NR", "NPR", "I", "IR", "IPR", "Nclap", "NRclap", "NPRclap", "PRpercentclap", "Rpercentclap", "Cpercentclap") & !is.na(highlights$lastyearraw) & (highlights$lastyearraw>0 & highlights$lastyearraw<0.01)] <- "<0.01"
# highlights$thisyear[highlights$variable %in% c("N", "NR", "NPR", "I", "IR", "IPR", "Nclap", "NRclap", "NPRclap", "PRpercentclap", "Rpercentclap", "Cpercentclap") & !is.na(highlights$thisyearraw) & (highlights$thisyearraw>0 & highlights$thisyearraw<0.01)] <- "<0.01"
# highlights$LTM[highlights$variable %in% c("N", "NR", "NPR", "I", "IR", "IPR", "Nclap", "NRclap", "NPRclap", "PRpercentclap", "Rpercentclap", "Cpercentclap") & !is.na(highlights$LTMraw) & (highlights$LTMraw>0 & highlights$LTMraw<0.01)] <- "<0.01"
# 
# highlights$word[highlights$variable=="CF" & highlights$bank==params$bank & highlights$word=="was similar"] <- "was similar to"
# highlights$word[highlights$variable=="CF" & highlights$bank==params$bank & highlights$word=="increased"] <- "increased since"
# highlights$word[highlights$variable=="CF" & highlights$bank==params$bank & highlights$word=="decreased"] <- "decreased since"
# 
# if(grepl(pattern = "increase", x = highlights$word[highlights$variable=="CF" & highlights$bank==params$bank])==T) cf_statement <-
#   paste0("increased from ", highlights$lastyear[highlights$variable=="CF" & highlights$bank==params$bank], " in the previous survey (", yeartable$lastyear[yeartable$bank == params$bank], "), to ", highlights$thisyear[highlights$variable=="CF" & highlights$bank==params$bank], " in ", year)
# 
# if(grepl(pattern = "decrease", x = highlights$word[highlights$variable=="CF" & highlights$bank==params$bank])==T) cf_statement <-
#   paste0("decreased from ", highlights$lastyear[highlights$variable=="CF" & highlights$bank==params$bank], " in the previous survey (", yeartable$lastyear[yeartable$bank == params$bank], "), to ", highlights$thisyear[highlights$variable=="CF" & highlights$bank==params$bank], " in ", year)
# 
# if(grepl(pattern = "similar", x = highlights$word[highlights$variable=="CF" & highlights$bank==params$bank])==T) cf_statement <-
#   paste0("was similar to the previous survey (",  highlights$lastyear[highlights$variable=="CF" & highlights$bank==params$bank], " in ", yeartable$lastyear[yeartable$bank == params$bank], "), at ", highlights$thisyear[highlights$variable=="CF" & highlights$bank==params$bank], " in ", year)

```

# Survey

The Offshore Scallop Survey Database (SCALOFF) contains data collected through Collaborative Agreements (formerly Joint Project Agreements) between DFO Science and the Seafood Producers Association of Nova Scotia (SPANS). The Offshore Scallop Survey collects data on the stocks of Sea Scallop (*Placopecten magellanicus*) on the Scotian Shelf and the Canadian side of Georges Bank, as well as Iceland Scallop (*Chlamys islandica*) on Banquereau Bank. These stocks correspond to the DFO management units known as Scallop Fishing Areas (SFA) 25, 26, and 27, and the survey data are the primary source of fishery-independent information used in the Maritimes Region scallop stock assessments. Under the Collaborative Agreement, survey responsibilities are shared by DFO and SPANS. At-sea survey activities are directed by the DFO Chief Scientist aboard the survey vessel. SPANS coordinates the provision the survey vessel as well as the necessary crew complement to conduct the survey activities. DFO Science designs the survey, provides and manages scientific equipment, and validates, archives, and analyzes survey data. 

## Survey history  

The Offshore Scallop Survey has occurred between May and September annually since 1978 with few exceptions, but spatial coverage and survey designs have changed over time (see Survey Design).  

## Sampling protocols  

Regardless of survey design, the same sampling protocol is followed: At each survey station, the 8-ft scallop dredge lined with 38 mm mesh is towed for 10 minutes, and every scallop is counted and assigned to a 5 mm shell height bin (ranging from 0-200 mm). Detailed sampling occurs at a selection of the stations, where the exact shell heights and meat weights are measured for a sub-sample of the scallops caught. Bottom temperature data has also been collected on the Offshore Scallop survey since 2011.  

## Survey design  


```{r, echo=F, message=F, out.height="55.778%", out.width="100%", fig.cap=paste0("Example survey design for ", params$bankname, ".")}
knitr::include_graphics(paste0("Y:/Offshore/Assessment/", params$surv.year, "/Presentations/Survey_summary/", params$bank, "/survey_strata.png"))
```




