---
output: 
  pdf_document:
    fig_caption: yes
    extra_dependencies: ["float"]
linkcolor: blue
params:
  bank: NA
  banknum: NA
header-includes:
 - \usepackage{float}
editor_options: 
  chunk_output_type: console
---

```{r, include=F, echo=F}
# knitr::opts_knit$set(eval.after = "fig.cap")
# knitr::opts_chunk$set(fig.pos = 'H')
# options(knitr.kable.NA = '')
require(tidyverse)
options(tinytex.verbose = TRUE)

direct_fns <- "C:/Users/keyserf/Documents/Github/Assessment_fns/"

year <- 2022

load("summary4.Rdata")
source(paste0(direct_fns, "/Other_functions/ScallopRound.R"))

ntows <- summary_data$ntows
highlights <- summary_data$highlights
sizes <- summary_data$sizes
dates <- summary_data$dates
yeartable <- summary_data$yeartable
spatial.sum.stats <- summary_data$spatial.sum.stats

bank <- data.frame(lab = c("Ban", "BanIce", "Mid", "Sab", "Ger", "BBn", "BBs", "GB", "GBa", "GBb"), name=NA)
bank$name[bank$lab=="Ban"] <- "Banquereau (Sea scallop)"
bank$name[bank$lab=="BanIce"] <- "Banquereau (Icelandic scallop)"
bank$name[bank$lab=="Mid"] <- "Middle Bank"
bank$name[bank$lab=="Sab"] <- "Sable Bank"
bank$name[bank$lab=="Ger"] <- "German Bank"
bank$name[bank$lab=="BBn"] <- "Browns Bank North"
bank$name[bank$lab=="BBs"] <- "Browns Bank South"
bank$name[bank$lab=="GB"] <- "Georges Bank (monitoring stations)"
bank$name[bank$lab=="GBa"] <- "Georges Bank 'a'"
bank$name[bank$lab=="GBb"] <- "Georges Bank 'b'"

# bankname <- bank$name[bank$lab==params$bank]
# bank$towtype1[bank$lab %in% c("Ban", "BanIce", "GB", "Mid")] <- "fixed"
# bank$towtype1[bank$lab %in% c("BBn", "BBs", "GBa", "GBb", "Sab")] <- "stratified random"
# bank$towtype1[bank$lab=="Ger"] <- "random"

# if(length(ntows$Freq[ntows$bank==params$bank])==2 & !params$bank %in% c("Ger", "GB")) surv.description <- paste0(ntows$Freq[ntows$bank==params$bank & ntows$Var1==1], " ", bank$towtype1[bank$lab==params$bank],  " stations, and ", ntows$Freq[ntows$bank==params$bank & !ntows$Var1==1], " ", "exploratory stations.")
# if(length(ntows$Freq[ntows$bank==params$bank])==1 & !params$bank == "Ger") surv.description <- paste0(ntows$Freq[ntows$bank==params$bank & ntows$Var1==1], " ", bank$towtype1[bank$lab==params$bank],  " stations.")
# if(length(ntows$Freq[ntows$bank==params$bank])==2 & params$bank == "Ger") surv.description <- paste0(ntows$Freq[ntows$bank==params$bank & ntows$Var1==1], " ", bank$towtype1[bank$lab==params$bank],  " stations within the survey domain, and ", ntows$Freq[ntows$bank==params$bank & ntows$Var1==3], " ", "stations repeated from the previous survey.")
# if(length(ntows$Freq[ntows$bank==params$bank])>2 & params$bank == "Ger") surv.description <- paste0(ntows$Freq[ntows$bank==params$bank & ntows$Var1==1], " ", bank$towtype1[bank$lab==params$bank],  " stations within the survey domain, ", ntows$Freq[ntows$bank==params$bank & ntows$Var1==3], " ", "stations repeated from the previous survey, and ", ntows$Freq[ntows$bank==params$bank & !ntows$Var1 %in% c(1, 3)], " exploratory stations.")
# if(length(ntows$Freq[ntows$bank==params$bank])==2 & params$bank =="GB") surv.description <- paste0(ntows$Freq[ntows$bank==params$bank & ntows$Var1==3], " ", bank$towtype1[bank$lab==params$bank],  " stations, and ", ntows$Freq[ntows$bank==params$bank & !ntows$Var1==3], " ", "exploratory stations.")
# if(length(ntows$Freq[ntows$bank==params$bank])==1 & params$bank =="GB") surv.description <- paste0(ntows$Freq[ntows$bank==params$bank & ntows$Var1==3], " ", bank$towtype1[bank$lab==params$bank],  " stations.")
# 
# 
# if(params$bank=="Ger") {
#   bank$towtype1[bank$lab==params$bank] <- "sampling with partial replacement"
#   ltm_ts <- "The horizontal dashed lines are the long term medians."
# }
# 
# if(!params$bank=="Ger") {
#   ltm_ts <- "The dashed line is the long term median."
# }
# 
# maxbin <- strsplit(highlights$word[highlights$variable=="maxbin" & highlights$bank==params$bank], "(", fixed=T)[[1]][1]
# 
# mwshltm <- strsplit(highlights$nearLTM[highlights$variable=="CF" & highlights$bank==params$bank], " (", fixed=T)[[1]][1]
# 
# tabnum <- 5*(params$banknum-1) + 1:5
# fignum <- 12*(params$banknum-1) + 1:12
# 
# table <- highlights[#highlights$bank==params$bank &
#   highlights$variable %in% c("NPR", "NR", "N", "IPR", "IR", "I"), ]
# 
# table$word[as.numeric(table$thisyearraw) < as.numeric(table$lastyearraw)] <- "decreased"
# table$word[as.numeric(table$thisyearraw) > as.numeric(table$lastyearraw)] <- "increased"
# 
# table$perc[table$word=="increased"] <-
#   (as.numeric(table$thisyearraw[table$word=="increased"]) - as.numeric(table$lastyearraw[table$word=="increased"]))/
#   as.numeric(table$lastyearraw[table$word=="increased"]) *100
# 
# table$perc[table$word=="decreased"] <-
#   (as.numeric(table$lastyearraw[table$word=="decreased"]) - as.numeric(table$thisyearraw[table$word=="decreased"]))/
#   as.numeric(table$lastyearraw[table$word=="decreased"]) *100
# 
# table$perclab <- ScallopRound(table$perc, 2)
# 
# table$perclab[table$perc>0 & table$perc < 0.01] <- "<0.01"
# #table$perclab[table$perc>99] <- ">99"
# 
# table$state <- paste0(table$word, " by ", table$perclab, "% since")
# 
# table$state[is.na(table$perc)] <- "was similar to"
# 
# highlights$lastyear[highlights$variable %in% c("N", "NR", "NPR", "I", "IR", "IPR", "Nclap", "NRclap", "NPRclap", "PRpercentclap", "Rpercentclap", "Cpercentclap") & !is.na(highlights$lastyearraw) & (highlights$lastyearraw>0 & highlights$lastyearraw<0.01)] <- "<0.01"
# highlights$thisyear[highlights$variable %in% c("N", "NR", "NPR", "I", "IR", "IPR", "Nclap", "NRclap", "NPRclap", "PRpercentclap", "Rpercentclap", "Cpercentclap") & !is.na(highlights$thisyearraw) & (highlights$thisyearraw>0 & highlights$thisyearraw<0.01)] <- "<0.01"
# highlights$LTM[highlights$variable %in% c("N", "NR", "NPR", "I", "IR", "IPR", "Nclap", "NRclap", "NPRclap", "PRpercentclap", "Rpercentclap", "Cpercentclap") & !is.na(highlights$LTMraw) & (highlights$LTMraw>0 & highlights$LTMraw<0.01)] <- "<0.01"
# 
# highlights$word[highlights$variable=="CF" & highlights$bank==params$bank & highlights$word=="was similar"] <- "was similar to"
# highlights$word[highlights$variable=="CF" & highlights$bank==params$bank & highlights$word=="increased"] <- "increased since"
# highlights$word[highlights$variable=="CF" & highlights$bank==params$bank & highlights$word=="decreased"] <- "decreased since"
# 
# if(grepl(pattern = "increase", x = highlights$word[highlights$variable=="CF" & highlights$bank==params$bank])==T) cf_statement <-
#   paste0("increased from ", highlights$lastyear[highlights$variable=="CF" & highlights$bank==params$bank], " in the previous survey (", yeartable$lastyear[yeartable$bank == params$bank], "), to ", highlights$thisyear[highlights$variable=="CF" & highlights$bank==params$bank], " in ", year)
# 
# if(grepl(pattern = "decrease", x = highlights$word[highlights$variable=="CF" & highlights$bank==params$bank])==T) cf_statement <-
#   paste0("decreased from ", highlights$lastyear[highlights$variable=="CF" & highlights$bank==params$bank], " in the previous survey (", yeartable$lastyear[yeartable$bank == params$bank], "), to ", highlights$thisyear[highlights$variable=="CF" & highlights$bank==params$bank], " in ", year)
# 
# if(grepl(pattern = "similar", x = highlights$word[highlights$variable=="CF" & highlights$bank==params$bank])==T) cf_statement <-
#   paste0("was similar to the previous survey (",  highlights$lastyear[highlights$variable=="CF" & highlights$bank==params$bank], " in ", yeartable$lastyear[yeartable$bank == params$bank], "), at ", highlights$thisyear[highlights$variable=="CF" & highlights$bank==params$bank], " in ", year)

```



```{r, echo=F, message=F, out.height="55.778%", out.width="100%", fig.cap=paste0("Example survey design for ", params$bankname, ".")}
knitr::include_graphics(paste0("Y:/Offshore/Assessment/", params$surv.year, "/Presentations/Survey_summary/test_figures/", params$bank, "/survey_strata.png"))
```


```{r, echo=FALSE, message=F, fig.align="center", fig.cap="Abundance (top) time series represented by number of scallop per standardized tow (y-axis) and biomass (bottom) time series represented by grams of scallop per standardized tow (y-axis) for SFA 25 management units."}
knitr::include_graphics("timeseries_25_FR.png")
```


```{r, echo=FALSE, message=F, fig.align="center", fig.cap="Abundance (top) time series represented by number of scallop per standardized tow (y-axis) and biomass (bottom) time series represented by grams of scallop per standardized tow (y-axis) for SFA 26 management units."}
knitr::include_graphics("timeseries_26_FR.png")
```


```{r, echo=FALSE, message=F, fig.align="center", fig.cap="Condition ($g/dm^3$) time series for SFA 25 management units."}
knitr::include_graphics("cfts_25.png")
```


```{r, echo=FALSE, message=F, fig.align="center", fig.cap="Condition ($g/dm^3$) time series for SFA 26 management units."}
knitr::include_graphics("cfts_26.png")
```


<!-- ```{r, echo=FALSE, message=F, out.height="85%", out.width="85%", fig.align="center", fig.cap=paste0("Shell height frequencies of scallop on ", bankname, " in ", year, ". Vertical lines are the recruit size limits.")} -->
<!-- knitr::include_graphics(paste0("Y:/Offshore/Assessment/", year, "/Presentations/Survey_summary/test_figures/", params$bank, "/SHF.png")) -->
<!-- ``` -->


<!-- ```{r, echo=FALSE, message=F, out.height="70%", out.width="70%", fig.align="center", fig.cap=paste0("Meat weights and shell heights for sampled tows on ", bankname, " in ", year, " (top). Red points represent individual scallops, red lines represent the trend for each sampled tow, and the blue line is the overall trend for the current survey. Condition factor (bottom) is measured as grams of meat per decimeter cubed, which can be thought of as the meat weight of a scallop with a shell height of 100mm.")} -->
<!-- knitr::include_graphics(paste0("Y:/Offshore/Assessment/", year, "/Presentations/Survey_summary/test_figures/", params$bank, "/MWSH_and_CF_ts.png")) -->
<!-- ``` -->


<!-- ```{r, echo=FALSE, message=F, out.height="90%", out.width="90%", fig.align="center", fig.cap=paste0("Clapper time series for ", bankname, " in ", year, ", represented by percentage of clappers per tow (y-axis). Pre-recruits are shown in the top panel, recruit-sized scallop in the middle panel, and fully-recruited scallop are in the bottom panel. ", ltm_ts)} -->
<!-- knitr::include_graphics(paste0("Y:/Offshore/Assessment/", year, "/Presentations/Survey_summary/test_figures/", params$bank, "/Clapper_per_ts.png")) -->
<!-- ``` -->



