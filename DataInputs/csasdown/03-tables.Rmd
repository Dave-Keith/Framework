---
output:
  word_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---
\clearpage

# Tables {-}

```{r include=F, echo=F}
require(tidyverse)
require(csasdown)
require(kableExtra)
#require(officedown)
require(officer)
# require(flextable)
require(dplyr)
strata <- readxl::read_excel("Y:/Offshore/Assessment/Framework/SFA_25_26_2024/DataInputs/survey_design.xlsx")
strata$`Area (km^2)` <- round(x=as.numeric(strata$`Area (km^2)`), digits=2)
strata <- strata[c(1:17, 25:29),] # to exclude GBa
names(strata)[which(names(strata)=="Area (km^2)")] <- "Area (km^2^)"
strata$`Management Unit`[strata$`Management Unit`=="Sab"] <- "25A-Sab"
strata$`Management Unit`[strata$`Management Unit`=="Mid"] <- "25A-Mid"
strata$`Management Unit`[strata$`Management Unit`=="Ban"] <- "25B-Ban"
strata$`Management Unit`[strata$`Management Unit`=="BBn"] <- "26A-BBn"
strata$`Management Unit`[strata$`Management Unit`=="BBs"] <- "26B-BBs"
strata$`Management Unit`[strata$`Management Unit`=="Ger"] <- "26C-Ger"
strata$`Management Unit`[strata$`Management Unit`=="GBb"] <- "27B-GBb"
strata$`Area (km^2^)`[is.na(strata$`Area (km^2^)`)] <- "NA"


# strata <- kableExtra::kbl(strata, align = "l", valign = "t") %>%
#   kableExtra::collapse_rows(columns = 1:4, valign = "top")

ps_tab <- read.csv("Y:/Offshore/Assessment/Framework/SFA_25_26_2024/DataInputs/Port_sampling/ps_tab.csv")
ps_tab <- dplyr::select(ps_tab, -X, -main)
names(ps_tab) <- c("SFA", "Management unit", "Number of samples", "Number of years with PS data", "Most recent year with PS data", "Number of months with PS data", "Long term median (mw)", "Standard deviation (mw)", "Minimum (mw)", "Maximum (mw)")
ps_tab$`Management unit`[ps_tab$`Management unit`=="Sab"] <- "25A-Sab"
ps_tab$`Management unit`[ps_tab$`Management unit`=="Mid"] <- "25A-Mid"
ps_tab$`Management unit`[ps_tab$`Management unit`=="Ban"] <- "25B-Ban"
ps_tab$`Management unit`[ps_tab$`Management unit`=="BBn"] <- "26A-BBn"
ps_tab$`Management unit`[ps_tab$`Management unit`=="BBs"] <- "26B-BBs"
ps_tab$`Management unit`[ps_tab$`Management unit`=="Ger"] <- "26C-Ger"
ps_tab$`Management unit`[ps_tab$`Management unit`=="GBb"] <- "27B-GBb"


mwsh_bbn <- read.csv("Y:/Offshore/Assessment/Framework/SFA_25_26_2024/DataInputs/MWSH/BBn/AICtable.csv")
mwsh_sab <- read.csv("Y:/Offshore/Assessment/Framework/SFA_25_26_2024/DataInputs/MWSH/Sab/AICtable.csv")
mwsh_bbn$`Management Unit` <- "Browns Bank North"
mwsh_sab$`Management Unit` <- "Sable Bank"
mwsh <- rbind(mwsh_sab, mwsh_bbn)
mwsh <- dplyr::select(mwsh, -X)
mwsh <- data.frame(mwsh$`Management Unit`, mwsh[,1:(ncol(mwsh)-1)])
names(mwsh) <- c("Management Unit", "dAIC", "df", "Model", "Formula")
mwsh <- unique(dplyr::select(mwsh, `Management Unit`, Model, Formula, df, dAIC))
mwsh$`Management Unit`[mwsh$`Management Unit`=="Sable Bank"] <- c("Sable Bank", rep(NA, (length(unique(mwsh$Model))-1)))
mwsh$`Management Unit`[mwsh$`Management Unit`=="Browns Bank North" & !is.na(mwsh$`Management Unit`)] <- c("Browns Bank North", rep(NA, (length(unique(mwsh$Model))-1)))
mwsh$dAIC <- round(mwsh$dAIC,0)
mwsh <- dplyr::select(mwsh, -Model)
mwsh$`Management Unit`[mwsh$`Management Unit`=="Sable Bank"] <- "25A-Sab"
mwsh$`Management Unit`[mwsh$`Management Unit`=="Browns Bank North"] <- "26A-BBn"


ageing_bbn <- read.csv("Y:/Offshore/Assessment/Framework/SFA_25_26_2024/DataInputs/Ageing/BBn/summary_stats.csv")
ageing_sab <- read.csv("Y:/Offshore/Assessment/Framework/SFA_25_26_2024/DataInputs/Ageing/Sab/summary_stats.csv")
ageing_bbn$`Management Unit` <- "26A-BBn"
ageing_sab$`Management Unit` <- "25A-Sab"
ageing <- rbind(ageing_sab, ageing_bbn)
ageing <- dplyr::select(ageing, -X)
ageing <- data.frame(ageing$`Management Unit`, ageing[,1:(ncol(ageing)-1)])
names(ageing)[1:2] <- c("Management Unit", "Model")
ageing1 <- unique(dplyr::select(ageing, Model, Formula))
ageing2 <- dplyr::select(ageing, -Formula)
ageing2$AIC <- round(ageing2$AIC, 0)
ageing2$r.sq <- round(ageing2$r.sq, 3)
ageing2$scale.est <- round(ageing2$scale.est, 2)
ageing2[,c("H10", "H5", "H2", "K_maxR", "K_avgFR", "K_2_to_5")] <- round(ageing2[,c("H10", "H5", "H2", "K_maxR", "K_avgFR", "K_2_to_5")], 1)
ageing2$`Management Unit`[ageing2$`Management Unit`=="25A-Sab"] <- c("25A-Sab", NA, NA)
ageing2$`Management Unit`[ageing2$`Management Unit`=="26A-BBn" & !is.na(ageing2$`Management Unit`)] <- c("26A-BBn", NA, NA)
ageing3 <- ageing2[,c(1:2,9:7)]
ageing4 <- ageing2[,c(1:2,10:15)]
ageing2 <- ageing2[,c(1:6)]

inc_bbn <- read.csv("Y:/Offshore/Assessment/Framework/SFA_25_26_2024/DataInputs/Ageing/increments_bbn.csv")
sum_bbn <- read.csv("Y:/Offshore/Assessment/Framework/SFA_25_26_2024/DataInputs/Ageing/age_summary_bbn.csv")
inc_sab <- read.csv("Y:/Offshore/Assessment/Framework/SFA_25_26_2024/DataInputs/Ageing/increments_sab.csv")
sum_sab <- read.csv("Y:/Offshore/Assessment/Framework/SFA_25_26_2024/DataInputs/Ageing/age_summary_sab.csv")

inc <- full_join(inc_bbn, inc_sab)
inc$height <- paste0(inc$med_height, " (", round(inc$sd_height,2), ")")
inc <- pivot_wider(dplyr::select(inc, -X), id_cols=AGE, names_from = bank, values_from=c(n_inc, height))
inc <- inc[,c("AGE", "n_inc_Sab", "height_Sab", "n_inc_BBn", "height_BBn")]
names(inc) <- c("Age assigned", "Number of increments (25A-Sab)", "Median height (25A-Sab, SD)",  "Number of increments (26A-BBn)", "Median height (26A-BBn, SD)")

age_summary <- full_join(sum_sab, sum_bbn)
age_summary <- dplyr::select(age_summary, bank, year, tows, shells, increments, -X, -ager)
age_summary$bank[age_summary$bank=="Sab"] <- "25A-Sab"
age_summary$bank[age_summary$bank=="BBn"] <- "26A-BBn"
names(age_summary) <- c("Management unit", "Year", "Number of tows", "Number of shells", "Number of increments")


tab_sts <- read.csv("Y:/Offshore/Assessment/Framework/SFA_25_26_2024/DataInputs/surveyIndices.csv")
tab_sts <- tab_sts %>% mutate(across(c("NPR", "NR", "NFR", "IPR", "IR", "IFR", "clapsPre", "clapsRec", "clapsCom", "CF"), round, 2)) %>%
  select(-X) %>%
rename(Subarea = subarea,
       Gear = liner,
       `N per tow (PR)` = NPR,
       `N per tow (R)` = NR,
       `N per tow (FR)` = NFR,
       `kg per tow (PR)` = IPR,
       `kg per tow (R)` = IR,
       `kg per tow (FR)` = IFR,
       `% Clap per tow (PR)` = clapsPre,
       `% Clap per tow (R)` = clapsRec,
       `% Clap per tow (FR)` = clapsCom,
       `Condition (100 mm SH)` = CF) %>%
# rename(A = subarea,
#        B = liner,
#        C = NPR,
#        D = NR,
#        E = NFR,
#        F = IPR,
#        G = IR,
#        H= IFR,
#        I = clapsPre,
#        J = clapsRec,
#        K = clapsCom,
#        L = CF) %>%
  as_tibble()

opts <- options(knitr.kable.NA = "")

```


```{r ps-tab, echo=F, message=F}
#<!---BLOCK_LANDSCAPE_START--->
# block_section(
#   prop_section(
#     page_size = page_size(orient = "landscape"),
#     type="continuous"
#   )
# )

csas_table(ps_tab, caption ="Summary of port sampling data for SFAs 25, 26, and 27B from 2006—2022, describing sampling distribution and meat weights (mw) in grams (g).") %>% 
  kableExtra::row_spec(0,bold=TRUE) %>% 
  kableExtra::row_spec(0,bold=ifelse(ps_tab$`Management unit`%in% c("26A-BBn", "25A-Sab"), TRUE, FALSE))

#qflextable(strata)

#<!---BLOCK_LANDSCAPE_START--->
```

```{r strata-tab, echo=F, message=F}
#<!---BLOCK_LANDSCAPE_START--->
# block_section(
#   prop_section(
#     page_size = page_size(orient = "landscape"),
#     type="continuous"
#   )
# )

csas_table(strata, caption ="Current survey design and allocation information for SFAs 25, 26, and 27B. Stratum areas are provided in square kilometres (km^2^), and Universal Transverse Mercator Zones area in the northern hemisphere. Catch rates used for stratification are reported in kilograms per hour-metre (kg/hm). Some columns are not applicable (NA) for certain management units.") %>% kableExtra::row_spec(0,bold=TRUE)
#qflextable(strata)

#<!---BLOCK_LANDSCAPE_START--->
```

```{r mwsh-tab, echo=F, message=F}
#<!---BLOCK_LANDSCAPE_START--->
# block_section(
#   prop_section(
#     page_size = page_size(orient = "landscape"),
#     type="continuous"
#   )
# )

csas_table(mwsh, caption ="Meat weight-shell height model specifications for SFA 25A Sable Bank and SFA 26A Browns Bank North. The response variable in all models was wet meat weight (wmw). Explanatory variables tested include shell height (log-transformed and centred; log.sh.cen), year, and depth (centred; depth.cen). Comparisons were based on degrees of freedom (df) and the difference in Akaike’s Information Criterion (dAIC).") %>% 
  kableExtra::row_spec(0,bold=TRUE)

#qflextable(strata)

#<!---BLOCK_LANDSCAPE_START--->
```


```{r echo=F, message=F, eval=F}
### IGNORE THIS CHUNK. FOR PRESENTATION ONLY
#<!---BLOCK_LANDSCAPE_START--->
# block_section(
#   prop_section(
#     page_size = page_size(orient = "landscape"),
#     type="continuous"
#   )
# )

# csas_table(ageing1, caption ="Growth model specification.") %>% kableExtra::row_spec(0,bold=TRUE)
# #qflextable(strata)
# 
# csas_table(ageing2, caption ="Growth model evaluation.") %>% kableExtra::row_spec(0,bold=TRUE)
# 
# csas_table(ageing3, caption ="Shell heights at age 2, 5, and 10 for aged scallops, from three models.") %>% kableExtra::row_spec(0,bold=TRUE)
# 
# csas_table(ageing4, caption ="Comparative growth metrics for aged scallops, from three models. A_avgFR is the age of an average fully-recruited scallop, A_maxR is the age of a scallop at maximum recruit size, and A_minR is the age of a scallop at the minimum recruit size. K values represent growth (in mm) in the year prior to reaching average fully-recruited shell height (K_avgFR) and maximum recruit size (K_maxR), and from ages 2 to 5 (K_2-5).") %>% kableExtra::row_spec(0,bold=TRUE)

#<!---BLOCK_LANDSCAPE_START--->
```

```{r age-summary, echo=F, message=F}
#<!---BLOCK_LANDSCAPE_START--->
# block_section(
#   prop_section(
#     page_size = page_size(orient = "landscape"),
#     type="continuous"
#   )
# )

csas_table(age_summary, caption ="Tow, shell, and increment counts associated with age analysis for SFA 25A Sable Bank and SFA 26A Browns Bank North.") %>% kableExtra::row_spec(0,bold=TRUE)

#qflextable(strata)

#<!---BLOCK_LANDSCAPE_START--->
```

```{r age-inc, echo=F, message=F}
#<!---BLOCK_LANDSCAPE_START--->
# block_section(
#   prop_section(
#     page_size = page_size(orient = "landscape"),
#     type="continuous"
#   )
# )
csas_table(inc, caption ="Summary of age assignments and measurements for SFA 25A Sable Bank and SFA 26A Browns Bank North. Median increment height is measured in millimetres (mm). Standard deviation (SD) in increment height is provided in parentheses.") %>% kableExtra::row_spec(0,bold=TRUE)

#qflextable(strata)

#<!---BLOCK_LANDSCAPE_START--->
```

```{r tab-sts, echo=F, message=F}
#<!---BLOCK_LANDSCAPE_START--->
# block_section(
#   prop_section(
#     page_size = page_size(orient = "landscape"),
#     type="continuous"
#   )
# )
csas_table(tab_sts, caption ="Long term medians (up to and including 2022 data, except for SFA 26C unlined gear) for survey indices by SFA subarea (management unit). Abundance is represented by number (N) of scallops per tow, biomass is represented by kilograms (kg) of scallop per tow, natural mortality is represented by the percentage (%) of clappers out of the total number of scallops and clappers per tow, and condition is the weight in grams (g) predicted for a 100 millimetre (mm) shell height. Indices are categorized by size class: pre-recruit (PR), recruit (R), and fully-recruited (FR).") %>% kableExtra::row_spec(0,bold=TRUE)

#qflextable(strata)

#<!---BLOCK_LANDSCAPE_START--->
```


