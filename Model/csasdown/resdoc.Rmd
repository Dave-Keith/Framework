---
title: |
    "Framework Development for Scallop Fishing Areas 25A, 25B, 26A, 26B, 26C, and 27B: Stock Assessment Models for SFAs 25A and 26A"
french_title: "En francais"
author: |
  David Keith
  Freya Keyser, 
  Raphael McDonald, 
  Tricia Pearo Drew, and
  Jessica Sameoto
  
author_list: "Keith, D.M., Keyser, F., McDonald, R., Pearo Drew, T., Sameoto, J.A."
address: |
  Bedford Institute of Oceanography\
     Fisheries and Oceans Canada, 1 Challenger Drive\
     Dartmouth, Nova Scotia, Canada, B2Y 4A2\
french_address: |
  ^1^Station biologique du Pacifique\
     Pêches et Océans Canada, 3190 Hammond Bay Road\
     Nanaimo, Colombie-Britannique, V9T 6N7, Canada\
     Une autre galaxie
month: "Month"
french_month: "Mois"
year: 2024
report_number: nnn
region: "Maritimes Region"
isbn: ""
cat_no: ""
french_region: "Région des Maritimes"
citation_other_language: "Keith, D.M., Keyser, F., McDonald, R., Pearo Drew, T., et Sameoto, J.A.  L'évaluation de petoncles dans les zones de pêche"
abstract: |
  This research document focuses on the development of new stock assessment methodologies for the stocks in Scallop Fishing Area (SFA) 25a and SFA 26A. A Bayesian State-Space Delay difference model (BSSM) has been used to assess the status of SFA 26A for over a decade, but no analytical models have ever been developed for SFA 25a. A modified version of the BSSM currently used for the SFA 26A assessments is used to model the population dyanmics for these two stocks. In addition, the population dynamics of these two stocks are modelled using a Spatially Explicit Assessment Model (SEAM); this model takes advantage of advances in computing power and the development of new statistical methods while retaining the same conceptual delay-difference population dynamics framework. Overall the two modelling frameworks provided broadly similar results, but there were differences in the productivity parameters between the models; these differences were more notable in SFA 25a.  The exploitation rate in SFA 25a has been low throughout the timeframe covered by the model and the fishery appears to have had little impact on stock dynamics.  In SFA 26A, there is evidence that the fishery does impact the stock dynamics, for this stock the fully-recruited biomass has always declined when the exploitation rate exceeds approximately 10%. For both stocks, the retrospective patterns indicated that fully-recruited biomass estimates were not strongly influenced by the inclusion of additional years of data. The analyses of the process error, residuals, and, for SEAM, the random fields, indicated that the process component of these models tended to overestimate fully-recruited biomass, but the models were largely able to compensate for this through their error structures. The prediction evaluation results indicated that default parameterizations for the one-year ahead fully-recruited biomass projections tended to over-estimate the realized biomass, this bias were substantially reduced by assuming zero productivity or not using the growth parameters for the projections. The results indicated that, for both stocks, BSSM and SEAM provided reasonable frameworks for modelling the stock dyanamics given the available data and could be used as a platform to provide science advice.  We suggest using the SEAM framework for both stocks moving forwward given the statistical properties of this framework, the additional understanding of the stock dynamics provided by the spatial fields, and the ongoing research potential for these types of models.

french_abstract: |
  Null
  
header: "Draft working paper --- Do not cite or circulate" # or "" to omit
output:
 csasdown::resdoc_word:
   # copy_sty is a toggle to copy the style file from the csasdown package every time you compile
   # the document. If false, any changes you have made to the style file in your project
   # will remain between compilations. If true, your changes will be lost when you compile
   # line_nums is a toggle to show line numbers on the left side of the page. 
   # line_nums_mod represents showing every Nth line if line_nums is true
   # lot_lof is a toggle to show/not show the lists of tables and figures at the
   # beginning of the document
   # draft_watermark is a toggle to show/not show a DRAFT watermark across every page
   # include_section_nums, if true includes section numbering in the document body,
   # if false, no numbering in the document budy but the TOC will still show numbering
   # pandoc --list-highlight-styles
   # pygments, tango, espresso, zenburn, kate, monochrome, breezedark, haddock
   # or the name of a custom *.latex file which is most easily made by copying one from 
   # file.path(.libPaths(), "csasdown", "themes")
   # to your working directory (the one containing index.Rmd)
   # To change the foreground text color, change the RGB value in the line containing
   # 'DefineVerbatimEnvironment'
   # To change background color, change the RGB values in the line containing 'shadecolor'
   french: false
   copy_sty: true
   line_nums: true
   line_nums_mod: 1
   lot_lof: false
   draft_watermark: false
   include_section_nums: true
   # highlight is the theme to use for code output. Must be one of the list given by:
   # which are:
   # the csasdown library 'themes' directory, this directory on your machine:
   highlight: tango
knit: (function(input, ...) {
       csasdown::render('_bookdown.yml')
      })
link-citations: true
bibliography: Y:/Zotero/MAR_SABHU.bib
#
# Any extra LaTeX code for the header:
header-includes:
 - \usepackage{tikz}
 - \usepackage{amssymb}
 - \usepackage{accents}
---

```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
library(knitr)
if (is_latex_output()) {
  knitr_figs_dir <- "knitr-figs-pdf/"
  knitr_cache_dir <- "knitr-cache-pdf/"
  fig_out_type <- "png"
} else {
  knitr_figs_dir <- "knitr-figs-docx/"
  knitr_cache_dir <- "knitr-cache-docx/"
  fig_out_type <- "png"
}
fig_asp <- 0.618
fig_width <- 9
fig_out_width <- "6in"
fig_dpi <- 180
fig_align <- "center"
fig_pos <- "htb"
opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = knitr_figs_dir,
  cache.path = knitr_cache_dir,
  fig.asp = fig_asp,
  fig.width = fig_width,
  out.width = fig_out_width,
  echo = FALSE,
  #  autodep = TRUE,
  #  cache = TRUE,
  cache.comments = FALSE,
  dev = fig_out_type,
  dpi = fig_dpi,
  fig.align = fig_align,
  fig.pos = fig_pos
  
)
```

```{r load-libraries, echo = FALSE, cache = FALSE, message = FALSE, results = 'hide', warning = FALSE}
# add other packages here:
library(dplyr)
library(readr)
library(tibble)
library(csasdown)
require(rosettafish)
library(sf)
library(SEBDAM)
library(tidyverse)
library(ggthemes)
library(cowplot)
library(collapse)


funs <- c("https://raw.githubusercontent.com/freyakeyser/rosetta_shell/main/terms.csv")
# Now run through a quick loop to load each one, just be sure that your working directory is read/write!
for(fun in funs) 
{
  download.file(fun,destfile = basename(fun))
  rosetta_terms <- read.csv(paste0(getwd(),"/",basename(fun)), encoding = "UTF-8")
  file.remove(paste0(getwd(),"/",basename(fun)))
}
# A not rosetta loop
funs <- c("https://raw.githubusercontent.com/Mar-Scal/Assessment_fns/master/Maps/pectinid_projector_sf.R",
          "https://raw.githubusercontent.com/Mar-Scal/Assessment_fns/master/Maps/convert_inla_mesh_to_sf.R"
          )
# Now run through a quick loop to load each one, just be sure that your working directory is read/write!
for(fun in funs) 
{
  download.file(fun,destfile = basename(fun))
  source(paste0(getwd(),"/",basename(fun)))
  file.remove(paste0(getwd(),"/",basename(fun)))
}

params <- NULL
params$bank <- c("Sab", "BBn")
params$surv.year <- c(2019, 2022, 2022, 2022, 2021, 2022)
params$bankname <- c("Sable Bank", "Browns Bank North")
params$banknum <- 1:length(params$bank)

fr <- ""
#fr <- "_fr"
if(fr=="") language <- "english"
if(!fr=="") language <- "french"
# nickname <- "framework3"
# 
# french <- F # set to T for french
# if(french == T) {
#   nickname <- paste0(nickname, "_fr")
# }

repo.loc <- "D:/Framework/SFA_25_26_2024/Model/"
num.knots <- 20 
init.m <- 0.2 
qR <- 0.33
g.mod <- 'g_original'
vary.q <- T
R.size <- "75"
FR.size <- "90"
years <- 1994:2022
mod.select <- "SEAM"

scenario.10 <- paste0(min(years),"_",max(years),"_vary_m_m0_",init.m,"_qR_",qR,"_",10,"_knots_",'g_original')
scenario.20 <- paste0(min(years),"_",max(years),"_vary_m_m0_",init.m,"_qR_",qR,"_",20,"_knots_",'g_original')

# SEAM results
sab.10 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",mod.select,"_model_output_",scenario.10,".Rds"))
sab.20 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",mod.select,"_model_output_",scenario.10,".Rds"))
bbn.10 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",mod.select,"_model_output_",scenario.10,"_vary_q=TRUE.Rds"))
bbn.20 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",mod.select,"_model_output_",scenario.20,"_vary_q=TRUE.Rds"))
# SEAM processed results...

# BBN Processed
Bdiff.bbn.20 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.20,"_vary_q=TRUE_B_differnce.Rds"))
# Annual exploitation
F.bbn.20 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.20,"_vary_q=TRUE_annual.exploit.Rds"))
# The nicely summarized model object
pred.proc.bbn.20 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.20,"_vary_q=TRUE_pred_proc.Rds"))
# The summarized spatial bits.
F.spat.bbn.20 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.20,"_vary_q=TRUE_F_spatial.Rds"))
F.spat.bbn.20$F.na <- -log(1-F.spat.bbn.20$exp.na)

# q spatial
q.spat.bbn.20 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.20,"_vary_q=TRUE_q_spatial.Rds"))
# m spatial
m.spat.bbn.20 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.20,"_vary_q=TRUE_m_spatial.Rds"))
# R spatial
r.spat.bbn.20 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.20,"_vary_q=TRUE_R_spatial.Rds"))
# B spatial
b.spat.bbn.20 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.20,"_vary_q=TRUE_B_spatial.Rds"))

# BBn 10 knots....
Bdiff.bbn.10 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.10,"_vary_q=TRUE_B_differnce.Rds"))
# Annual exploitation
F.bbn.10 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.10,"_vary_q=TRUE_annual.exploit.Rds"))
# The nicely summarized model object
pred.proc.bbn.10 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.10,"_vary_q=TRUE_pred_proc.Rds"))
# The summarized spatial bits.
F.spat.bbn.10 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.10,"_vary_q=TRUE_F_spatial.Rds"))
F.spat.bbn.10$F.na <- -log(1-F.spat.bbn.10$exp.na)

# q spatial
q.spat.bbn.10 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.10,"_vary_q=TRUE_q_spatial.Rds"))
# m spatial
m.spat.bbn.10 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.10,"_vary_q=TRUE_m_spatial.Rds"))
# R spatial
r.spat.bbn.10 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.10,"_vary_q=TRUE_R_spatial.Rds"))
# B spatial
b.spat.bbn.10 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",
                               mod.select,"_model_output_",scenario.10,"_vary_q=TRUE_B_spatial.Rds"))

##########Sab Processes SEAM 
# Sab 20
Bdiff.sab.20 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.20,"_B_differnce.Rds"))
# Annual exploitation
F.sab.20 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.20,"_annual.exploit.Rds"))
# The nicely summarized model object
pred.proc.sab.20 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.20,"_pred_proc.Rds"))
# The summarized spatial bits.
F.spat.sab.20 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.20,"_F_spatial.Rds"))
F.spat.sab.20$F.na <- -log(1-F.spat.sab.20$exp.na)
# q spatial
q.spat.sab.20 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.20,"_q_spatial.Rds"))
# m spatial
m.spat.sab.20 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.20,"_m_spatial.Rds"))
# R spatial
r.spat.sab.20 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.20,"_R_spatial.Rds"))
# B spatial
b.spat.sab.20 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.20,"_B_spatial.Rds"))

#Sab 10
Bdiff.sab.10 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.10,"_B_differnce.Rds"))
# Annual exploitation
F.sab.10 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.10,"_annual.exploit.Rds"))

# The nicely summarized model object
pred.proc.sab.10 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.10,"_pred_proc.Rds"))
# The summarized spatial bits.
F.spat.sab.10 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.10,"_F_spatial.Rds"))
F.spat.sab.10$F.na <- -log(1-F.spat.sab.10$exp.na)
# q spatial
q.spat.sab.10 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.10,"_q_spatial.Rds"))
# m spatial
m.spat.sab.10 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.10,"_m_spatial.Rds"))
# R spatial
r.spat.sab.10 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.10,"_R_spatial.Rds"))
# B spatial
b.spat.sab.10 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",
                               mod.select,"_model_output_",scenario.10,"_B_spatial.Rds"))

# BSSM results
sab.bssm <- readRDS(file = paste0(repo.loc,"/Results/Sab_SS_model/R_75_FR_90/B_R_M_F_summarized.Rds"))
bbn.bssm <- readRDS(file = paste0(repo.loc,"/Results/BBn_SS_model/R_75_FR_90/B_R_M_F_summarized.Rds"))
# The model output directly...
sab.bssm.mod.out <- readRDS(file = paste0(repo.loc,"/Results/Sab_SS_model/R_75_FR_90/Sab_SS_mod_output.Rds"))
bbn.bssm.mod.out <- readRDS(file = paste0(repo.loc,"/Results/BBn_SS_model/R_75_FR_90/BBn_SS_mod_output.Rds"))
# BSSM model catchability posterior...
sab.bssm.q <- readRDS(file = paste0(repo.loc,"/Results/Sab_SS_model/R_75_FR_90/q_posterior.Rds"))
sab.bssm.q <- data.frame(q = sab.bssm.q)
bbn.bssm.q <- readRDS(file = paste0(repo.loc,"/Results/BBn_SS_model/R_75_FR_90/q_posterior.Rds"))
bbn.bssm.q <- data.frame(q = bbn.bssm.q)

# Retro results
# First up is BSSM
# Sable
mr.bssm.sab <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Retros/Sab_mohns_rose_SSModel.Rds"))
retro.bssm.sab <-readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Retros/Sab_retro_SSModel.Rds"))
bias.bssm.sab <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Retros/Sab_bias_SSModel.Rds"))

# BBn
mr.bssm.bbn <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/Retros/BBn_mohns_rose_SSModel.Rds"))
retro.bssm.bbn <-readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/Retros/BBn_retro_SSModel.Rds"))
bias.bssm.bbn <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/Retros/BBn_bias_SSModel.Rds"))
# Now SEAM
# Sable
mr.sab <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Retros/Sab_mohns_rose_",mod.select,"_",scenario.10,".Rds"))
retro.sab <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Retros/Sab_retro_",mod.select,"_",scenario.10,".Rds"))
bias.sab <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Retros/Sab_bias_",mod.select,"_",scenario.10,".Rds"))
retro.sab$retro.year[retro.sab$retro.year == 'Base model'] <- "Full model"
# BBn
mr.bbn <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/Retros/BBn_mohns_rose_",mod.select,"_",scenario.20,"_vary_q=TRUE.Rds"))
retro.bbn <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/Retros/BBn_retro_",mod.select,"_",scenario.20,"_vary_q=TRUE.Rds"))
bias.bbn <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/Retros/BBn_bias_",mod.select,"_",scenario.20,"_vary_q=TRUE.Rds"))
retro.bbn$retro.year[retro.bbn$retro.year == 'Base model'] <- "Full model"



# Bring in the mesh and prediction grids...

bbn.mesh.10 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",mod.select,"_model_output_",scenario.10,"_vary_q=TRUE_mesh.Rds"))
bbn.grid.10 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",mod.select,"_model_output_",scenario.10,"_vary_q=TRUE_predict_grid.Rds"))
bbn.mesh.20 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",mod.select,"_model_output_",scenario.20,"_vary_q=TRUE_mesh.Rds"))
bbn.grid.20 <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",mod.select,"_model_output_",scenario.20,"_vary_q=TRUE_predict_grid.Rds"))

sab.mesh.10 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",mod.select,"_model_output_",scenario.10,"_mesh.Rds"))
sab.grid.10 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",mod.select,"_model_output_",scenario.10,"_predict_grid.Rds"))
sab.mesh.20 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",mod.select,"_model_output_",scenario.20,"_mesh.Rds"))
sab.grid.20 <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",mod.select,"_model_output_",scenario.20,"_predict_grid.Rds"))

# The model inputs...
sab.10.mod.input <- readRDS(paste0(repo.loc,"Results/Sab/R_",R.size,"_FR_",FR.size,"/Sab_",mod.select,"_model_output_",scenario.10,"_model_input.Rds"))
bbn.20.mod.input <- readRDS(paste0(repo.loc,"Results/BBn/R_",R.size,"_FR_",FR.size,"/BBn_",mod.select,"_model_output_",scenario.20,"_vary_q=TRUE_model_input.Rds"))
# Also want the BSSM model inputs...
sab.bssm.mod.input <- readRDS(paste0(repo.loc,"Data/Sab_BSSM_model.dat.RDS"))
bbn.bssm.mod.input <- readRDS(paste0(repo.loc,"Data/BBn_BSSM_model.dat.RDS"))

# Landings data, note this is for the total area not just within the polygon
sab.fish <-   readRDS(paste0(repo.loc,"Data/Sab_fish.dat.RDS"))
bbn.fish <-    readRDS(paste0(repo.loc,"Data/BBn_fish.dat.RDS"))

# Prediction evaluation data
# First for BSSM

bbn.bssm.pred.eval <- readRDS(paste0(repo.loc,"Results/BBn_SS_model/R_75_FR_90/BBn_prediction_evaluation.Rds"))
sab.bssm.pred.eval <- readRDS(paste0(repo.loc,"Results/Sab_SS_model/R_75_FR_90/Sab_prediction_evaluation.Rds"))

# Then for SEAM
bbn.pred.eval <- readRDS(paste0(repo.loc,"Results/BBn/R_75_FR_90/Pred_eval/SEAM_",scenario.20,"_vary_q=TRUE/Biomass_difference.Rds"))
sab.pred.eval <- readRDS(paste0(repo.loc,"Results/Sab/R_75_FR_90/Pred_eval/SEAM_",scenario.10,"/Biomass_difference.Rds"))

# Decision Tables.
# First for BSSM
bbn.bssm.dt <- readRDS(paste0(repo.loc,"Results/BBn_SS_model/R_75_FR_90/BBn_Decision_Table.Rds"))
sab.bssm.dt <- readRDS(paste0(repo.loc,"Results/Sab_SS_model/R_75_FR_90/Sab_Decision_Table.Rds"))

# Then for SEAM
sab.dt <- readRDS(paste0(repo.loc,"Results/Sab/R_75_FR_90/SEAM_",scenario.10,"/Decision_Table/TRP_",NULL,"_USR_",NULL,"_LRP_",NULL,"_RR_",NULL,"_g_adj_",0,"_gR_adj_",0,".Rds"))
bbn.dt <- readRDS(paste0(repo.loc,"Results/BBn/R_75_FR_90/SEAM_",scenario.20,"_vary_q=TRUE/Decision_Table/TRP_",NULL,"_USR_",NULL,"_LRP_",NULL,"_RR_",NULL,"_g_adj_",0,"_gR_adj_",0,".Rds"))

# Finally, we need to pull out the Process error and Residuals for BSSM
sab.bssm.pe.resids <- readRDS(paste0(repo.loc,"Results/Sab_SS_model/R_75_FR_90/PE_and_resids.Rds"))
bbn.bssm.pe.resids <- readRDS(paste0(repo.loc,"Results/BBn_SS_model/R_75_FR_90/PE_and_resids.Rds"))

theme_set(theme_few(base_size = 16))


```
```{r bilingual-code, cache=FALSE}
options(
  # Prevent xtable from adding a timestamp comment to the table code it produces
  xtable.comment = FALSE,
  # Do not allow kableExtra to load packages, we add them manually in csasdown
  kableExtra.latex.load_packages = FALSE,
  # Stop chunk output (echo) running into the margins
  width = 80,
  # Do not use scientific notation (stops tables from showing 1.2e3, etc.)
  scipen = 999)

meta <- rmarkdown::metadata
meta_out <- rmarkdown::metadata$output
csl <- "csl/csas.csl"
options(OutDec = ".")
if (is.null(getOption("french"))) {
  stop("`french` was not set up correctly in YAML header in index.Rmd. ",
       "It must be true or false",
       call. = FALSE)
}
if (getOption("french")) {
  csl <- "csl/csas-french.csl"
  options(OutDec = ",")
}

french <- isTRUE(getOption("french")) # for backwards compatibility

# This hook simplifies document translation for the author.
# When building in French, it draws a box around paragraphs contained in chunks
#  which have the option `needs_trans = TRUE`. It also labels
#  the box with a "Needs translation" tag in red and the chunk label in blue.
# You need to change the `needs_trans` option to `FALSE` for a chunk once you
#  have inserted the translated text into it. You will get a utf-8 error if
#  you leave it as `TRUE` and there is French in the chunk.
#  This function assumes you are translating from English to French.
#  If you wrote your document in French and want to translate to English,
#  put a ! before `getOption("french")` below and add the `need_trans`
#  chunk options to your English paragraph chunks instead of the French ones.
#  
#  IMPORTANT NOTES
#  - Use `csasdown::render()` to render the document. This runs a
#    pre-processing step which ensures any inline R chunks
#    `r print("Like this one")` are taken care of correctly and that all
#    backslash variables (eg. \pi, \alpha, \@ref, \cite) are all processed
#    correctly.
#  - French latex places a space before the colon by default so if you need a colon
#    with no space before it, use \\hc .
knit_hooks$set(needs_trans = function(before, options){
  if(getOption("french") && options$needs_trans){
    if (before){
      paste0("\\
   \\begin{lrbox}{\\userinput}
   \\begin{minipage}{\\dimexpr\\linewidth-2\\fboxsep-2\\fboxrule}
   \\textcolor{red}{\\textbf{Needs translation - \\textcolor{blue}{knitr chunk: ", options$label, "}}}
   \\begin{lstlisting}
  ")
    } else {
      "
   \\end{lstlisting}
   \\end{minipage}
   \\end{lrbox}
   \\noindent
   \\fbox{\\usebox{\\userinput}}
  "
    }
  }
})
```

---
title: `r ifelse(fr(), meta$french_title, meta$title)`
month: `r ifelse(fr(), meta$french_month, meta$month)`
region: `r ifelse(fr(), meta$french_region, meta$region)`
csl: `r csl`
---

<!--chapter:end:tmp-index.Rmd-->

---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r error-field-processing, echo=F, include=F, paged.print=FALSE,cache=T}
# For some stuff we need to drop the prediction year piece
drops <- length(pred.proc.sab.10$totals$totB)

# Get the error fields, adding in a lot of code here!!

# First get the mesh where we want it...
sab.10.mesh.sf <- inla.mesh2sf(sab.mesh.10$mesh)
sab.10.mesh.sf.triangles  <- sab.10.mesh.sf$triangles
sab.10.mesh.sf.triangles <- data.frame(sab.10.mesh.sf.triangles)
sab.10.mesh.sf.triangles$geometry <- sab.10.mesh.sf.triangles$geometry*1000
sab.10.mesh.sf.triangles <- st_as_sf(sab.10.mesh.sf.triangles)
st_crs(sab.10.mesh.sf.triangles) <- 32620
sab.10.mesh.sf  <- sab.10.mesh.sf$vertices
sab.10.mesh.sf$meshID <- 1:nrow(sab.10.mesh.sf)
sab.10.mesh.sf <- data.frame(sab.10.mesh.sf)
sab.10.mesh.sf$geometry <- sab.10.mesh.sf$geometry*1000
sab.10.mesh.sf <- st_as_sf(sab.10.mesh.sf)
# sab.grid.10 <- data.frame(sab.grid.10$grid)
# sab.grid.10$geometry <- sab.grid.10$geometry*1000
# sab.grid.10 <- st_as_sf(sab.grid.10)
# st_crs(sab.grid.10) <- 32620
#tst <- st_intersection(sab.10.mesh.sf,sab.grid.10)
# Now for BBn
# First get the mesh where we want it...
bbn.20.mesh.sf <- inla.mesh2sf(bbn.mesh.20$mesh)
bbn.20.mesh.sf.triangles  <- bbn.20.mesh.sf$triangles
bbn.20.mesh.sf.triangles <- data.frame(bbn.20.mesh.sf.triangles)
bbn.20.mesh.sf.triangles$geometry <- bbn.20.mesh.sf.triangles$geometry*1000
bbn.20.mesh.sf.triangles <- st_as_sf(bbn.20.mesh.sf.triangles)
st_crs(bbn.20.mesh.sf.triangles) <- 32620
bbn.20.mesh.sf  <- bbn.20.mesh.sf$vertices
bbn.20.mesh.sf$meshID <- 1:nrow(bbn.20.mesh.sf)
bbn.20.mesh.sf <- data.frame(bbn.20.mesh.sf)
bbn.20.mesh.sf$geometry <- bbn.20.mesh.sf$geometry*1000
bbn.20.mesh.sf <- st_as_sf(bbn.20.mesh.sf)



# First biomass for sable 10....
sab.10.B.field <- as.data.frame(sab.10$report$omega_B[,-drops])
names(sab.10.B.field) <- years
sab.10.B.field$meshID <- 1:nrow(sab.10.B.field)
sab.10.B.field <- sab.10.B.field %>% pivot_longer(!meshID)
# now let's join these...
sab.10.B.field <- merge(sab.10.mesh.sf,sab.10.B.field,by="meshID",)
st_crs(sab.10.B.field) <- 32620
sab.10.B.field <- st_join(sab.10.mesh.sf.triangles,sab.10.B.field)

# Now the recruits
sab.10.R.field <- as.data.frame(sab.10$report$omega_R) # no drop as we don't have this in year 30...
names(sab.10.R.field) <- years
sab.10.R.field$meshID <- 1:nrow(sab.10.R.field)
sab.10.R.field <- sab.10.R.field %>% pivot_longer(!meshID)
# now let's join these...
sab.10.R.field <- merge(sab.10.mesh.sf,sab.10.R.field,by="meshID",)
st_crs(sab.10.R.field) <- 32620
sab.10.R.field <- st_join(sab.10.mesh.sf.triangles,sab.10.R.field)

# Finally the natural mortality.
sab.10.m.field <- as.data.frame(sab.10$report$omega_m[,-drops])
names(sab.10.m.field) <- years
sab.10.m.field$meshID <- 1:nrow(sab.10.m.field)
sab.10.m.field <- sab.10.m.field %>% pivot_longer(!meshID)
# now let's join these...
sab.10.m.field <- merge(sab.10.mesh.sf,sab.10.m.field,by="meshID",)
st_crs(sab.10.m.field) <- 32620
sab.10.m.field <- st_join(sab.10.mesh.sf.triangles,sab.10.m.field)



# Now the same thing for BBn
# First Biomass field
bbn.20.B.field <- as.data.frame(bbn.20$report$omega_B[,-drops])
names(bbn.20.B.field) <- years
bbn.20.B.field$meshID <- 1:nrow(bbn.20.B.field)
bbn.20.B.field <- bbn.20.B.field %>% pivot_longer(!meshID)
# now let's join these...
bbn.20.B.field <- merge(bbn.20.mesh.sf,bbn.20.B.field,by="meshID",)
st_crs(bbn.20.B.field) <- 32620
bbn.20.B.field <- st_join(bbn.20.mesh.sf.triangles,bbn.20.B.field)

# Now the recruits
bbn.20.R.field <- as.data.frame(bbn.20$report$omega_R) # no drop as we don't have this in year 30...
names(bbn.20.R.field) <- years
bbn.20.R.field$meshID <- 1:nrow(bbn.20.R.field)
bbn.20.R.field <- bbn.20.R.field %>% pivot_longer(!meshID)
# now let's join these...
bbn.20.R.field <- merge(bbn.20.mesh.sf,bbn.20.R.field,by="meshID",)
st_crs(bbn.20.R.field) <- 32620
bbn.20.R.field <- st_join(bbn.20.mesh.sf.triangles,bbn.20.R.field)

# Finally the natural mortality.
bbn.20.m.field <- as.data.frame(bbn.20$report$omega_m[,-drops])
names(bbn.20.m.field) <- years
bbn.20.m.field$meshID <- 1:nrow(bbn.20.m.field)
bbn.20.m.field <- bbn.20.m.field %>% pivot_longer(!meshID)
# now let's join these...
bbn.20.m.field <- merge(bbn.20.mesh.sf,bbn.20.m.field,by="meshID",)
st_crs(bbn.20.m.field) <- 32620
bbn.20.m.field <- st_join(bbn.20.mesh.sf.triangles,bbn.20.m.field)


# Now to get the SEAM 'median' process error in a year
# First sable...
sab.knot.cen <- as.data.frame(sab.mesh.10$knots$centers*1000)
sab.knot.cen <- st_as_sf(sab.knot.cen,coords = c("X","Y"))
st_crs(sab.knot.cen) <- 32620

bbn.knot.cen <- as.data.frame(bbn.mesh.20$knots$centers*1000)
bbn.knot.cen <- st_as_sf(bbn.knot.cen,coords = c("X","Y"))
st_crs(bbn.knot.cen) <- 32620

# Now intersect them..., this looks to pull out what we want, but of course I need to get this for every year...
hmm.bbn <- list()
hmm.sab <- list()
for(i in years)
{
  tmp <- bbn.20.B.field |> fsubset(name == i)
  hmm.bbn[[as.character(i)]] <- st_join(bbn.knot.cen,tmp,k=1,join = nngeo::st_nn)
  tmp <- sab.10.B.field |> fsubset(name == i)
  hmm.sab[[as.character(i)]] <- st_join(sab.knot.cen,tmp,k=1,join = nngeo::st_nn)
}

bbn.knot.pe <- do.call('rbind',hmm.bbn)
sab.knot.pe <- do.call('rbind',hmm.sab)

bbn.med.pe.seam <- bbn.knot.pe |> as.data.frame() |> fgroup_by(name) |> fsummarise(med =median(value,na.rm=T)) |> data.frame()
sab.med.pe.seam <- sab.knot.pe |> as.data.frame() |> fgroup_by(name) |> fsummarise(med =median(value,na.rm=T)) |> data.frame()
names(sab.med.pe.seam) <- c("year","med")
names(bbn.med.pe.seam) <- c("year","med")
sab.med.pe.seam$year <- as.numeric(sab.med.pe.seam$year)
bbn.med.pe.seam$year <- as.numeric(bbn.med.pe.seam$year)
```



```{r analysis, echo=F, include=F, paged.print=FALSE,cache=T}

# Numbers for the text...
# For some stuff we need to drop the prediction year piece
drops <- length(pred.proc.sab.10$totals$totB)


# BSSM results
# SFA 25a Sable
sab.bssm.bm <- sab.bssm %>% dplyr::filter(term == "Biomass (tonnes)")
sab.bssm.rec <- sab.bssm %>% dplyr::filter(term == "Recruit Biomass (tonnes)")
sab.bssm.nm.fr <- sab.bssm %>% dplyr::filter(term == "FR Natural Mortality (90+ mm, instantaneous)")
sab.bssm.nm.rec <- sab.bssm %>% dplyr::filter(term == "Recruit Natural Mortality (75-90 mm, instantaneous)")
sab.bssm.fm <- sab.bssm %>% dplyr::filter(term == "Fishing Mortality (instantaneous)")

# biomass
max.b.sab.bssm <- round(max(sab.bssm.bm$med,na.rm=T),digits=0)
max.b.sab.bssm.y <- sab.bssm.bm$year[sab.bssm.bm$med == max(sab.bssm.bm$med,na.rm=T)]
min.b.sab.bssm <- round(min(sab.bssm.bm$med,na.rm=T),digits=0)
min.b.sab.bssm.y <- sab.bssm.bm$year[sab.bssm.bm$med == min(sab.bssm.bm$med,na.rm=T)]
# Recruits
max.r.sab.bssm <- round(max(sab.bssm.rec$med,na.rm=T),digits=0)
max.r.sab.bssm.y <- sab.bssm.rec$year[sab.bssm.rec$med == max(sab.bssm.rec$med,na.rm=T)]
min.r.sab.bssm <- round(min(sab.bssm.rec$med,na.rm=T),digits=0)
min.r.sab.bssm.y <- sab.bssm.rec$year[sab.bssm.rec$med == min(sab.bssm.rec$med,na.rm=T)]
#fishing mortality...
max.sab.fm <- round(max(sab.bssm.fm$med),digits=3)
max.recent.sab.fm <- round(max(sab.bssm.fm$med[sab.bssm.fm$year >= 2007]),digits=3)

# maximum rhat value
sab.rhat <- round(max(sab.bssm.mod.out$summary[,8]),digits=3)
bbn.rhat <- round(max(bbn.bssm.mod.out$summary[,8]),digits=3)
sab.neff <- round(min(sab.bssm.mod.out$summary[,9]),digits=0)
bbn.neff <- round(min(bbn.bssm.mod.out$summary[,9]),digits=0)


# BBN
bbn.bssm.bm <- bbn.bssm %>% dplyr::filter(term == "Biomass (tonnes)")
bbn.bssm.rec <- bbn.bssm %>% dplyr::filter(term == "Recruit Biomass (tonnes)")
bbn.bssm.nm.fr <- bbn.bssm %>% dplyr::filter(term == "FR Natural Mortality (90+ mm, instantaneous)")
bbn.bssm.nm.rec <- bbn.bssm %>% dplyr::filter(term == "Recruit Natural Mortality (75-90 mm, instantaneous)")
bbn.bssm.fm <- bbn.bssm %>% dplyr::filter(term == "Fishing Mortality (instantaneous)")
# biomass
max.b.bbn.bssm <- round(max(bbn.bssm.bm$med,na.rm=T),digits=0)
max.b.bbn.bssm.y <- bbn.bssm.bm$year[bbn.bssm.bm$med == max(bbn.bssm.bm$med,na.rm=T)]
min.b.bbn.bssm <- round(min(bbn.bssm.bm$med,na.rm=T),digits=0)
min.b.bbn.bssm.y <- bbn.bssm.bm$year[bbn.bssm.bm$med == min(bbn.bssm.bm$med,na.rm=T)]
# Recruits
max.r.bbn.bssm <- round(max(bbn.bssm.rec$med,na.rm=T),digits=0)
max.r.bbn.bssm.y <- bbn.bssm.rec$year[bbn.bssm.rec$med == max(bbn.bssm.rec$med,na.rm=T)]
min.r.bbn.bssm <- round(min(bbn.bssm.rec$med,na.rm=T),digits=0)
min.r.bbn.bssm.y <- bbn.bssm.rec$year[bbn.bssm.rec$med == min(bbn.bssm.rec$med,na.rm=T)]

max.bbn.fm <- round(max(bbn.bssm.fm$med),digits=2)

# catchability estimates....
sab.med.q <- round(median(sab.bssm.q$q,na.rm=T),digits=2)
bbn.med.q <- round(median(bbn.bssm.q$q,na.rm=T),digits=2)

# natural mortality on Sable of recruits since 2011
sab.last.10.rec.nm <- round(median(sab.bssm.nm.rec$med[sab.bssm.nm.rec$year >= 2011]),digits=2)
bbn.last.5.rec.nm <- round(median(bbn.bssm.nm.rec$med[bbn.bssm.nm.rec$year >= 2018]),digits=2)


# Now SEAM


# Maximum and min biomasses and years for sable
max.b.sab <- round(max(pred.proc.sab.10$totals$totB))
max.b.sab.y <- years[which(pred.proc.sab.10$totals$totB == max(pred.proc.sab.10$totals$totB))]
min.b.sab <- round(min(pred.proc.sab.10$totals$totB))
min.b.sab.y <- years[which(pred.proc.sab.10$totals$totB == min(pred.proc.sab.10$totals$totB))]
# for bbn
max.b.bbn <- round(max(pred.proc.bbn.20$totals$totB))
max.b.bbn.y <- years[which(pred.proc.bbn.20$totals$totB == max(pred.proc.bbn.20$totals$totB))]
min.b.bbn <- round(min(pred.proc.bbn.20$totals$totB))
min.b.bbn.y <- years[which(pred.proc.bbn.20$totals$totB == min(pred.proc.bbn.20$totals$totB))]

# Max and min catchabilities
min.q.sab <- round(min(q.spat.sab.10$qI),digits=2)
max.q.sab <- round(max(q.spat.sab.10$qI),digits=2)
min.q.bbn <- round(min(q.spat.bbn.20$qI),digits=2)
max.q.bbn <- round(max(q.spat.bbn.20$qI),digits=2)

# Recruitment numbers
rec.sab.since.07 <- round(max(pred.proc.sab.10$totals$totR[which(years == 2007):drops],na.rm=T),digits=0)


# natural mortality range
max.m.sab <- round(max(1-exp(-pred.proc.sab.10$totals$mean_m)),digits=2)
min.m.sab <- round(min(pred.proc.sab.10$totals$mean_m),digits=2)
# for bbn
max.m.bbn <- round(max(pred.proc.bbn.20$totals$mean_m),digits=2)
min.m.bbn <- round(min(pred.proc.bbn.20$totals$mean_m),digits=2)

# Fishing mortality
min.f.sab <- round(min(F.sab.10$FM,na.rm=T),digits=2)
max.f.sab <- round(max(F.sab.10$FM,na.rm=T),digits=2)
# bbn
min.f.bbn <- round(min(F.bbn.20$FM,na.rm=T),digits=2)
max.f.bbn <- round(max(F.bbn.20$FM,na.rm=T),digits=2)

# Key differences between 10 and 20 knot models...
# First Sable
knot.b.diff.sab <- pred.proc.sab.20$totals$totB[-drops] - pred.proc.sab.10$totals$totB[-drops]
mn.b.knot.diff.sab <- round(median(knot.b.diff.sab),digits=1)
mn.b.per.knot.diff.sab <- round(100*(median(knot.b.diff.sab / pred.proc.sab.10$totals$totB[-drops])),digits=1)
# recruits
knot.r.diff.sab <- pred.proc.sab.10$totals$totR[-drops] - pred.proc.sab.20$totals$totR[-drops]
mn.r.knot.diff.sab <- round(median(knot.r.diff.sab),digits=1)
mn.r.per.knot.diff.sab <- round(100*(median(knot.r.diff.sab / pred.proc.sab.10$totals$totR[-drops])),digits=1)

knot.m.diff.sab <- pred.proc.sab.10$totals$mean_m[-drops] - pred.proc.sab.20$totals$mean_m[-drops]
mn.m.knot.diff.sab <- round(median(knot.m.diff.sab),digits=2)
mn.m.per.knot.diff.sab <- round(100*(median(knot.m.diff.sab / pred.proc.sab.10$totals$mean_m[-drops])),digits=1)

min.q.sab.20 <- round(min(q.spat.sab.20$qI),digits=2)
max.q.sab.20 <- round(max(q.spat.sab.20$qI),digits=2)

# Now BBn

knot.b.diff.bbn <- pred.proc.bbn.10$totals$totB[-drops] - pred.proc.bbn.20$totals$totB[-drops] 
mn.b.knot.diff.bbn <- round(median(knot.b.diff.bbn),digits=1)
mn.b.per.knot.diff.bbn <- round(100*(median(knot.b.diff.bbn / pred.proc.bbn.20$totals$totB[-drops])),digits=1)
# recruits
knot.r.diff.bbn <- pred.proc.bbn.10$totals$totR[-drops] - pred.proc.bbn.20$totals$totR[-drops]
mn.r.knot.diff.bbn <- round(median(knot.r.diff.bbn),digits=1)
mn.r.per.knot.diff.bbn <- round(100*(median(knot.r.diff.bbn / pred.proc.bbn.20$totals$totR[-drops])),digits=1)

knot.m.diff.bbn <- pred.proc.bbn.10$totals$mean_m[-drops] - pred.proc.bbn.20$totals$mean_m[-drops]
mn.m.knot.diff.bbn <- round(median(knot.m.diff.bbn),digits=2)
mn.m.per.knot.diff.bbn <- round(100*(median(knot.m.diff.bbn / pred.proc.bbn.20$totals$mean_m[-drops])),digits=1)

min.q.bbn.10 <- round(min(q.spat.bbn.10$qI),digits=2)
max.q.bbn.10 <- round(max(q.spat.bbn.10$qI),digits=2)


# Retrospecitves
# Sable BSSM
mr.b.bssm.sab.5 <- round(mr.bssm.sab$mr.B5,digits=2)
mr.b.bssm.sab.all <- round(mr.bssm.sab$mr.B,digits=2)
mr.r.bssm.sab.5 <- round(mr.bssm.sab$mr.R5,digits=2)
mr.r.bssm.sab.all <- round(mr.bssm.sab$mr.R,digits=2)
mr.m.bssm.sab.5 <- round(mr.bssm.sab$mr.m5,digits=2)
mr.m.bssm.sab.all <- round(mr.bssm.sab$mr.m,digits=2)


# Sable
mr.b.sab.5 <- round(mr.sab$mr.B5,digits=2)
mr.b.sab.all <- round(mr.sab$mr.B,digits=2)
mr.r.sab.5 <- round(mr.sab$mr.R5,digits=2)
mr.r.sab.all <- round(mr.sab$mr.R,digits=2)
mr.m.sab.5 <- round(mr.sab$mr.m5,digits=2)
mr.m.sab.all <- round(mr.sab$mr.m,digits=2)

# BBN bssm...
mr.b.bssm.bbn.5 <- round(mr.bssm.bbn$mr.B5,digits=2)
mr.b.bssm.bbn.all <- round(mr.bssm.bbn$mr.B,digits=2)
mr.r.bssm.bbn.5 <- round(mr.bssm.bbn$mr.R5,digits=2)
mr.r.bssm.bbn.all <- round(mr.bssm.bbn$mr.R,digits=2)
mr.m.bssm.bbn.5 <- round(mr.bssm.bbn$mr.m5,digits=2)
mr.m.bssm.bbn.all <- round(mr.bssm.bbn$mr.m,digits=2)

# BBn
mr.b.bbn.5 <- round(mr.bbn$mr.B5,digits=2)
mr.b.bbn.all <- round(mr.bbn$mr.B,digits=2)
mr.r.bbn.5 <- round(mr.bbn$mr.R5,digits=2)
mr.r.bbn.all <- round(mr.bbn$mr.R,digits=2)
mr.m.bbn.5 <- round(mr.bbn$mr.m5,digits=2)
mr.m.bbn.all <- round(mr.bbn$mr.m,digits=2)

# Get the biomass process error annually....
# Sable

Bdiff.sab.10.y <- Bdiff.sab.10 %>% dplyr::group_by(Year) %>% dplyr::summarise(PE = sum(B.diff),
                                                                              mod.B = sum(B.mod),
                                                                              exp.B = sum(B.exp))
Bdiff.sab.10.y <- Bdiff.sab.10.y %>% dplyr::mutate(res.check = exp.B-mod.B,
                                                   res.per = 100*PE/mod.B)

min.sab.10.res <- round(min(Bdiff.sab.10.y$PE),digits=0)
max.sab.10.res <- round(max(Bdiff.sab.10.y$PE),digits=0)
med.sab.10.res <- round(median(abs(Bdiff.sab.10.y$PE)),digits=0)
med.sab.10.per.res <- round(median(abs(Bdiff.sab.10.y$res.per)),digits=0)
# BBn
Bdiff.bbn.20.y <- Bdiff.bbn.20 %>% dplyr::group_by(Year) %>% dplyr::summarise(PE = sum(B.diff),
                                                                              mod.B = sum(B.mod),
                                                                              exp.B = sum(B.exp))
Bdiff.bbn.20.y <- Bdiff.bbn.20.y %>% dplyr::mutate(res.check = exp.B-mod.B,
                                                   res.per = 100*PE/mod.B)

min.bbn.20.res <- round(min(Bdiff.bbn.20.y$PE),digits=0)
max.bbn.20.res <- round(max(Bdiff.bbn.20.y$PE),digits=0)
med.bbn.20.res <- round(median(abs(Bdiff.bbn.20.y$PE)),digits=0)
med.bbn.20.per.res <- round(median(abs(Bdiff.bbn.20.y$res.per)),digits=0)



# Actual residuals...
# First get the knot that the observation lives in.
bbn.20.g <- bbn.grid.20$grid
bbn.20.g$geometry <- bbn.20.g$geometry*1000
st_crs(bbn.20.g) <- 32619
bbn.20.mod.in <- st_intersection(bbn.20.mod.input,bbn.20.g)
#mod.in

bbn.20.obs <- st_join(bbn.20.mod.in,bbn.20.g,by=c("knotID","area"),left=T)
bbn.20.obs <- bbn.20.obs[,which(names(bbn.20.obs) %in% c("I","IR","tot.live.com","L","N","knotID.x",'area.x',"year","Year","tow",'lat','lon'))]
names(bbn.20.obs) <- c("I","IR",'Year','tow',"tot.live.com",'lat','lon',"L","N","year","knotID","area",'geometry')
bbn.20.obs.I <- bbn.20.obs[,which(names(bbn.20.obs) %in% c("I","Year","knotID"))]
bbn.20.obs.IR <- bbn.20.obs[,which(names(bbn.20.obs) %in% c("IR","Year","knotID"))]
#bbn.20.obs.L <- bbn.20.obs[,which(names(bbn.20.obs) %in% c("L","N","Year","knotID"))]
#bbn.20.obs.L$m <- bbn.20.obs.L$L/bbn.20.obs.L$N
# Now remove the NAs and we have the observations by knotID.

#bbn.20 <- readRDS("D:/Framework/SFA_25_26_2024/Model/Results/BBn/R_75_FR_90/BBn_SEAM_model_output_1994_2022_vary_m_m0_0.2_qR_0.33_20_knots_g_1_vary_q=TRUE.Rds")

# Now get the q-corrected model estimates by knot, remember the observations are in kg/km^2
# so we want to use the biomass densities (B) within a knot as our 'residual' metric to make them apples et apples.
bbn.20.q.cor.mod.I <- data.frame(t(bbn.20$report$B*bbn.20$report$qI/bbn.20$report$p_I))
names(bbn.20.q.cor.mod.I) <- substr(names(bbn.20.q.cor.mod.I),2,3)
bbn.20.q.cor.mod.I$Year <- 1994:2023
bbn.20.q.cor.mod.I <- bbn.20.q.cor.mod.I %>% dplyr::filter(Year != 2023)
bbn.20.q.cor.mod.I <- pivot_longer(bbn.20.q.cor.mod.I,cols=!Year,names_to = 'knotID',values_to = "I.mod")
bbn.20.q.cor.mod.I$knotID <- as.integer(bbn.20.q.cor.mod.I$knotID)
# Now for IR...
bbn.20.q.cor.mod.IR <- data.frame(t(bbn.20$report$R*bbn.20$report$qR/bbn.20$report$p_IR))
names(bbn.20.q.cor.mod.IR) <- substr(names(bbn.20.q.cor.mod.IR),2,3)
bbn.20.q.cor.mod.IR$Year <- years
#bbn.20.q.cor.mod.IR <- bbn.20.q.cor.mod.IR %>% dplyr::filter(Year != 2023)
bbn.20.q.cor.mod.IR <- pivot_longer(bbn.20.q.cor.mod.IR,cols=!Year,names_to = 'knotID',values_to = "IR.mod")
bbn.20.q.cor.mod.IR$knotID <- as.integer(bbn.20.q.cor.mod.IR$knotID)
# And the mortality
# bbn.20.q.cor.mod.L <- data.frame(t(bbn.20$report$m*bbn.20$report$S))
# names(bbn.20.q.cor.mod.L) <- substr(names(bbn.20.q.cor.mod.L),2,3)
# bbn.20.q.cor.mod.L$Year <- 1994:2023
# bbn.20.q.cor.mod.L <- bbn.20.q.cor.mod.L %>% dplyr::filter(Year != 2023)
# bbn.20.q.cor.mod.L <- pivot_longer(bbn.20.q.cor.mod.L,cols=!Year,names_to = 'knotID',values_to = "m.mod")
# bbn.20.q.cor.mod.L$knotID <- as.integer(bbn.20.q.cor.mod.L$knotID)

# Now get the residuals...
bbn.20.I.resids <- left_join(bbn.20.q.cor.mod.I,bbn.20.obs.I,by = c("Year","knotID"))
bbn.20.I.resids <- bbn.20.I.resids %>% collapse::fsubset(I > 0)
# These are standardized residuals.
bbn.20.I.resids$residual <- log(bbn.20.I.resids$I) - log(bbn.20.I.resids$I.mod) +0.5*bbn.20$report$sigma_epsilon^2
bbn.20.I.resids$per.resid <- 100*(bbn.20.I.resids$residual)/log(bbn.20.I.resids$I.mod)
#bbn.20.I.resids$stan.resid <- bbn.20.I.resids$residual/sd(bbn.20.I.resids$residual,na.rm=T)

# Recruits
bbn.20.IR.resids <- left_join(bbn.20.q.cor.mod.IR,bbn.20.obs.IR,by = c("Year","knotID"))
bbn.20.IR.resids <- bbn.20.IR.resids %>% collapse::fsubset(IR > 0)
bbn.20.IR.resids$residual <- log(bbn.20.IR.resids$IR) - log(bbn.20.IR.resids$IR.mod)+0.5*bbn.20$report$sigma_upsilon^2
bbn.20.IR.resids$per.resid <- 100*(bbn.20.IR.resids$IR - bbn.20.IR.resids$IR.mod)/bbn.20.IR.resids$IR.mod
#bbn.20.IR.resids$stan.resid <- bbn.20.IR.resids$residual/sd(bbn.20.IR.resids$residual,na.rm=T)

# And the mortality...
# bbn.20.L.resids <- left_join(bbn.20.q.cor.mod.L,bbn.20.obs.L,by = c("Year","knotID"))
# bbn.20.L.resids$residual <- bbn.20.L.resids$m - bbn.20.L.resids$m.mod
# bbn.20.L.resids$per.resid <- 100*(bbn.20.L.resids$m - bbn.20.L.resids$m.mod)/bbn.20.L.resids$m.mod
# bbn.20.L.resids$stan.resid <- bbn.20.L.resids$residual/sd(bbn.20.L.resids$residual,na.rm=T)


# Now do the same for Sable...
sab.10.g <- sab.grid.10$grid
sab.10.g$geometry <- sab.10.g$geometry*1000
st_crs(sab.10.g) <- 32620
sab.10.mod.in <- st_intersection(sab.10.mod.input,sab.10.g)

sab.10.obs <- st_join(sab.10.mod.in,sab.10.g,by=c("knotID","area"),left=T)
sab.10.obs <- sab.10.obs[,which(names(sab.10.obs) %in% c("I","IR","tot.live.com","L","N","knotID.x",'area.x',"year","Year","tow",'lat','lon'))]
names(sab.10.obs) <- c("I","IR",'Year','tow',"tot.live.com",'lat','lon',"L","N","year","knotID","area",'geometry')
sab.10.obs.I <- sab.10.obs[,which(names(sab.10.obs) %in% c("I","Year","knotID"))]
sab.10.obs.IR <- sab.10.obs[,which(names(sab.10.obs) %in% c("IR","Year","knotID"))]
# sab.10.obs.L <- sab.10.obs[,which(names(sab.10.obs) %in% c("L","N","Year","knotID"))]
# sab.10.obs.L$m <- sab.10.obs.L$L/sab.10.obs.L$N


sab.10.q.cor.mod.I <- data.frame(t(sab.10$report$B*sab.10$report$qI/sab.10$report$p_I))
names(sab.10.q.cor.mod.I) <- substr(names(sab.10.q.cor.mod.I),2,3)
sab.10.q.cor.mod.I$Year <- c(years,2023)
sab.10.q.cor.mod.I <- sab.10.q.cor.mod.I %>% dplyr::filter(Year != 2023)
sab.10.q.cor.mod.I <- pivot_longer(sab.10.q.cor.mod.I,cols=!Year,names_to = 'knotID',values_to = "I.mod")
sab.10.q.cor.mod.I$knotID <- as.integer(sab.10.q.cor.mod.I$knotID)
# Now for IR...
sab.10.q.cor.mod.IR <- data.frame(t(sab.10$report$R*sab.10$report$qR/sab.10$report$p_IR))
names(sab.10.q.cor.mod.IR) <- substr(names(sab.10.q.cor.mod.IR),2,3)
sab.10.q.cor.mod.IR$Year <- years
#sab.10.q.cor.mod.IR <- sab.10.q.cor.mod.IR %>% dplyr::filter(Year != 2023)
sab.10.q.cor.mod.IR <- pivot_longer(sab.10.q.cor.mod.IR,cols=!Year,names_to = 'knotID',values_to = "IR.mod")
sab.10.q.cor.mod.IR$knotID <- as.integer(sab.10.q.cor.mod.IR$knotID)
# And the mortality
# sab.10.q.cor.mod.L <- data.frame(t(sab.10$report$m*sab.10$report$S))
# names(sab.10.q.cor.mod.L) <- substr(names(sab.10.q.cor.mod.L),2,3)
# sab.10.q.cor.mod.L$Year <-  c(years,2023)
# sab.10.q.cor.mod.L <- sab.10.q.cor.mod.L %>% dplyr::filter(Year != 2023)
# sab.10.q.cor.mod.L <- pivot_longer(sab.10.q.cor.mod.L,cols=!Year,names_to = 'knotID',values_to = "m.mod")
# sab.10.q.cor.mod.L$knotID <- as.integer(sab.10.q.cor.mod.L$knotID)


# Now get the residuals...
sab.10.I.resids <- left_join(sab.10.q.cor.mod.I,sab.10.obs.I,by = c("Year","knotID"))
# Only keep non-zero values... I think...
sab.10.I.resids <- sab.10.I.resids |> collapse::fsubset(I > 0)
sab.10.I.resids$residual <- log(sab.10.I.resids$I) - log(sab.10.I.resids$I.mod) +0.5*sab.10$report$sigma_epsilon^2
sab.10.I.resids$per.resid <- 100*(sab.10.I.resids$residual)/log(sab.10.I.resids$I.mod)
#sab.10.I.resids$stan.resid <- sab.10.I.resids$residual/sd(sab.10.I.resids$residual,na.rm=T)

# Recruits
sab.10.IR.resids <- left_join(sab.10.q.cor.mod.IR,sab.10.obs.IR,by = c("Year","knotID"))
# Only keep non-zero values... I think...
sab.10.IR.resids <- sab.10.IR.resids |> collapse::fsubset(IR > 0)
sab.10.IR.resids$residual <- log(sab.10.IR.resids$IR) - log(sab.10.IR.resids$IR.mod) +0.5*sab.10$report$sigma_upsilon^2
sab.10.IR.resids$per.resid <- 100*(sab.10.IR.resids$residual)/log(sab.10.IR.resids$IR.mod)
#sab.10.IR.resids$stan.resid <- sab.10.IR.resids$residual/sd(sab.10.IR.resids$residual,na.rm=T)

# And the mortality...
# sab.10.L.resids <- left_join(sab.10.q.cor.mod.L,sab.10.obs.L,by = c("Year","knotID"))
# sab.10.L.resids$residual <- sab.10.L.resids$m - sab.10.L.resids$m.mod
# sab.10.L.resids$per.resid <- 100*(sab.10.L.resids$m - sab.10.L.resids$m.mod)/sab.10.L.resids$m.mod
# sab.10.L.resids$stan.resid <- sab.10.L.resids$residual/sd(sab.10.L.resids$residual,na.rm=T)





# SEAM vs BSSM
# SFA 25a
# biomass differences...
sab.b.seam.bssm <- sab.bssm.bm$med - pred.proc.sab.10$totals$totB[-drops]
med.b.sab.seam.bssm <- round(median(sab.b.seam.bssm,na.rm=T),digits=0)
med.per.b.sab.seam.bssm <- round(median(100* (sab.b.seam.bssm / pred.proc.sab.10$totals$totB[-drops]),digits=0))
# recruit differences...
sab.r.seam.bssm <- sab.bssm.rec$med - pred.proc.sab.10$totals$totR[-drops]
med.r.sab.seam.bssm <- round(median(sab.r.seam.bssm,na.rm=T),digits=0)
med.per.r.sab.seam.bssm <- round(median(100* (sab.r.seam.bssm / pred.proc.sab.10$totals$totR[-drops]),digits=0))
# average natural mortality...
med.m.sab.seam <- round(median(1-exp(-pred.proc.sab.10$totals$mean_m)),digits=2)
med.m.fr.sab.bssm <- round(median(sab.bssm.nm.fr$med),digits=2)
med.m.r.sab.bssm <- round(median(sab.bssm.nm.rec$med),digits=2)
# BBn
# biomass differences...
bbn.b.seam.bssm <- bbn.bssm.bm$med - pred.proc.bbn.20$totals$totB[-drops]
med.b.bbn.seam.bssm <- round(median(bbn.b.seam.bssm,na.rm=T),digits=0)
med.per.b.bbn.seam.bssm <- round(median(100* (bbn.b.seam.bssm / pred.proc.bbn.20$totals$totB[-drops]),digits=0))
# recruit differences...
bbn.r.seam.bssm <- bbn.bssm.rec$med - pred.proc.bbn.20$totals$totR[-drops]
med.r.bbn.seam.bssm <- round(median(bbn.r.seam.bssm,na.rm=T),digits=0)
med.per.r.bbn.seam.bssm <- round(median(100* (bbn.r.seam.bssm / pred.proc.bbn.20$totals$totR[-drops]),digits=0))
# average natural mortality...
med.m.bbn.seam <- round(median(1-exp(-pred.proc.bbn.20$totals$mean_m)),digits=2)
med.m.fr.bbn.bssm <- round(median(bbn.bssm.nm.fr$med),digits=2)
med.m.r.bbn.bssm <- round(median(bbn.bssm.nm.rec$med),digits=2)


# Relative fishing mortality...
sab.10.removals <- data.frame(year= years,
                              Catch = colSums(sab.10$obj$env$data$C*sab.10$obj$env$data$area)[-drops])
sab.10.rel.B <- sab.bssm.mod.input %>% dplyr::filter(year %in% years) %>% dplyr::select(I,year)
sab.10.rel.f <- left_join(sab.10.removals,sab.10.rel.B,by='year')
sab.10.rel.f$rel.f <- sab.10.rel.f$Catch/sab.10.rel.f$I

bbn.20.removals <- data.frame(year= years,
                              Catch = colSums(bbn.20$obj$env$data$C*bbn.20$obj$env$data$area)[-drops])
bbn.20.rel.B <- bbn.bssm.mod.input %>% dplyr::filter(year %in% years) %>% dplyr::select(I,year)
bbn.20.rel.f <- left_join(bbn.20.removals,bbn.20.rel.B,by='year')
#bbn.20.rel.f$q.cor.I <- bbn.20.rel.f$I /0.33
bbn.20.rel.f$rel.f <- bbn.20.rel.f$Catch/bbn.20.rel.f$I

#saveRDS(sab.10.rel.f,"D:/Framework/SFA_25_26_2024/Model/Results/sable_rel_f_share.Rds")
# Now we want to get the model exploitation rate and the relative explotation rate in the same object to make plotting easy..
bbn.20.rel.f$mod.exploit <- c(F.bbn.20$exploit[F.bbn.10$year %in% 1994:2021],NA)
sab.10.rel.f$mod.exploit <- c(F.sab.10$exploit[F.sab.10$year %in% 1994:2021],NA)
# The correlation...
sab.rf.cor.test <- cor.test(x = sab.10.rel.f$rel.f,sab.10.rel.f$mod.exploit)
sab.rel.f.cor <- as.numeric(round(sab.rf.cor.test$estimate,digits=2))
# now bbn
bbn.rf.cor.test <- cor.test(x = bbn.20.rel.f$rel.f,bbn.20.rel.f$mod.exploit)
bbn.rel.f.cor <- as.numeric(round(bbn.rf.cor.test$estimate,digits=2))


# Summary of the models...

sab.10.prod.dat <- data.frame(Year = years,
                        B = sab.10$report$totB[-length(sab.10$report$totB)],
                        R = sab.10$report$totR, 
                        SSB = sab.10$report$totB[-length(sab.10$report$totB)] + sab.10$report$totR[],
                        m = sab.10$report$mean_m[-length(sab.10$report$mean_m)])

bbn.20.prod.dat <- data.frame(Year = years,
                        B = bbn.20$report$totB[-length(bbn.20$report$totB)],
                        R = bbn.20$report$totR, 
                        SSB = bbn.20$report$totB[-length(bbn.20$report$totB)] + sab.10$report$totR[],
                        m = bbn.20$report$mean_m[-length(bbn.20$report$mean_m)])


# Get the data for the Jessica Exploitation Plots
F.sab.10$delta.B <- F.bbn.20$delta.B <- NA
F.sab.10$delta.B.per <- F.bbn.20$delta.B.per <- NA
F.sab.10$SP <- F.bbn.20$SP <- NA
for(i in 2:(length(years)-1)) 
{
  F.sab.10$delta.B[i] <- F.sab.10$B[i] - F.sab.10$B[i-1]
  F.sab.10$delta.B.per[i] <- (F.sab.10$B[i] - F.sab.10$B[i-1])/ F.sab.10$B[i-1] * 100
  F.sab.10$SP[i] <-   F.sab.10$B[i] -  F.sab.10$B[i-1] +  F.sab.10$C[i-1]
}

for(i in 2:(length(years)-1)) 
{
  F.bbn.20$delta.B[i] <- F.bbn.20$B[i] - F.bbn.20$B[i-1]
  F.bbn.20$delta.B.per[i] <- (F.bbn.20$B[i] - F.bbn.20$B[i-1])/ F.bbn.20$B[i-1] * 100
  F.bbn.20$SP[i] <-   F.bbn.20$B[i] -  F.bbn.20$B[i-1] +  F.bbn.20$C[i-1]
}

# Fishery data comparisons...

sab.catch <- sab.fish |> fsubset(survey.year > 1993) 
sab.catch <- fsum(sab.catch$pro.repwt,g=sab.catch$survey.year)
sab.catch <- data.frame(year = names(sab.catch), 
                           tot.catch = sab.catch/1000,
                           model.catch = colSums(sab.10$obj$env$data$C*sab.10$obj$env$data$area)[-drops])
sab.catch$prop.in.survey <- 100*sab.catch$model.catch/sab.catch$tot.catch
sab.per.catch <- round(median(sab.catch$prop.in.survey,na.rm=T),digits=1)

bbn.catch <- bbn.fish |> fsubset(survey.year > 1993) 
bbn.catch <- fsum(bbn.catch$pro.repwt,g=bbn.catch$survey.year)
bbn.catch <- data.frame(year = names(bbn.catch), 
                           tot.catch = bbn.catch/1000,
                           model.catch = colSums(bbn.20$obj$env$data$C*bbn.20$obj$env$data$area)[-drops])
bbn.catch$prop.in.survey <- 100*bbn.catch$model.catch/bbn.catch$tot.catch
bbn.per.catch <- round(median(bbn.catch$prop.in.survey,na.rm=T),digits=1)

# Decision Tables.
# BSSM
sab.bssm.dt.delta.b <- round(sab.bssm.dt$`Biomass change (%)`[1],digits=0)
bbn.bssm.dt.delta.b <- round(bbn.bssm.dt$`Biomass change (%)`[bbn.dt$table$`Catch (tonnes)` == 0],digits=1)

# SEAM
sab.dt.delta.b <- round(sab.dt$table$`Biomass change (%)`[1],digits=0)
bbn.dt.delta.b <- round(bbn.dt$table$`Biomass change (%)`[bbn.dt$table$`Catch (tonnes)` == 0],digits=1)


```



<!-- Make the figures -->


```{r knoty, echo=F,include=F}
  bbn.knots <- length(bbn.mesh.20$knots$size)
  sab.knots <- length(sab.mesh.10$knots$size)
  NY <- length(years)
  
  matYear<-c(rep(c(years,(max(years)+1)),each=bbn.knots))
  matYear1<-c(rep(years,each=bbn.knots))
  knots<-rep(1:bbn.knots,NY+1)
  knots1<-rep(1:bbn.knots,NY)
  
  grid.gis <- bbn.grid.20$grid
  grid.gis$geometry <- grid.gis$geometry*1000
  st_crs(grid.gis) <- 32620
  # Now simplify the grid for the spatial plots...
  knot.gis <- aggregate(grid.gis, list(grid.gis$knotID), function(x) x[1])
  # Here's bbn...
  bbn.knot.plt <- ggplot(knot.gis) + geom_sf(aes(fill=as.factor(knotID))) + geom_sf_text(aes(label = knotID),size=10) + 
                                     scale_fill_viridis_d(begin = 0.3,end=0.8) + theme(legend.position = 'none')
  
  if(language == 'english') save_plot(filename = paste0(repo.loc,"Figures/BBn_knots_fig_20_knots.png"),bbn.knot.plt,base_width = 8,base_height = 6)
  if(language == 'french') save_plot(filename = paste0(repo.loc,"Figures/BBn_knots_fig_20_knots.png"),bbn.knot.plt,base_width = 8,base_height = 6)

  

  matYear<-c(rep(c(years,(max(years)+1)),each=sab.knots))
  matYear1<-c(rep(years,each=sab.knots))
  knots<-rep(1:sab.knots,NY+1)
  knots1<-rep(1:sab.knots,NY)
  
  grid.gis <- sab.grid.10$grid
  grid.gis$geometry <- grid.gis$geometry*1000
  st_crs(grid.gis) <- 32620
  # Now simplify the grid for the spatial plots...
  knot.gis <- aggregate(grid.gis, list(grid.gis$knotID), function(x) x[1])

  
  sab.knot.plt <- ggplot(knot.gis) + geom_sf(aes(fill=as.factor(knotID))) + geom_sf_text(aes(label = knotID),size=10) + 
                                     scale_fill_viridis_d(begin = 0.3,end=0.8) + theme(legend.position = 'none')
  
  if(language == 'english') save_plot(filename = paste0(repo.loc,"Figures/Sab_knots_fig_10_knots.png"),sab.knot.plt,base_width = 8,base_height = 6)
  if(language == 'french') save_plot(filename = paste0(repo.loc,"Figures/Dab_knots_fig_10_knots.png"),sab.knot.plt,base_width = 8,base_height = 6)
  
  # Make the alternative knot figs...
  
  matYear<-c(rep(c(years,(max(years)+1)),each=10))
  matYear1<-c(rep(years,each=10))
  knots<-rep(1:10,NY+1)
  knots1<-rep(1:10,NY)
  
  grid.gis <- bbn.grid.10$grid
  grid.gis$geometry <- grid.gis$geometry*1000
  st_crs(grid.gis) <- 32620
  # Now simplify the grid for the spatial plots...
  knot.gis <- aggregate(grid.gis, list(grid.gis$knotID), function(x) x[1])
  # Here's bbn...
  bbn.knot.10.plt <- ggplot(knot.gis) + geom_sf(aes(fill=as.factor(knotID))) + geom_sf_text(aes(label = knotID),size=10) + 
                                     scale_fill_viridis_d(begin = 0.3,end=0.8) + theme(legend.position = 'none')
  
  if(language == 'english') save_plot(filename = paste0(repo.loc,"Figures/BBn_knots_fig_10_knots.png"),bbn.knot.10.plt,base_width = 8,base_height = 6)
  if(language == 'french') save_plot(filename = paste0(repo.loc,"Figures/BBn_knots_fig_10_knots.png"),bbn.knot.10.plt,base_width = 8,base_height = 6)

  
  # Make the Sable 20 knot figure too...
  
  matYear<-c(rep(c(years,(max(years)+1)),each=20))
  matYear1<-c(rep(years,each=20))
  knots<-rep(1:20,NY+1)
  knots1<-rep(1:20,NY)
  
  grid.gis <- sab.grid.20$grid
  grid.gis$geometry <- grid.gis$geometry*1000
  st_crs(grid.gis) <- 32620
  # Now simplify the grid for the spatial plots...
  knot.gis <- aggregate(grid.gis, list(grid.gis$knotID), function(x) x[1])

  
  sab.knot.20.plt <- ggplot(knot.gis) + geom_sf(aes(fill=as.factor(knotID))) + geom_sf_text(aes(label = knotID),size=10) + 
                                     scale_fill_viridis_d(begin = 0.3,end=0.8) + theme(legend.position = 'none')
  
  if(language == 'english') save_plot(filename = paste0(repo.loc,"Figures/Sab_knots_fig_20_knots.png"),sab.knot.20.plt,base_width = 8,base_height = 6)
  if(language == 'french') save_plot(filename = paste0(repo.loc,"Figures/Dab_knots_fig_20_knots.png"),sab.knot.20.plt,base_width = 8,base_height = 6)
```
  
  
```{r catch-prior, echo=F,include=F}

prior <- data.frame(prior = dbeta(seq(0,1,by=0.01),20,40),x = seq(0,1,by=0.01)) 
# The mean for the paper text.
mn.prior <- round(mean(rbeta(1e5,20,40)),digits=2)
prior.fig <- ggplot(prior) + geom_line(aes(y=prior,x=x)) + xlab("Fully-recruited catchability")  + scale_y_continuous(name = "", labels=NULL,breaks = NULL)

if(language == 'english') save_plot(filename = paste0(repo.loc,"Figures/Catchability_distribution.png"),prior.fig,base_width = 8,base_height = 6)
if(language == 'french') save_plot(filename = paste0(repo.loc,"Figures/Catchability_distribution_fr.png"),prior.fig,base_width = 8,base_height = 6)

```


```{r sfa25-seam, echo=F,include=F, cache=T}

# Biomass
bm.ts.plot <- ggplot(pred.proc.sab.10$log_processes) + geom_line(aes(year,exp(log_B)/1000),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totB.LCI/1000,ymax=totB.UCI/1000,x=year),alpha=0.2,fill='darkblue',color='darkblue') + ylim(c(0,15)) + 
                                xlab("") + ylab("Fully Recruited Biomass (tonnes x 1000)") + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Biomass_time_series.png"),bm.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Biomass_time_series.png"),bm.ts.plot,base_width = 8,base_height = 6)

# Spatial biomass
#B
b.brk <- pretty(log(b.spat.sab.10$B))
b.lab <- signif(exp(b.brk),digits=2)

spatial.B.plot<- ggplot() + geom_sf(data=b.spat.sab.10 %>% dplyr::filter(Year != 2023),aes(fill=log(B)),color='grey')+
                            facet_wrap(~Year,ncol=5)+ 
                            #scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                            #scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                            scale_fill_viridis_c(breaks = b.brk, labels=b.lab,name="Biomass \nDensity \n(kg\U2022km\U207B\U00B2)",option = "A",begin=0.2) + 
                            theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_biomass.png"),spatial.B.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_biomass.png"),spatial.B.plot,base_width = 12,base_height = 16)

# Catchability

spatial.q.plot <- ggplot() + geom_sf(data=q.spat.sab.10,aes(fill=qI),col=NA)+
                             #scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                             #scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                             scale_fill_viridis_c(name="Ccatchability (qI)",option = "C",begin = 0.2,end =0.8) + 
                             theme(axis.text.x=element_text(angle=-45,hjust=0))
if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_catchability.png"),spatial.q.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_catchability.png"),spatial.q.plot,base_width = 8,base_height = 6)


# Recruit biomass
rec.ts.plot <- ggplot(pred.proc.sab.10$log_processes) + geom_line(aes(year,exp(log_R)/1000),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totR.LCI/1000,ymax=totR.UCI/1000,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Recruit Biomass (tonnes x 1000)") + ylim(c(0,1.9)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Recruit_time_series.png"),rec.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Recruit_time_series.png"),rec.ts.plot,base_width = 8,base_height = 6)


r.brk <- pretty(log(r.spat.sab.10$R))
r.lab <- signif(exp(r.brk),digits=2)
spatial.R.plot<-  ggplot() + geom_sf(data=r.spat.sab.10,aes(fill=log(R)),col='grey')+
                             facet_wrap(~Year,ncol=5)+ 
                             # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                             # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                             scale_fill_viridis_c(breaks = r.brk, labels = r.lab,name="Recruit \nDensity \n(kg\U2022km\U207B\U00B2)",end=0.8)+ 
                             theme(axis.text.x=element_text(angle=-45,hjust=0))
if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_recruits.png"),spatial.R.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/English/Sab_Spatial_recruits.png"),spatial.R.plot,base_width = 12,base_height = 16)

# Remove missing survey years


# Natural mortality time series...
mort.ts.plot <- ggplot(pred.proc.sab.10$log_processes) + geom_line(aes(year,exp(log_m)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=m.LCI,ymax=m.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Natural mortality (Instantaneous)") + ylim(c(0,1)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_nat_mort_time_series.png"),mort.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_nat_mort_time_series.png"),mort.ts.plot,base_width = 8,base_height = 6)


m.brk <- log(c(0.03,0.1,0.3,1))
#m.brk <- pretty(log(m.dat.plot$m))
m.lab <- signif(exp(m.brk),digits=2)

spatial.m.plot <-  ggplot() + geom_sf(data=m.spat.sab.10,aes(fill=log(m)),color='grey')+
                              facet_wrap(~Year,ncol=5)+
                              # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                              # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                              scale_fill_viridis_c(breaks = m.brk, labels = m.lab,name="Natural \nmortality \n(Instantaneous)",option = "B",direction =1,begin = 0.2,end=1) + theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_nm.png"),spatial.m.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_nm.png"),spatial.m.plot,base_width = 12,base_height = 16)

# Remove missing survey years

# Fishing mortality Time Series
exploit.plot <- ggplot(F.sab.10) + geom_line(aes(x=year,y=FM),linewidth = 1.5) + geom_ribbon(aes(ymin=exploit.LCI,ymax=exploit.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') +
                                   xlab("") + ylab("Fishing mortality (Instantaneous)") + ylim(c(0,0.06)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_fish_mort_time_series.png"),exploit.plot,base_width = 8,base_height = 6)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_fish_mort_time_series.png"),exploit.plot,base_width = 8,base_height = 6)


e.brk <- log(c(0.00015,0.001,0.005,0.02,0.08))
#e.brk <- pretty(log(F.dat.plot$exp.na))
e.lab <- signif(exp(e.brk),digits=2)

spatial.exploit.plot<- ggplot() + geom_sf(data=F.spat.sab.10,aes(fill=log(F.na)),color='grey') +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~Year,ncol=5) + scale_fill_viridis_c(breaks = e.brk,labels = e.lab,name="Fishing \nmortality \n(Instantaneous)",option = "D") + theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_FM.png"),spatial.exploit.plot,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_FM.png"),spatial.exploit.plot,base_width = 12,base_height = 16)

## 20 knots big 3 figures for comparison....

# Biomass
bm.20.ts.plot <- ggplot(pred.proc.sab.20$log_processes) + geom_line(aes(year,exp(log_B)/1000),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totB.LCI/1000,ymax=totB.UCI/1000,x=year),alpha=0.2,fill='darkblue',color='darkblue') + ylim(c(0,15)) + 
                                xlab("") + ylab("Fully Recruited Biomass (tonnes x 1000)") + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/English/Sab_Biomass_time_series.png"),bm.20.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/French/Sab_Biomass_time_series.png"),bm.20.ts.plot,base_width = 8,base_height = 6)

# Recruit biomass
rec.20.ts.plot <- ggplot(pred.proc.sab.20$log_processes) + geom_line(aes(year,exp(log_R)/1000),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totR.LCI/1000,ymax=totR.UCI/1000,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Recruit Biomass (tonnes x 1000)") + ylim(c(0,1.9)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/English/Sab_Recruit_time_series.png"),rec.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/French/Sab_Recruit_time_series.png"),rec.ts.plot,base_width = 8,base_height = 6)



# Natural mortality time series...
mort.20.ts.plot <- ggplot(pred.proc.sab.20$log_processes) + geom_line(aes(year,exp(log_m)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=m.LCI,ymax=m.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Natural mortality (Instantaneous)") + ylim(c(0,1)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/English/Sab_nat_mort_time_series.png"),mort.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/French/Sab_nat_mort_time_series.png"),mort.ts.plot,base_width = 8,base_height = 6)



```



<!-- Now BBn -->



```{r sfa26-seam, echo=F,include=T}

# Biomass
bm.ts.plot <- ggplot(pred.proc.bbn.20$log_processes) + geom_line(aes(year,exp(log_B)/1000),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totB.LCI/1000,ymax=totB.UCI/1000,x=year),alpha=0.2,fill='darkblue',color='darkblue') + ylim(c(0,31)) + 
                                xlab("") + ylab("Fully Recruited Biomass (tonnes x 1000)") + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Biomass_time_series.png"),bm.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Biomass_time_series.png"),bm.ts.plot,base_width = 8,base_height = 6)

# Spatial biomass
#B
b.brk <- pretty(log(b.spat.bbn.20$B))
b.lab <- signif(exp(b.brk),digits=2)

spatial.B.plot<- ggplot() + geom_sf(data=b.spat.bbn.20 %>% dplyr::filter(Year != 2023),aes(fill=log(B)),color='grey')+
                            facet_wrap(~Year,ncol=5)+ 
                            #scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                            #scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                            scale_fill_viridis_c(breaks = b.brk, labels=b.lab,name="Biomass \nDensity \n(kg\U2022km\U207B\U00B2)",option = "A",begin=0.2) + 
                            theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_biomass.png"),spatial.B.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_biomass.png"),spatial.B.plot,base_width = 12,base_height = 16)

# Catchability

spatial.q.plot <- ggplot() + geom_sf(data=q.spat.bbn.20,aes(fill=qI),col=NA)+
                             #scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                             #scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                             scale_fill_viridis_c(name="Ccatchability (qI)",option = "C",begin = 0.2,end =0.8) + 
                             theme(axis.text.x=element_text(angle=-45,hjust=0))
if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_catchability.png"),spatial.q.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_catchability.png"),spatial.q.plot,base_width = 8,base_height = 6)


# Recruit biomass
rec.ts.plot <- ggplot(pred.proc.bbn.20$log_processes) + geom_line(aes(year,exp(log_R)/1000),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totR.LCI/1000,ymax=totR.UCI/1000,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Recruit Biomass (tonnes x 1000)") + ylim(c(0,7)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Recruit_time_series.png"),rec.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Recruit_time_series.png"),rec.ts.plot,base_width = 8,base_height = 6)


r.brk <- pretty(log(r.spat.bbn.20$R))
r.lab <- signif(exp(r.brk),digits=2)
spatial.R.plot<-  ggplot() + geom_sf(data=r.spat.bbn.20,aes(fill=log(R)),col='grey')+
                             facet_wrap(~Year,ncol=5)+ 
                             # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                             # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                             scale_fill_viridis_c(breaks = r.brk, labels = r.lab,name="Recruit \nDensity \n(kg\U2022km\U207B\U00B2)",end=0.8)+ 
                             theme(axis.text.x=element_text(angle=-45,hjust=0))
if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_recruits.png"),spatial.R.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/French/BBn_Spatial_recruits.png"),spatial.R.plot,base_width = 12,base_height = 16)

# Remove missing survey years


# Natural mortality time series...
mort.ts.plot <- ggplot(pred.proc.bbn.20$log_processes) + geom_line(aes(year,exp(log_m)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=m.LCI,ymax=m.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Natural mortality (Instantaneous)") + ylim(c(0,0.35)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_nat_mort_time_series.png"),mort.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_nat_mort_time_series.png"),mort.ts.plot,base_width = 8,base_height = 6)


m.brk <- log(c(0.03,0.1,0.3,1))
#m.brk <- pretty(log(m.dat.plot$m))
m.lab <- signif(exp(m.brk),digits=2)

spatial.m.plot <-  ggplot() + geom_sf(data=m.spat.bbn.20,aes(fill=log(m)),color='grey')+
                              facet_wrap(~Year,ncol=5)+
                              # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                              # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                              scale_fill_viridis_c(breaks = m.brk, labels = m.lab,name="Natural \nmortality \n(Instantaneous)",option = "B",direction =1,begin = 0.2,end=1) + theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_nm.png"),spatial.m.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_nm.png"),spatial.m.plot,base_width = 12,base_height = 16)

# Remove missing survey years

# Fishing mortality Time Series
exploit.plot <- ggplot(F.bbn.20) + geom_line(aes(x=year,y=FM),linewidth = 1.5) + geom_ribbon(aes(ymin=exploit.LCI,ymax=exploit.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') +
                                   xlab("") + ylab("Fishing mortality (Instantaneous)") + ylim(c(0,0.3)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_fish_mort_time_series.png"),exploit.plot,base_width = 8,base_height = 6)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_fish_mort_time_series.png"),exploit.plot,base_width = 8,base_height = 6)


e.brk <- pretty(log(F.spat.bbn.20$F.na))
e.lab <- signif(exp(e.brk),digits=2)
spatial.exploit.plot<- ggplot() + geom_sf(data=F.spat.bbn.20,aes(fill=log(F.na)),color='grey') +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~Year,ncol=5) + scale_fill_viridis_c(breaks = e.brk,labels = e.lab,name="Fishing \nmortality \n(Instantaneous)",option = "D") + theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_fm.png"),spatial.exploit.plot,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_fm.png"),spatial.exploit.plot,base_width = 12,base_height = 16)


# 10 knot competition


# Biomass
bm.10.ts.plot <- ggplot(pred.proc.bbn.10$log_processes) + geom_line(aes(year,exp(log_B)/1000),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totB.LCI/1000,ymax=totB.UCI/1000,x=year),alpha=0.2,fill='darkblue',color='darkblue') + ylim(c(0,31)) + 
                                xlab("") + ylab("Fully Recruited Biomass (tonnes x 1000)") + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/English/BBn_Biomass_time_series.png"),bm.10.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/French/BBn_Biomass_time_series.png"),bm.10.ts.plot,base_width = 8,base_height = 6)


# Recruit biomass
rec.10.ts.plot <- ggplot(pred.proc.bbn.10$log_processes) + geom_line(aes(year,exp(log_R)/1000),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totR.LCI/1000,ymax=totR.UCI/1000,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Recruit Biomass (tonnes x 1000)") + ylim(c(0,7)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/English/BBn_Recruit_time_series.png"),rec.10.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/French/BBn_Recruit_time_series.png"),rec.10.ts.plot,base_width = 8,base_height = 6)



# Natural mortality time series...
mort.10.ts.plot <- ggplot(pred.proc.bbn.10$log_processes) + geom_line(aes(year,exp(log_m)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=m.LCI,ymax=m.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Natural mortality (Instantaneous)") + ylim(c(0,0.35)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/English/BBn_nat_mort_time_series.png"),mort.10.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/French/BBn_nat_mort_time_series.png"),mort.10.ts.plot,base_width = 8,base_height = 6)


```



<!-- Sable BSSM model results -->


```{r sfa25-bssm, echo=F,include=F}

p.bssm.bm <- ggplot(sab.bssm %>% dplyr::filter(term == "Biomass (tonnes)"), aes(x=year,y=med/1000)) + geom_line(linewidth=1.5,color='firebrick2') +
  geom_ribbon(aes(x=year,ymin=lci/1000,ymax=uci/1000),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Fully Recruited Biomass (tonnes x 1000)") + xlab("")  + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,11.5))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_Biomass.png"),p.bssm.bm,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_Biomass.png"),p.bssm.bm,base_width = 8,base_height = 6)

# Just the recruits

p.bssm.rec <- ggplot(sab.bssm %>% dplyr::filter(term == "Recruit Biomass (tonnes)"), aes(x=year,y=med/1000)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci/1000,ymax=uci/1000),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Recruit Biomass (tonnes x 1000)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,2.5))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_Recruits.png"),p.bssm.rec,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_Recruits.png"),p.bssm.rec,base_width = 8,base_height = 6)

# Natural mortality

p.bssm.nat.mort <- ggplot(sab.bssm %>% dplyr::filter(term == "FR Natural Mortality (90+ mm, instantaneous)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Natural Mortality (90+ mm, instantaneous)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,1.4))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_fr_nm.png"),p.bssm.nat.mort,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_fr_nm.png"),p.bssm.nat.mort,base_width = 8,base_height = 6)

p.bssm.rec.nat.mort <- ggplot(sab.bssm %>% dplyr::filter(term == "Recruit Natural Mortality (75-90 mm, instantaneous)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Natural Mortality (75-90 mm, instantaneous)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,1))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_rec_nm.png"),p.bssm.rec.nat.mort,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_rec_nm.png"),p.bssm.rec.nat.mort,base_width = 8,base_height = 6)

# Exploitation Rate

p.bssm.F <- ggplot(sab.bssm %>% dplyr::filter(term == "Fishing Mortality (instantaneous)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Fishing Mortality (instantaneous)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,0.08))


if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_fm.png"),p.bssm.F,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_fm.png"),p.bssm.F,base_width = 8,base_height = 6)

# BSSM catchability posterior and prior

p.bssm.q <- ggplot(sab.bssm.q,aes(x=q,after_stat(density))) + geom_histogram() + geom_line(data=prior,aes(y=prior,x=x)) + 
                                scale_x_continuous(name = "Catchability (q)", limits = c(0.1,0.7),breaks = seq(0,1,by=0.05)) + scale_y_continuous(name = "", labels=NULL,breaks = NULL) 

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_q.png"),p.bssm.q,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_q.png"),p.bssm.q,base_width = 8,base_height = 6)


```


<!-- # Now for BBn SS Model results# -->

```{r sfa26-bssm, echo=F,include=F}

p.bssm.bm <- ggplot(bbn.bssm %>% dplyr::filter(term == "Biomass (tonnes)"), aes(x=year,y=med/1000)) + geom_line(linewidth=1.5,color='firebrick2') +
  geom_ribbon(aes(x=year,ymin=lci/1000,ymax=uci/1000),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Fully Recruited Biomass (tonnes x 1000)") + xlab("")  + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,25))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_Biomass.png"),p.bssm.bm,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_Biomass.png"),p.bssm.bm,base_width = 8,base_height = 6)

# Just the recruits

p.bssm.rec <- ggplot(bbn.bssm %>% dplyr::filter(term == "Recruit Biomass (tonnes)"), aes(x=year,y=med/1000)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci/1000,ymax=uci/1000),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Recruit Biomass (tonnes x 1000)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,7))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_Recruits.png"),p.bssm.rec,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_Recruits.png"),p.bssm.rec,base_width = 8,base_height = 6)

# Natural mortality

p.bssm.nat.mort <- ggplot(bbn.bssm %>% dplyr::filter(term == "FR Natural Mortality (90+ mm, instantaneous)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Natural Mortality (90+ mm, instantaneous)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,0.9))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_fr_nm.png"),p.bssm.nat.mort,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_fr_nm.png"),p.bssm.nat.mort,base_width = 8,base_height = 6)

p.bssm.rec.nat.mort <- ggplot(bbn.bssm %>% dplyr::filter(term == "Recruit Natural Mortality (75-90 mm, instantaneous)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Natural Mortality (75-90 mm, instantaneous)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,3.3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_rec_nm.png"),p.bssm.rec.nat.mort,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_rec_nm.png"),p.bssm.rec.nat.mort,base_width = 8,base_height = 6)

# Exploitation Rate

p.bssm.F <- ggplot(bbn.bssm %>% dplyr::filter(term == "Fishing Mortality (instantaneous)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Fishing Mortality (instantaneous)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,0.4))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_fm.png"),p.bssm.F,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_fm.png"),p.bssm.F,base_width = 8,base_height = 6)

# BSSM catchability posterior and prior

p.bssm.q <- ggplot(bbn.bssm.q,aes(x=q,after_stat(density))) + geom_histogram() + geom_line(data=prior,aes(y=prior,x=x)) + 
                                scale_x_continuous(name = "Catchability (q)", limits = c(0.1,0.7),breaks = seq(0,1,by=0.05)) + scale_y_continuous(name = "", labels=NULL,breaks = NULL) 

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_q.png"),p.bssm.q,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_q.png"),p.bssm.q,base_width = 8,base_height = 6)
```

<!-- # Next up we have the error structure figures for SFA-25a -->

```{r sfa25-error-field, echo=F,include=F}
# FR biomass
p.B.rf<- ggplot() + geom_sf(data=sab.10.B.field,aes(fill=value,color=value)) +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~name,ncol=5) + 
                                  scale_fill_viridis_c(name="Process Error \nRandom Field",option = "D") + 
                                  scale_color_viridis_c(name="Process Error \nRandom Field",option = "D") + 
                                  theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_B_rf.png"),p.B.rf,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_B_rf.png"),p.B.rf,base_width = 12,base_height = 16)

# Recruits
p.R.rf<- ggplot() + geom_sf(data=sab.10.R.field,aes(fill=value,color=value)) +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~name,ncol=5) + 
                                  scale_fill_viridis_c(name="Recruit Biomass \nRandom Field",option = "D") + 
                                  scale_color_viridis_c(name="Recruit Biomass \nRandom Field",option = "D") + 
                                  theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_R_rf.png"),p.R.rf,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_R_rf.png"),p.R.rf,base_width = 12,base_height = 16)

# mortality
p.m.rf<- ggplot() + geom_sf(data=sab.10.m.field,aes(fill=value,color=value)) +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~name,ncol=5) + 
                                  scale_fill_viridis_c(name="Natural mortality \nRandom Field",option = "D") + 
                                  scale_color_viridis_c(name="Natural mortality \nRandom Field",option = "D") + 
                                  theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_m_rf.png"),p.m.rf,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_m_rf.png"),p.m.rf,base_width = 12,base_height = 16)

# A new figure summarizing the fully-recruited biomass "Process error"


sab.seam.pe<- ggplot(data=sab.med.pe.seam, aes(x=year,y=med)) + 
                                    geom_point() + 
                                    geom_line() + 
                                    geom_hline(yintercept=0,color='blue',linetype='dashed',size=2) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Median Process Error")
                                  

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_seam_median_pe.png"),sab.seam.pe,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_seam_median_pe.png"),sab.seam.pe,base_width = 12,base_height = 16)


```

<!-- Now BBn -->

```{r sfa26-error-field, echo=F,include=F}
# FR biomass
p.B.rf<- ggplot() + geom_sf(data=bbn.20.B.field,aes(fill=value,color=value)) +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~name,ncol=5) + 
                                  scale_fill_viridis_c(name="Process Error \nRandom Field",option = "D") + 
                                  scale_color_viridis_c(name="Process Error \nRandom Field",option = "D") + 
                                  theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_B_rf.png"),p.B.rf,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_B_rf.png"),p.B.rf,base_width = 12,base_height = 16)

# Recruits
p.R.rf<- ggplot() + geom_sf(data=bbn.20.R.field,aes(fill=value,color=value)) +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~name,ncol=5) + 
                                  scale_fill_viridis_c(name="Recruit Biomass \nRandom Field",option = "D") + 
                                  scale_color_viridis_c(name="Recruit Biomass \nRandom Field",option = "D") + 
                                  theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_R_rf.png"),p.R.rf,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_R_rf.png"),p.R.rf,base_width = 12,base_height = 16)

# mortality
p.m.rf<- ggplot() + geom_sf(data=bbn.20.m.field,aes(fill=value,color=value)) +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~name,ncol=5) + 
                                  scale_fill_viridis_c(name="Natural mortality \nRandom Field",option = "D") + 
                                  scale_color_viridis_c(name="Natural mortality \nRandom Field",option = "D") + 
                                  theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_m_rf.png"),p.m.rf,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_m_rf.png"),p.m.rf,base_width = 12,base_height = 16)



bbn.seam.pe<- ggplot(data=bbn.med.pe.seam, aes(x=year,y=med)) + 
                                    geom_point() + 
                                    geom_line() + 
                                    geom_hline(yintercept=0,color='blue',linetype='dashed',size=2) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Median Process Error")
                                  
if(language == 'english')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_seam_median_pe.png"),bbn.seam.pe,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_seam_median_pe.png"),bbn.seam.pe,base_width = 12,base_height = 16)

```




<!-- And  the retrospective figures, starting with SFA 25a -->

```{r sfa25-bssm-retros, echo=F,include=F}

cols <- c(rep('#005BBB',4),rep('firebrick2',4),rep('darkgrey',4),rep('#FFD500',3),'black')
points <- c(rep(21:24,4)) 
b.retro <- ggplot(data=retro.bssm.sab %>% dplyr::filter(years < 2015),aes(x= years, y = B/1000,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_line(data=retro.bssm.sab %>% dplyr::filter(years %in% 2016:2019),size=1)+
                                    geom_point(data=retro.bssm.sab %>% dplyr::filter(years %in% c(1994:2014,2016:2019,2021)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Fully-recruited biomass (tonnes x 1000)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/English/Sab_bssm_biomass_retro.png"),b.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/French/Sab_bssm_biomass_retro.png"),b.retro,base_width = 8,base_height = 6)


r.retro <- ggplot(data=retro.bssm.sab %>% dplyr::filter(years < 2015),aes(x= years, y = R/1000,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_line(data=retro.bssm.sab %>% dplyr::filter(years %in% 2016:2019),size=1)+
                                    geom_point(data=retro.bssm.sab %>% dplyr::filter(years %in% c(1994:2014,2016:2019,2021)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Recruit biomass (tonnes x 1000)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/English/Sab_bssm_recruit_retro.png"),r.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/French/Sab_bssm_recruit_retro.png"),r.retro,base_width = 8,base_height = 6)


m.retro <- ggplot(data=retro.bssm.sab %>% dplyr::filter(years < 2015),aes(x= years, y = m,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                  geom_line(size=1) + 
                                  geom_line(data=retro.bssm.sab %>% dplyr::filter(years %in% 2016:2019),size=1)+
                                  geom_point(data=retro.bssm.sab %>% dplyr::filter(years %in% c(1994:2014,2016:2019,2021)),size=3) + 
                                  scale_shape_manual("",values = points) + 
                                  scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                  scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                  ylab("Natural mortality (instantaneous)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/English/Sab_bssm_nm_retro.png"),m.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/French/Sab_bssm_nm_retro.png"),m.retro,base_width = 8,base_height = 6)



```


```{r sfa25-retros, echo=F,include=F}

cols <- c(rep('#005BBB',4),rep('firebrick2',4),rep('darkgrey',4),rep('#FFD500',3),'black')
points <- c(rep(21:24,4)) 
b.retro <- ggplot(data=retro.sab %>% dplyr::filter(years < 2015),aes(x= years, y = B/1000,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_line(data=retro.sab %>% dplyr::filter(years %in% 2016:2019),size=1)+
                                    geom_point(data=retro.sab %>% dplyr::filter(years %in% c(1994:2014,2016:2019,2021)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Fully-recruited biomass (tonnes x 1000)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/English/Sab_biomass_retro.png"),b.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/French/Sab_biomass_retro.png"),b.retro,base_width = 8,base_height = 6)


r.retro <- ggplot(data=retro.sab %>% dplyr::filter(years < 2015),aes(x= years, y = R/1000,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_line(data=retro.sab %>% dplyr::filter(years %in% 2016:2019),size=1)+
                                    geom_point(data=retro.sab %>% dplyr::filter(years %in% c(1994:2014,2016:2019,2021)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Recruit biomass (tonnes x 1000)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/English/Sab_recruit_retro.png"),r.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/French/Sab_recruit_retro.png"),r.retro,base_width = 8,base_height = 6)


m.retro <- ggplot(data=retro.sab %>% dplyr::filter(years < 2015),aes(x= years, y = m,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                  geom_line(size=1) + 
                                  geom_line(data=retro.sab %>% dplyr::filter(years %in% 2016:2019),size=1)+
                                  geom_point(data=retro.sab %>% dplyr::filter(years %in% c(1994:2014,2016:2019,2021)),size=3) + 
                                  scale_shape_manual("",values = points) + 
                                  scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                  scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                  ylab("Natural mortality (instantaneous)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/English/Sab_nm_retro.png"),m.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/French/Sab_nm_retro.png"),m.retro,base_width = 8,base_height = 6)



```

<!-- And maybe finally, the retros for SFA 26 -->


```{r sfa26-bssm-retros, echo=F,include=F}

cols <- c(rep('#005BBB',4),rep('firebrick2',4),rep('darkgrey',4),rep('#FFD500',4),'black')
points <- rep(21:24,5) 

b.retro <- ggplot(data=retro.bssm.bbn %>% dplyr::filter(years < 2020),aes(x= years, y = B/1000,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_point(data=retro.bssm.bbn %>% dplyr::filter(!years %in% c(2020,2022)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    #geom_line(data=base.trend,aes(x=years, y = B,color=retro.year),size=1) +
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Fully recruited biomass (tonnes x 1000)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/English/BBn_bssm_biomass_retro.png"),b.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/French/BBn_bssm_biomass_retro.png"),b.retro,base_width = 8,base_height = 6)



r.retro <- ggplot(data=retro.bssm.bbn %>% dplyr::filter(years < 2020),aes(x= years, y = R/1000,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_point(data=retro.bssm.bbn %>% dplyr::filter(!years %in% c(2020,2022)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    #geom_line(data=base.trend,aes(x=years, y = B,color=retro.year),size=1) +
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Recruited biomass (tonnes x 1000)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/English/BBn_bssm_recruit_retro.png"),r.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/French/BBn_bssm_recruit_retro.png"),r.retro,base_width = 8,base_height = 6)


m.retro <- ggplot(data=retro.bssm.bbn %>% dplyr::filter(years < 2020),aes(x= years, y = m,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_point(data=retro.bssm.bbn %>% dplyr::filter(!years %in% c(2020,2022)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    #geom_line(data=base.trend,aes(x=years, y = B,color=retro.year),size=1) +
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Natural mortality (instantaneous)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/English/BBn_bssm_nm_retro.png"),m.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/French/BBn_bssm_nm_retro.png"),m.retro,base_width = 8,base_height = 6)

```



```{r sfa26-retros, echo=F,include=F}

cols <- c(rep('#005BBB',4),rep('firebrick2',4),rep('darkgrey',4),rep('#FFD500',4),'black')
points <- rep(21:24,5) 

b.retro <- ggplot(data=retro.bbn %>% dplyr::filter(years < 2020),aes(x= years, y = B/1000,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_point(data=retro.bbn %>% dplyr::filter(!years %in% c(2020,2022)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    #geom_line(data=base.trend,aes(x=years, y = B,color=retro.year),size=1) +
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Fully recruited biomass (tonnes x 1000)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_biomass_retro.png"),b.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_biomass_retro.png"),b.retro,base_width = 8,base_height = 6)



r.retro <- ggplot(data=retro.bbn %>% dplyr::filter(years < 2020),aes(x= years, y = R/1000,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_point(data=retro.bbn %>% dplyr::filter(!years %in% c(2020,2022)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    #geom_line(data=base.trend,aes(x=years, y = B,color=retro.year),size=1) +
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Recruited biomass (tonnes x 1000)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_recruit_retro.png"),r.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_recruit_retro.png"),r.retro,base_width = 8,base_height = 6)


m.retro <- ggplot(data=retro.bbn %>% dplyr::filter(years < 2020),aes(x= years, y = m,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_point(data=retro.bbn %>% dplyr::filter(!years %in% c(2020,2022)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    #geom_line(data=base.trend,aes(x=years, y = B,color=retro.year),size=1) +
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Natural mortality (instantaneous)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_nm_retro.png"),m.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_nm_retro.png"),m.retro,base_width = 8,base_height = 6)

```

<!-- Relative F comparison -->

```{r rel-f-comp,echo=F,include=F}


sab.10.f.vs.rel.f <- ggplot(sab.10.rel.f,aes(x=mod.exploit,y=rel.f,label=substr(year,3,4))) + 
                            geom_text() + xlab("Modelled exploitation rate (proprotional)") + ylab("Relative F")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_rel_vs_mod_F.png"),
                                    sab.10.f.vs.rel.f,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_rel_vs_mod_F.png"),
                                   sab.10.f.vs.rel.f,base_width = 8,base_height = 6)

bbn.20.f.vs.rel.f <- ggplot(bbn.20.rel.f,aes(x=mod.exploit,y=rel.f,label=substr(year,3,4))) + 
                            geom_text() + xlab("Modelled exploitation rate (proprotional)") + ylab("Relative F")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_rel_vs_mod_F.png"),
                                    bbn.20.f.vs.rel.f,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_rel_vs_mod_F.png"),
                                   bbn.20.f.vs.rel.f,base_width = 8,base_height = 6)


```

<!-- Residuals -->

```{r resids-sfa25a,echo=F,include=F}

sab.I.resids.plt <- ggplot(sab.10.I.resids) + geom_point(aes(x=I.mod,y=residual)) + 
                                              facet_wrap(~knotID,scales='free_x') + 
                                               ylab("Raw resdiual") +
                                               scale_x_log10(name="Fitted Values (kg/sqkm)")


# sab.I.stan.resids.plt <- ggplot(sab.10.I.resids) + geom_point(aes(x=I.mod,y=stan.resid)) + 
#                                               #facet_wrap(~knotID) + 
#                                               xlab("") + ylab("Standardized residual") +
#                                                scale_x_log10(name="Fitted Values (kg/sqkm)")
# 
# sab.I.resids <- plot_grid(sab.I.resids.plt,sab.I.stan.resids.plt,nrow=2)


if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_I_resids.png"),
                                    sab.I.resids.plt,base_width = 8,base_height = 8)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_I_resids.png"),
                                   sab.I.resids.plt,base_width = 8,base_height = 8)

#Recruits
sab.IR.resids.plt <- ggplot(sab.10.IR.resids) + geom_point(aes(x=IR.mod,y=residual)) + 
                                               facet_wrap(~knotID,scales='free_x') + 
                                               ylab("Raw residual") +
                                               scale_x_log10(name="Fitted Values (kg/sqkm)")


# sab.IR.stan.resids.plt <- ggplot(sab.10.IR.resids) + geom_point(aes(x=IR.mod,y=stan.resid)) + 
#                                               #facet_wrap(~knotID) + 
#                                               xlab("") + ylab("Standardized residual") +
#                                                scale_x_log10(name="Fitted Values (kg/sqkm)")
# 
# 
# sab.IR.resids <- plot_grid(sab.IR.resids.plt,sab.IR.stan.resids.plt,nrow=2)


if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_IR_resids.png"),
                                    sab.IR.resids.plt,base_width = 8,base_height = 8)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_IR_resids.png"),
                                   sab.IR.resids.plt,base_width = 8,base_height = 8)

# QQ plots...

sab.I.qq <- ggplot(sab.10.I.resids,aes(sample = residual)) + geom_qq() + geom_qq_line() + xlab("Theoretical") + ylab("Sample")
sab.I.dens <- ggplot(sab.10.I.resids,aes(x= I)) + geom_density() + ylab("Density") + scale_x_log10(name = "Observed survey fully-recruited biomass (tonnes)")
sab.I.qq.dens <- plot_grid(sab.I.qq,sab.I.dens,nrow=2)

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_I_qq.png"),
                                    sab.I.qq.dens,base_width = 8,base_height = 8)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_I_qq.png"),
                                   sab.I.qq.dens,base_width = 8,base_height = 8)

# and for recruits

sab.IR.qq <- ggplot(sab.10.I.resids,aes(sample = residual)) + geom_qq() + geom_qq_line() + xlab("Theoretical") + ylab("Sample")
sab.IR.dens <- ggplot(sab.10.I.resids,aes(x= I)) + geom_density() + ylab("Density") + scale_x_log10(name = "Observed survey recruit biomass (tonnes")
sab.IR.qq.dens <- plot_grid(sab.I.qq,sab.I.dens,nrow=2)

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_IR_qq.png"),
                                    sab.IR.qq.dens,base_width = 8,base_height = 8)

if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_IR_qq.png"),
                                   sab.IR.qq.dens,base_width = 8,base_height = 8)

#






# sab.L.resids.plt <- ggplot(sab.10.L.resids) + geom_point(aes(x=Year,y=residual)) + 
#                                               facet_wrap(~knotID,scales='free_y') + 
#                                                ylab("Raw residual (proportion)") +
#                                                scale_x_continuous(name="",breaks = seq(1980,2030,by=5))
# if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_nm_resid.png"),
#                                     sab.L.resids.plt,base_width = 8,base_height = 8)
# if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_nm_resid.png"),
#                                    sab.L.resids.plt,base_width = 8,base_height = 8)
# 
# 
# sab.L.stan.resids.plt <- ggplot(sab.10.L.resids) + geom_point(aes(x=Year,y=stan.resid)) + 
#                                               facet_wrap(~knotID,scales='free_y') + 
#                                               xlab("") + ylab("Standardized residual") +
#                                               scale_x_continuous(name="",breaks = seq(1980,2030,by=5))
# 
# if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_nm_stan_resid.png"),
#                                     sab.L.stan.resids.plt,base_width = 8,base_height = 8)
# if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_nm_stan_resid.png"),
#                                    sab.L.stan.resids.plt,base_width = 8,base_height = 8)


```


```{r resids-sfa26a,echo=F,include=F}


bbn.I.resids.plt <- ggplot(bbn.20.I.resids) + geom_point(aes(x=I.mod,y=residual)) + 
                                              facet_wrap(~knotID,scales = 'free_x') + 
                                               ylab("Raw residuals") +
                                                scale_x_log10(name="Fitted Values (kg/sqkm)")

# bbn.I.stan.resids.plt <- ggplot(bbn.20.I.resids) + geom_point(aes(x=I.mod,y=stan.resid)) + 
#                                               #facet_wrap(~knotID,scales = 'free_x') + 
#                                               xlab("") + ylab("Standardized residual") +
#                                                 scale_x_log10(name="Fitted Values (kg/sqkm)")
# 
# bbn.I.resids <- plot_grid(bbn.I.resids.plt,bbn.I.stan.resids.plt,nrow=2)

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_I_resids.png"),
                                    bbn.I.resids.plt,base_width = 8,base_height = 8)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_I_resids.png"),
                                   bbn.I.resids.plt,base_width = 8,base_height = 8)





bbn.IR.resids.plt <- ggplot(bbn.20.IR.resids) + geom_point(aes(x=IR.mod,y=residual)) + 
                                              facet_wrap(~knotID)+#,scales = 'free_x') + 
                                               ylab("Raw residuals") +
                                                scale_x_log10(name="Fitted Values (kg/sqkm)")

bbn.20.IR.resids$residual[which(bbn.20.IR.resids$IR.mod== min(bbn.20.IR.resids$IR.mod))]
# 
# bbn.IR.stan.resids.plt <- ggplot(bbn.20.IR.resids) + geom_point(aes(x=IR.mod,y=stan.resid)) + 
#                                               #facet_wrap(~knotID,scales = 'free_x') + 
#                                               xlab("") + ylab("Standardized residual") +
#                                                scale_x_log10(name="Fitted Values (kg/sqkm)")
# 
# 
# 
# bbn.IR.resids <- plot_grid(bbn.IR.resids.plt,bbn.IR.stan.resids.plt,nrow=2)

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_IR_resids.png"),
                                    bbn.IR.resids.plt,base_width = 8,base_height = 8)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_IR_resids.png"),
                                   bbn.IR.resids.plt,base_width = 8,base_height = 8)

# QQ plots...

bbn.I.qq <- ggplot(bbn.20.I.resids,aes(sample = residual)) + geom_qq() + geom_qq_line() + xlab("Theoretical") + ylab("Sample")
bbn.I.dens <- ggplot(bbn.20.I.resids,aes(x= I)) + geom_density() + ylab("Density") + scale_x_log10(name = "Observed survey fully-recruited biomass (tonnes)")
bbn.I.qq.dens <- plot_grid(bbn.I.qq,bbn.I.dens,nrow=2)

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_I_qq.png"),
                                    bbn.I.qq.dens,base_width = 8,base_height = 8)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_I_qq.png"),
                                   bbn.I.qq.dens,base_width = 8,base_height = 8)


# and for recruits

bbn.IR.qq <- ggplot(bbn.20.I.resids,aes(sample = residual)) + geom_qq() + geom_qq_line() + xlab("Theoretical") + ylab("Sample")
bbn.IR.dens <- ggplot(bbn.20.I.resids,aes(x= I)) + geom_density() + ylab("Density") + scale_x_log10(name = "Observed survey recruit biomass (tonnes")

bbn.IR.qq.dens <- plot_grid(bbn.I.qq,bbn.I.dens,nrow=2)

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_IR_qq.png"),
                                    bbn.IR.qq.dens,base_width = 8,base_height = 8)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_IR_qq.png"),
                                   bbn.IR.qq.dens,base_width = 8,base_height = 8)


# 
# bbn.L.resids.plt <- ggplot(bbn.20.L.resids) + geom_point(aes(x=Year,y=residual)) + 
#                                               facet_wrap(~knotID,scales='free_y') + 
#                                                ylab("Raw residual (proportion)") +
#                                                scale_x_continuous(name="",breaks = seq(1980,2030,by=5))
# 
# if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_nm_resid.png"),
#                                     bbn.L.resids.plt,base_width = 8,base_height = 8)
# if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_nm_resid.png"),
#                                    bbn.L.resids.plt,base_width = 8,base_height = 8)
# 
# bbn.L.stan.resids.plt <- ggplot(bbn.20.L.resids) + geom_point(aes(x=Year,y=stan.resid)) + 
#                                               facet_wrap(~knotID,scales='free_y') + 
#                                               xlab("") + ylab("Standardized residual") +
#                                                scale_x_continuous(name="",breaks = seq(1980,2030,by=5))
# 
# if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_nm_stan_resid.png"),
#                                     bbn.L.stan.resids.plt,base_width = 8,base_height = 8)
# if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_nm_stan_resid.png"),
#                                    bbn.L.stan.resids.plt,base_width = 8,base_height = 8)

```


```{r kobe-and-jem,echo=F,include=F}

# So here 2014 means the 2014-2015 explotation rate and the change in biomass from 2014-2015
sab.10.kobe.plt <- ggplot(F.sab.10,aes(x=B,y=exploit)) + geom_text(aes(label=substr(year-1,3,4))) +  xlim(c(0,NA)) +  ylim(c(0,NA)) +
                                    #annotate(geom="rect",xmin=0,xmax=5500,ymin=0.02,ymax=Inf, fill = "red", alpha=0.5)+
                                    #annotate(geom="rect",xmin=5500,xmax=Inf,ymin=0,ymax=0.02, fill="green", alpha = 0.5) +
                                    #annotate(geom="rect",xmin=0,xmax=5500,ymin=0,ymax=0.02, fill="gold1", alpha = 0.6) +
                                    #annotate(geom="rect",xmin=5500,xmax=Inf,ymin=0.02,ymax=Inf, fill="gold1", alpha = 0.6) +
                                    geom_path(aes(y= exploit, x= B )) + 
                                    xlab("Biomass (tonnes)") + ylab("Exploitation Rate (Proportional)") 
                                    #geom_hline(yintercept = 0.03,linetype='dashed') + geom_vline(xintercept = 4000,linetype='dashed')

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_kobe.png"),
                                    sab.10.kobe.plt,base_width = 8,base_height = 8)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_kobe.png"),
                                   sab.10.kobe.plt,base_width = 8,base_height = 8)


# So here 2014 means the 2014-2015 explotation rate and the change in biomass from 2014-2015
sab.10.jem.plt <- ggplot(F.sab.10,aes(y=delta.B.per,x=exploit)) + geom_text(aes(label=substr(year-1,3,4))) + geom_smooth(method='lm',color='blue',fill='blue',alpha=0.2) +
                                                              geom_hline(yintercept = 0,linetype='dashed')   +  
                                                              xlab("Exploitation Rate (Proportional)") + ylab("Biomass Change (%)")    

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_jem.png"),
                                    sab.10.jem.plt,base_width = 8,base_height = 8)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_jem.png"),
                                   sab.10.jem.plt,base_width = 8,base_height = 8)



# So here 2014 means the 2014-2015 explotation rate and the change in biomass from 2014-2015
bbn.20.kobe.plt <- ggplot(F.bbn.20,aes(x=B,y=exploit)) + geom_text(aes(label=substr(year-1,3,4))) +  xlim(c(0,NA)) + ylim(c(0,NA)) +
                                    #annotate(geom="rect",xmin=0,xmax=5500,ymin=0.02,ymax=Inf, fill = "red", alpha=0.5)+
                                    #annotate(geom="rect",xmin=5500,xmax=Inf,ymin=0,ymax=0.02, fill="green", alpha = 0.5) +
                                    #annotate(geom="rect",xmin=0,xmax=5500,ymin=0,ymax=0.02, fill="gold1", alpha = 0.6) +
                                    #annotate(geom="rect",xmin=5500,xmax=Inf,ymin=0.02,ymax=Inf, fill="gold1", alpha = 0.6) +
                                    geom_path(aes(y= exploit, x= B )) + 
                                    xlab("Biomass (tonnes)") + ylab("Exploitation Rate (Proportional)") 
                                    #geom_hline(yintercept = 0.03,linetype='dashed') + geom_vline(xintercept = 4000,linetype='dashed')

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_kobe.png"),
                                    bbn.20.kobe.plt,base_width = 8,base_height = 8)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_kobe.png"),
                                   bbn.20.kobe.plt,base_width = 8,base_height = 8)

# So here 2014 means the 2014-2015 explotation rate and the change in biomass from 2014-2015
bbn.20.jem.plt <- ggplot(F.bbn.20,aes(y=delta.B.per,x=exploit)) + geom_text(aes(label=substr(year-1,3,4))) + geom_smooth(method='lm',color='blue',fill='blue',alpha=0.2) +
                                                              geom_hline(yintercept = 0,linetype='dashed')   +  
                                                              xlab("Exploitation Rate (Proportional)") + ylab("Biomass Change (%)")   
if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_jem.png"),
                                    bbn.20.jem.plt,base_width = 8,base_height = 8)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_jem.png"),
                                   bbn.20.jem.plt,base_width = 8,base_height = 8)


```

```{r bssm-vs-seam,echo=F,include=F}

sab.bssm.bm <- sab.bssm %>% dplyr::filter(term == "Biomass (tonnes)")
sab.bssm.rec <- sab.bssm %>% dplyr::filter(term == "Recruit Biomass (tonnes)")
sab.bssm.nm.fr <- sab.bssm %>% dplyr::filter(term == "FR Natural Mortality (90+ mm, instantaneous)")
sab.bssm.nm.rec <- sab.bssm %>% dplyr::filter(term == "Recruit Natural Mortality (75-90 mm, instantaneous)")
sab.bssm.fm <- sab.bssm %>% dplyr::filter(term == "Fishing Mortality (instantaneous)")



bbn.bssm.bm <- bbn.bssm %>% dplyr::filter(term == "Biomass (tonnes)")
bbn.bssm.rec <- bbn.bssm %>% dplyr::filter(term == "Recruit Biomass (tonnes)")
bbn.bssm.nm.fr <- bbn.bssm %>% dplyr::filter(term == "FR Natural Mortality (90+ mm, instantaneous)")
bbn.bssm.nm.rec <- bbn.bssm %>% dplyr::filter(term == "Recruit Natural Mortality (75-90 mm, instantaneous)")
bbn.bssm.fm <- bbn.bssm %>% dplyr::filter(term == "Fishing Mortality (instantaneous)")

sab.seam <- pred.proc.sab.10$log_processes
bbn.seam <- pred.proc.bbn.20$log_processes

bm.bssm.seam.sab <- ggplot() +geom_line(data=sab.bssm.bm, aes(x=year,y=med/1000),linewidth=1.5,color='darkblue') +
                              geom_ribbon(data=sab.bssm.bm,aes(x=year,ymin=lci/1000,ymax=uci/1000),fill='darkblue',alpha = 0.2) + 
                              geom_line(data = sab.seam, aes(year,exp(log_B)/1000),linewidth=1.5,color='firebrick2') +
                              geom_ribbon(data = sab.seam,aes(x=year,ymin=totB.LCI/1000,ymax=totB.UCI/1000),fill='firebrick2',alpha = 0.2) + 
                              ylab("Fully Recruited Biomass (tonnes x 1000)") + xlab("")  + 
                              scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,15))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_bssm_seam_bm.png"),
                                    bm.bssm.seam.sab,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_bssm_seam_bm.png"),
                                   bm.bssm.seam.sab,base_width = 8,base_height = 6)

rec.bssm.seam.sab <- ggplot() +geom_line(data=sab.bssm.rec, aes(x=year,y=med/1000),linewidth=1.5,color='darkblue') +
                               geom_ribbon(data=sab.bssm.rec,aes(x=year,ymin=lci/1000,ymax=uci/1000),fill='darkblue',alpha = 0.2) + 
                               geom_line(data = sab.seam, aes(year,exp(log_R)/1000),linewidth=1.5,color='firebrick2') +
                               geom_ribbon(data = sab.seam,aes(x=year,ymin=totR.LCI/1000,ymax=totR.UCI/1000),fill='firebrick2',alpha = 0.2) + 
                               ylab("Recruit Biomass (tonnes x 1000)") + xlab("")  + 
                               scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,2.5))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_bssm_seam_rec.png"),
                                    rec.bssm.seam.sab,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_bssm_seam_rec.png"),
                                   rec.bssm.seam.sab,base_width = 8,base_height = 6)

nm.bssm.seam.sab <- ggplot() + geom_line(data=sab.bssm.nm.fr, aes(x=year,y=med),linewidth=1.5,color='darkblue') +
                               geom_ribbon(data=sab.bssm.nm.fr,aes(x=year,ymin=lci,ymax=uci),fill='darkblue',alpha = 0.2) + 
                               geom_line(data = sab.seam, aes(year,exp(log_m)),linewidth=1.5,color='firebrick2') +
                               geom_ribbon(data = sab.seam,aes(x=year,ymin=m.LCI,ymax=m.UCI),fill='firebrick2',alpha = 0.2) + 
                               ylab("Natural mortality (Instantaneous)") + xlab("")  + 
                               scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,1.5))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_bssm_seam_nm.png"),
                                    nm.bssm.seam.sab,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_bssm_seam_nm.png"),
                                   nm.bssm.seam.sab,base_width = 8,base_height = 6)


bm.bssm.seam.bbn <- ggplot() +geom_line(data=bbn.bssm.bm, aes(x=year,y=med/1000),linewidth=1.5,color='darkblue') +
                              geom_ribbon(data=bbn.bssm.bm,aes(x=year,ymin=lci/1000,ymax=uci/1000),fill='darkblue',alpha = 0.2) + 
                              geom_line(data = bbn.seam, aes(year,exp(log_B)/1000),linewidth=1.5,color='firebrick2') +
                              geom_ribbon(data = bbn.seam,aes(x=year,ymin=totB.LCI/1000,ymax=totB.UCI/1000),fill='firebrick2',alpha = 0.2) + 
                              ylab("Fully Recruited Biomass (tonnes x 1000)") + xlab("")  + 
                              scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,25))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_bssm_seam_bm.png"),
                                    bm.bssm.seam.bbn,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_bssm_seam_bm.png"),
                                   bm.bssm.seam.bbn,base_width = 8,base_height = 6)

rec.bssm.seam.bbn <- ggplot() +geom_line(data=bbn.bssm.rec, aes(x=year,y=med/1000),linewidth=1.5,color='darkblue') +
                               geom_ribbon(data=bbn.bssm.rec,aes(x=year,ymin=lci/1000,ymax=uci/1000),fill='darkblue',alpha = 0.2) + 
                               geom_line(data = bbn.seam, aes(year,exp(log_R)/1000),linewidth=1.5,color='firebrick2') +
                               geom_ribbon(data = bbn.seam,aes(x=year,ymin=totR.LCI/1000,ymax=totR.UCI/1000),fill='firebrick2',alpha = 0.2) + 
                               ylab("Recruit Biomass (tonnes x 1000)") + xlab("")  + 
                               scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,7))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_bssm_seam_rec.png"),
                                    rec.bssm.seam.bbn,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_bssm_seam_rec.png"),
                                   rec.bssm.seam.bbn,base_width = 8,base_height = 6)


nm.bssm.seam.bbn <- ggplot() + geom_line(data=bbn.bssm.nm.fr, aes(x=year,y=med),linewidth=1.5,color='darkblue') +
                               geom_ribbon(data=bbn.bssm.nm.fr,aes(x=year,ymin=lci,ymax=uci),fill='darkblue',alpha = 0.2) + 
                               geom_line(data = bbn.seam, aes(year,exp(log_m)),linewidth=1.5,color='firebrick2') +
                               geom_ribbon(data = bbn.seam,aes(x=year,ymin=m.LCI,ymax=m.UCI),fill='firebrick2',alpha = 0.2) + 
                               ylab("Natural mortality (Instantaneous)") + xlab("")  + 
                               scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,0.9))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_bssm_seam_nm.png"),
                                    nm.bssm.seam.bbn,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_bssm_seam_nm.png"),
                                   nm.bssm.seam.bbn,base_width = 8,base_height = 6)
```


```{r sfa25-bssm-pred-eval,echo=F,include=F}

liner <- c(1,2,1,1,2,1,2,2)
shaper <- rep(c(21,23,22,24),2)
sab.bssm.pred.eval$Method <- sab.bssm.pred.eval$scenario
sab.bssm.pred.eval$Method[sab.bssm.pred.eval$Method =='zp'] <- "Zero Productivity"
sab.bssm.pred.eval$Method[sab.bssm.pred.eval$Method =='normal'] <- "Previous Year"
sab.bssm.pred.eval$Method[sab.bssm.pred.eval$Method =='no fully-recruited growth'] <- "No FR Growth"
sab.bssm.pred.eval$Method[sab.bssm.pred.eval$Method =='no growth'] <- "No Growth"
sab.bssm.pred.eval <- sab.bssm.pred.eval |> fsubset(!year %in% c(2015,2016,2020,2021))

pe.tonnes.ts <- ggplot() + geom_line(data = sab.bssm.pred.eval |> fsubset(year < 2015), aes(x=year,y=B.diff/1000,group = Method,color=Method,linetype=Method),size=1.25) +                            #geom_line(data = sab.bssm.pred.eval %>% dplyr::filter(year %in% 2017:2019), 
                           #           aes(x=year,y=B.diff/1000,group = Method,color=Method,linetype=Method),size=1.25) + 
                           geom_point(data = sab.bssm.pred.eval,aes(x=year,y=B.diff/1000,group = Method,color=Method,fill=Method,shape =Method),size=2) + 
                           geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                           scale_color_viridis_d() + scale_fill_viridis_d() + 
                           scale_shape_manual(values = shaper) + scale_linetype_manual(values=liner) + 
                           scale_x_continuous(breaks = seq(1990,2024,by=2),labels=NULL) +
                           theme(plot.margin = margin(0,0.5,0,0.5, "cm"),legend.position = 'top') +
                           xlab("") + ylab("Predicted - Realized Biomass (tonnes x 1000)")


pe.per.ts <- ggplot() + geom_line(data = sab.bssm.pred.eval|> fsubset(year < 2015), aes(x=year,y=PB.diff,group = Method,color=Method,linetype=Method),size=1.25) +
                        # geom_line(data = sab.bssm.pred.eval %>% dplyr::filter(year %in% 2017:2019), 
                        #           aes(x=year,y=PB.diff,group = Method,color=Method,linetype=Method),size=1.25) + 
                        geom_point(data = sab.bssm.pred.eval ,aes(x=year,y=PB.diff,group = Method,color=Method,fill=Method,shape=Method),size=2) + 
                        geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                        scale_shape_manual(values = shaper) + scale_linetype_manual(values=liner) + 
                        scale_color_viridis_d() + scale_fill_viridis_d() + scale_x_continuous(breaks = seq(1990,2024,by=2)) +
                        theme(legend.position = 'none') +
                        xlab("") + ylab("Predicted - Realized Biomass (%)")

sab.pe.ts <- plot_grid(pe.tonnes.ts,pe.per.ts,ncol=1)


if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/English/Sab_bssm_PE_bm_ts_combo.png"),
                                    sab.pe.ts,base_width = 12,base_height = 15)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/French/Sab_bssm_PE_bm_ts_combo.png"),
                                   sab.pe.ts,base_width = 12,base_height = 15)



pe.biomass.abs <- ggplot(sab.bssm.pred.eval) + geom_violin(aes(x=Method,y=abs(B.diff)/1000),draw_quantiles = c(0.5)) + 
                                          ylab("|Biomass difference| (tonnes x 1000)")+ geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                          scale_x_discrete(labels=NULL,name='') +
                                          theme(plot.margin = margin(0,0.5,0,1, "cm"))+
                                          scale_y_continuous(breaks=c(seq(0,10,by=2)))


pe.biomass.diff <- ggplot(sab.bssm.pred.eval) + geom_violin(aes(x=Method,y=B.diff/1000),draw_quantiles = c(0.5)) + 
                                            ylab("Biomass difference (tonnes x 1000)")+ geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                            scale_x_discrete(labels=NULL,name='') +
                                            theme(plot.margin = margin(0,0.5,0,1, "cm"))+
                                            scale_y_continuous(breaks=c(seq(-6,10,by=2)))


pe.biomass.per <- ggplot(sab.bssm.pred.eval) + geom_violin(aes(x=Method,y=PB.diff),draw_quantiles = c(0.5)) + 
                                          ylab("Biomass difference (%)") + geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                          scale_y_continuous(breaks=c(seq(-100,200,by=10)))

sab.pe.violin <- plot_grid(pe.biomass.abs,pe.biomass.diff,pe.biomass.per,ncol=1)

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/English/Sab_bssm_PE_biomass_violin.png"),
                                    sab.pe.violin,base_width = 15,base_height = 20)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/French/Sab_bssm_PE_biomass_violin.png"),
                                   sab.pe.violin,base_width = 15,base_height = 20)

```



```{r sfa25-pred-eval,echo=F,include=F}

liner <- c(1,2,1,1,2,1,2,2)
shaper <- rep(c(21,23,22,24),2)
sab.pred.eval$Method <- sab.pred.eval$Scenario
pe.tonnes.ts <- ggplot() + geom_line(data = sab.pred.eval |> fsubset(year < 2015) , aes(x=year,y=B.diff/1000,group = Method,color=Method,linetype=Method),size=1.25) + 
                           # geom_line(data = sab.pred.eval %>% dplyr::filter(year %in% 2017:2019), 
                           #           aes(x=year,y=B.diff/1000,group = Method,color=Method,linetype=Method),size=1.25) + 
                           geom_point(data = sab.pred.eval,aes(x=year,y=B.diff/1000,group = Method,color=Method,fill=Method,shape =Method),size=2) + 
                           geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                           scale_color_viridis_d() + scale_fill_viridis_d() + 
                           scale_shape_manual(values = shaper) + scale_linetype_manual(values=liner) + 
                           scale_x_continuous(breaks = seq(1990,2024,by=2),labels=NULL) +
                           theme(plot.margin = margin(0,0.5,0,0.5, "cm"),legend.position = 'top') +
                           xlab("") + ylab("Predicted - Realized Biomass (tonnes x 1000)")


pe.per.ts <- ggplot() + geom_line(data = sab.pred.eval|> fsubset(year < 2015),aes(x=year,y=Per.B.diff,group = Method,color=Method,linetype=Method),size=1.25) +
                        # geom_line(data = sab.pred.eval %>% dplyr::filter(year %in% 2017:2019), 
                        #           aes(x=year,y=Per.B.diff,group = Method,color=Method,linetype=Method),size=1.25) + 
                        geom_point(data = sab.pred.eval ,aes(x=year,y=Per.B.diff,group = Method,color=Method,fill=Method,shape=Method),size=2) + 
                        geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                        scale_shape_manual(values = shaper) + scale_linetype_manual(values=liner) + 
                        scale_color_viridis_d() + scale_fill_viridis_d() + scale_x_continuous(breaks = seq(1990,2024,by=2)) +
                        theme(legend.position = 'none') +
                        xlab("") + ylab("Predicted - Realized Biomass (%)")

sab.pe.ts <- plot_grid(pe.tonnes.ts,pe.per.ts,ncol=1)


if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/",mod.select,"_",scenario.10,"/English/Sab_PE_bm_ts_combo.png"),
                                    sab.pe.ts,base_width = 12,base_height = 15)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/",mod.select,"_",scenario.10,"/French/Sab_PE_bm_ts_combo.png"),
                                   sab.pe.ts,base_width = 12,base_height = 15)



pe.biomass.abs <- ggplot(sab.pred.eval) + geom_violin(aes(x=Method,y=B.diff.abs/1000),draw_quantiles = c(0.5)) + 
                                          ylab("|Biomass difference| (tonnes x 1000)")+ geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                          scale_x_discrete(labels=NULL,name='') +
                                          theme(plot.margin = margin(0,0.5,0,1, "cm"))+
                                          scale_y_continuous(breaks=c(seq(0,10,by=2)))


pe.biomass.diff <- ggplot(sab.pred.eval) + geom_violin(aes(x=Method,y=B.diff/1000),draw_quantiles = c(0.5)) + 
                                            ylab("Biomass difference (tonnes x 1000)")+ geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                            scale_x_discrete(labels=NULL,name='') +
                                            theme(plot.margin = margin(0,0.5,0,1, "cm"))+
                                            scale_y_continuous(breaks=c(seq(-6,10,by=2)))


pe.biomass.per <- ggplot(sab.pred.eval) + geom_violin(aes(x=Method,y=Per.B.diff),draw_quantiles = c(0.5)) + 
                                          ylab("Biomass difference (%)") + geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                          scale_y_continuous(breaks=c(seq(-100,200,by=10)))

sab.pe.violin <- plot_grid(pe.biomass.abs,pe.biomass.diff,pe.biomass.per,ncol=1)

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/",mod.select,"_",scenario.10,"/English/Sab_PE_biomass_violin.png"),
                                    sab.pe.violin,base_width = 15,base_height = 20)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/",mod.select,"_",scenario.10,"/French/Sab_PE_biomass_violin.png"),
                                   sab.pe.violin,base_width = 15,base_height = 20)

```



```{r sfa26-bssm-pred-eval,echo=F,include=F}

liner <- c(1,2,1,1,2,1,2,2)
shaper <- rep(c(21,23,22,24),2)
bbn.bssm.pred.eval$Method <- bbn.bssm.pred.eval$scenario
bbn.bssm.pred.eval$Method[bbn.bssm.pred.eval$Method =='zp'] <- "Zero Productivity"
bbn.bssm.pred.eval$Method[bbn.bssm.pred.eval$Method =='normal'] <- "Previous Year"
bbn.bssm.pred.eval$Method[bbn.bssm.pred.eval$Method =='no fully-recruited growth'] <- "No FR Growth"
bbn.bssm.pred.eval$Method[bbn.bssm.pred.eval$Method =='no growth'] <- "No Growth"
# Remove years it doesn't really count...
bbn.bssm.pred.eval <- bbn.bssm.pred.eval |> fsubset(!year %in% c(2020,2021))

pe.tonnes.ts <- ggplot() + geom_line(data = bbn.bssm.pred.eval|> fsubset(year < 2020),
                                     aes(x=year,y=B.diff/1000,group = Method,color=Method,linetype=Method),size=1.25) +
                                     geom_point(data = bbn.bssm.pred.eval,aes(x=year,y=B.diff/1000,
                                                                              group = Method,color=Method,fill=Method,shape =Method),size=2) + 
                                     geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                     scale_color_viridis_d() + scale_fill_viridis_d() + 
                                     scale_shape_manual(values = shaper) + scale_linetype_manual(values=liner) + 
                                     scale_x_continuous(breaks = seq(1990,2024,by=2),labels=NULL) +
                                     theme(plot.margin = margin(0,0.5,0,0.75, "cm"),legend.position = 'top') +
                                     xlab("") + ylab("Predicted - Realized Biomass (tonnes x 1000)")

pe.per.ts <- ggplot() + geom_line(data = bbn.bssm.pred.eval|> fsubset(year < 2020),aes(x=year,y=PB.diff,group = Method,color=Method,linetype=Method),size=1.25) +
                                  geom_point(data = bbn.bssm.pred.eval ,aes(x=year,y=PB.diff,group = Method,color=Method,fill=Method,shape=Method),size=2) + 
                                  geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                  scale_shape_manual(values = shaper) + scale_linetype_manual(values=liner) + 
                                  scale_color_viridis_d() + scale_fill_viridis_d() + scale_x_continuous(breaks = seq(1990,2024,by=2)) +
                                  theme(legend.position = 'none') +
                                  xlab("") + ylab("Predicted - Realized Biomass (%)")

bbn.pe.ts <- plot_grid(pe.tonnes.ts,pe.per.ts,ncol=1)


if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/English/BBn_bssm_PE_bm_ts_combo.png"),
                          bbn.pe.ts,base_width = 12,base_height = 15)

if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/French/BBn_bssm_PE_bm_ts_combo.png"),
                         bbn.pe.ts,base_width = 12,base_height = 15)



pe.biomass.abs <- ggplot(bbn.bssm.pred.eval) + geom_violin(aes(x=Method,y=abs(B.diff)/1000),draw_quantiles = c(0.5)) + 
                                          ylab("|Biomass difference| (tonnes x 1000)")+ geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                          scale_x_discrete(labels=NULL,name='') +
                                          theme(plot.margin = margin(0,0.5,0,0.9, "cm"))+
                                          scale_y_continuous(breaks=c(seq(0,10,by=2)))


pe.biomass.diff <- ggplot(bbn.bssm.pred.eval) + geom_violin(aes(x=Method,y=B.diff/1000),draw_quantiles = c(0.5)) + 
                                            ylab("Biomass difference (tonnes x 1000)")+ geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                            scale_x_discrete(labels=NULL,name='') +
                                            theme(plot.margin = margin(0,0.5,0,0.8, "cm"))+
                                            scale_y_continuous(breaks=c(seq(-6,10,by=2)))


pe.biomass.per <- ggplot(bbn.bssm.pred.eval) + geom_violin(aes(x=Method,y=PB.diff),draw_quantiles = c(0.5)) + 
                                          ylab("Biomass difference (%)") + geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                          scale_y_continuous(breaks=c(seq(-100,200,by=10)))


bbn.pe.violin <- plot_grid(pe.biomass.abs,pe.biomass.diff,pe.biomass.per,ncol=1)


if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/English/BBn_bssm_PE_biomass_violin.png"),
                                     bbn.pe.violin,base_width = 15,base_height = 20)

if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/French/BBn_bssm_PE_biomass_violin.png"),
                                   bbn.pe.violin,base_width = 15,base_height = 20)

```





```{r sfa26-pred-eval,echo=F,include=F}

liner <- c(1,2,1,1,2,1,2,2)
shaper <- rep(c(21,23,22,24),2)
bbn.pred.eval$Method <- bbn.pred.eval$Scenario
pe.tonnes.ts <- ggplot() + geom_line(data = bbn.pred.eval|> fsubset(year < 2020), aes(x=year,y=B.diff/1000,group = Method,color=Method,linetype=Method),size=1.25) + 
                                     geom_point(data = bbn.pred.eval,aes(x=year,y=B.diff/1000,group = Method,color=Method,fill=Method,shape =Method),size=2) + 
                                     geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                     scale_color_viridis_d() + scale_fill_viridis_d() + 
                                     scale_shape_manual(values = shaper) + scale_linetype_manual(values=liner) + 
                                     scale_x_continuous(breaks = seq(1990,2024,by=2),labels=NULL) +
                                     theme(plot.margin = margin(0,0.5,0,0.75, "cm"),legend.position = 'top') +
                                     xlab("") + ylab("Predicted - Realized Biomass (tonnes x 1000)")

pe.per.ts <- ggplot() + geom_line(data = bbn.pred.eval|> fsubset(year < 2020),aes(x=year,y=Per.B.diff,group = Method,color=Method,linetype=Method),size=1.25) +
                                  geom_point(data = bbn.pred.eval ,aes(x=year,y=Per.B.diff,group = Method,color=Method,fill=Method,shape=Method),size=2) + 
                                  geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                  scale_shape_manual(values = shaper) + scale_linetype_manual(values=liner) + 
                                  scale_color_viridis_d() + scale_fill_viridis_d() + scale_x_continuous(breaks = seq(1990,2024,by=2)) +
                                  theme(legend.position = 'none') +
                                  xlab("") + ylab("Predicted - Realized Biomass (%)")

bbn.pe.ts <- plot_grid(pe.tonnes.ts,pe.per.ts,ncol=1)


if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SEAM_",scenario.20,"_vary_q=TRUE/English/BBn_PE_bm_ts_combo.png"),
                          bbn.pe.ts,base_width = 12,base_height = 15)

if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SEAM_",scenario.20,"_vary_q=TRUE/French/BBn_PE_bm_ts_combo.png"),
                         bbn.pe.ts,base_width = 12,base_height = 15)



pe.biomass.abs <- ggplot(bbn.pred.eval) + geom_violin(aes(x=Method,y=B.diff.abs/1000),draw_quantiles = c(0.5)) + 
                                          ylab("|Biomass difference| (tonnes x 1000)")+ geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                          scale_x_discrete(labels=NULL,name='') +
                                          theme(plot.margin = margin(0,0.5,0,0.9, "cm"))+
                                          scale_y_continuous(breaks=c(seq(0,10,by=2)))


pe.biomass.diff <- ggplot(bbn.pred.eval) + geom_violin(aes(x=Method,y=B.diff/1000),draw_quantiles = c(0.5)) + 
                                            ylab("Biomass difference (tonnes x 1000)")+ geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                            scale_x_discrete(labels=NULL,name='') +
                                            theme(plot.margin = margin(0,0.5,0,0.8, "cm"))+
                                            scale_y_continuous(breaks=c(seq(-6,10,by=2)))


pe.biomass.per <- ggplot(bbn.pred.eval) + geom_violin(aes(x=Method,y=Per.B.diff),draw_quantiles = c(0.5)) + 
                                          ylab("Biomass difference (%)") + geom_hline(yintercept=0,color='#005BBB',linetype='dashed',size=1.5) +
                                          scale_y_continuous(breaks=c(seq(-100,200,by=10)))


bbn.pe.violin <- plot_grid(pe.biomass.abs,pe.biomass.diff,pe.biomass.per,ncol=1)


if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SEAM_",scenario.20,"_vary_q=TRUE/English/BBn_PE_biomass_violin.png"),
                                     bbn.pe.violin,base_width = 15,base_height = 20)

if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SEAM_",scenario.20,"_vary_q=TRUE/French/BBn_PE_biomass_violin.png"),
                                   bbn.pe.violin,base_width = 15,base_height = 20)

```

<!-- The process error and residuals for BSSM -->

```{r sab-pe-resids,echo=F,include=F}

sab.pe.res <- sab.bssm.pe.resids |> fsubset(type %in%  c("Raw process error (log)","Standardized process error"))
#Flip the sign so that it means the same as our process residuals, a positive value indicates that the Process model would be higher than the final model.
sab.pe.res[,c("LCI","median","UCI")] <- -sab.pe.res[,c("LCI","median","UCI")]
sab.I.res <- sab.bssm.pe.resids |> fsubset(type %in%  c("Fully-recruited biomass residual (log)","Standardized fully-recruited biomass residual"))
sab.IR.res <- sab.bssm.pe.resids |> fsubset(type %in%  c("Recruit biomass residual (log)", "Standardized recruited biomass residual"))
pe.raw <- ggplot(sab.pe.res) + geom_point(aes(x=year,y=-median)) +  geom_errorbar(aes(x=year,ymax=-UCI,ymin=-LCI),width=0) +
                               facet_wrap(~type,ncol=1,scales='free_y') + geom_hline(yintercept = 0,linetype='dashed',color = 'darkblue',linewidth=1) + ylab("Process error") + 
                                scale_x_continuous(breaks = seq(1992,2024,by=3),name='') 

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSmodel/English/Sab_bssm_process_error.png"),
                                     pe.raw,base_width = 6,base_height = 8)

if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/SSmodel/French/Sab_bssm_process_error.png"),
                                   pe.raw,base_width = 6,base_height = 8)

pe.I.res <- ggplot(sab.I.res) + geom_point(aes(x=fitted,y=median)) +  geom_errorbar(aes(x=fitted,ymax=UCI,ymin=LCI),width=0) +
                               facet_wrap(~type,ncol=1,scales='free_y') + geom_hline(yintercept = 0,linetype='dashed',color = 'darkblue',linewidth=1) + ylab("Residual") + 
                                 scale_x_log10(name='Fitted values') 

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSmodel/English/Sab_bssm_FR_resids.png"),
                                     pe.I.res,base_width = 6,base_height = 8)

if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/SSmodel/French/Sab_bssm_FR_resids.png"),
                                   pe.I.res,base_width = 6,base_height = 8)


pe.IR.res <- ggplot(sab.IR.res) + geom_point(aes(x=fitted,y=median)) +  geom_errorbar(aes(x=fitted,ymax=UCI,ymin=LCI),width=0) +
                               facet_wrap(~type,ncol=1,scales='free_y') + geom_hline(yintercept = 0,linetype='dashed',color = 'darkblue',linewidth=1) + ylab("Residual") + 
                                scale_x_log10(name='Fitted values') 

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSmodel/English/Sab_bssm_rec_resids.png"),
                                     pe.IR.res,base_width = 6,base_height = 8)

if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/SSmodel/French/Sab_bssm_rec_resids.png"),
                                   pe.IR.res,base_width = 6,base_height = 8)

```

```{r bbn-pe-resids,echo=F,include=F}

bbn.pe.res <- bbn.bssm.pe.resids |> fsubset(type %in%  c("Raw process error (log)","Standardized process error"))
#Flip the sign so that it means the same as our process residuals, a positive value indicates that the Process model would be higher than the final model output.
bbn.pe.res[,c("LCI","median","UCI")] <- -bbn.pe.res[,c("LCI","median","UCI")]
bbn.I.res <- bbn.bssm.pe.resids |> fsubset(type %in%  c("Fully-recruited biomass residual (log)","Standardized fully-recruited biomass residual"))
bbn.IR.res <- bbn.bssm.pe.resids |> fsubset(type %in%  c("Recruit biomass residual (log)", "Standardized recruited biomass residual"))
pe.raw <- ggplot(bbn.pe.res) + geom_point(aes(x=year,y=-median)) +  geom_errorbar(aes(x=year,ymax=-UCI,ymin=-LCI),width=0) +
                               facet_wrap(~type,ncol=1,scales='free_y') + geom_hline(yintercept = 0,linetype='dashed',color = 'darkblue',linewidth=1) + ylab("Process error") + 
                                scale_x_continuous(breaks = seq(1992,2024,by=3),name='') 

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSmodel/English/BBn_bssm_process_error.png"),
                                     pe.raw,base_width = 6,base_height = 8)

if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SSmodel/French/BBn_bssm_process_error.png"),
                                   pe.raw,base_width = 6,base_height = 8)

pe.I.res <- ggplot(bbn.I.res) + geom_point(aes(x=fitted,y=median)) +  geom_errorbar(aes(x=fitted,ymax=UCI,ymin=LCI),width=0) +
                               facet_wrap(~type,ncol=1,scales='free_y') + geom_hline(yintercept = 0,linetype='dashed',color = 'darkblue',linewidth=1) + ylab("Residual") + 
                                 scale_x_log10(name='Fitted values') 

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSmodel/English/BBn_bssm_FR_resids.png"),
                                     pe.I.res,base_width = 6,base_height = 8)

if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SSmodel/French/BBn_bssm_FR_resids.png"),
                                   pe.I.res,base_width = 6,base_height = 8)


pe.IR.res <- ggplot(bbn.IR.res) + geom_point(aes(x=fitted,y=median)) +  geom_errorbar(aes(x=fitted,ymax=UCI,ymin=LCI),width=0) +
                               facet_wrap(~type,ncol=1,scales='free_y') + geom_hline(yintercept = 0,linetype='dashed',color = 'darkblue',linewidth=1) + ylab("Residual") + 
                                scale_x_log10(name='Fitted values') 

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSmodel/English/BBn_bssm_rec_resids.png"),
                                     pe.IR.res,base_width = 6,base_height = 8)

if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SSmodel/French/BBn_bssm_rec_resids.png"),
                                   pe.IR.res,base_width = 6,base_height = 8)

```


<!-- Now we are off to the PEs, starting in SFA 25a -->

<!-- ```{r sfa25-PEs, echo=F,include=F} -->

<!-- # First the annual absolute and proportional PEs.... -->

<!-- p.res.abs.an <- ggplot(Bdiff.sab.10.y) + geom_line(aes(x=Year, y=PE/1000)) +  -->
<!--                                          scale_x_continuous(name="",breaks = seq(1980,2030,by=3),labels=NULL) + ylab("Fully-Recruited Biomass \nProcess error (tonnes x 1000)") + -->
<!--                                          theme(plot.margin = margin(0.25,0.25,0.25,0.4, "cm")) -->
<!-- p.res.per.an <- ggplot(Bdiff.sab.10.y) + geom_line(aes(x=Year, y=res.per)) + scale_x_continuous(name="",breaks = seq(1980,2030,by=3)) + ylab("Fully-Recruited Biomass \nProcess Error (%)") -->

<!-- p.res.annual <- plot_grid(p.res.abs.an,p.res.per.an,ncol=1) -->

<!-- if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_PE_time_series.png"),p.res.annual,base_width = 6,base_height = 8) -->
<!-- if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_PE_time_series.png"),p.res.annual,base_width = 6,base_height = 8) -->

<!-- # Now plot the PEs spatially -->


<!-- bd.brk <- pretty(Bdiff.sab.10$B.diff) -->
<!-- bd.lab <- bd.brk#signif(exp(b.brk),digits=2) -->

<!-- spatial.Bdiff.plot<- ggplot() + geom_sf(data=Bdiff.sab.10,aes(fill=B.diff/1000),color='grey')+ -->
<!--                                 facet_wrap(~Year,ncol=5)+  -->
<!--                                 # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) + -->
<!--                                 # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) + -->
<!--                                 scale_fill_distiller(type = 'div',breaks = bd.brk, labels=bd.lab, name="Process \nError \n(tonnes x 1000)",palette = "RdBu") +  -->
<!--                                 theme(axis.text.x=element_text(angle=-45,hjust=0)) -->
<!-- if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_PE.png"),spatial.Bdiff.plot,base_width = 12,base_height = 16) -->
<!-- if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_res.png"),spatial.Bdiff.plot,base_width = 12,base_height = 16) -->

<!-- pb.brk <- pretty(Bdiff.sab.10$B.per.diff) -->
<!-- pb.lab <- pb.brk#signif(exp(b.brk),digits=2) -->

<!-- spatial.Bdiff.per.plot<- ggplot() + geom_sf(data=Bdiff.sab.10,aes(fill=B.per.diff),color='grey')+ -->
<!--                                     facet_wrap(~Year,ncol=5)+  -->
<!--                                     # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) + -->
<!--                                     # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) + -->
<!--                                     scale_fill_distiller(type = 'div',breaks = pb.brk, labels=pb.lab, name="Process \nError \n(%)",palette = "RdBu") +  -->
<!--                                     theme(axis.text.x=element_text(angle=-45,hjust=0)) -->
<!-- if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_PE_per.png"),spatial.Bdiff.per.plot,base_width = 12,base_height = 16) -->
<!-- if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_PE_per.png"),spatial.Bdiff.per.plot,base_width = 12,base_height = 16) -->

<!-- ``` -->


<!-- <!-- Now moving to the 26a PEs.... --> -->


<!-- ```{r sfa26-PEs, echo=F,include=F} -->

<!-- # First the annual absolute and proportional PEs.... -->

<!-- p.res.abs.an <- ggplot(Bdiff.bbn.20.y) + geom_line(aes(x=Year, y=PE/1000)) +  -->
<!--                                          scale_x_continuous(name="",breaks = seq(1980,2030,by=3),labels=NULL) + ylab("Fully-Recruited Biomass \nProcess Error (tonnes x 1000)") + -->
<!--                                          theme(plot.margin = margin(0.25,0.25,0.25,0.4, "cm")) -->
<!-- p.res.per.an <- ggplot(Bdiff.bbn.20.y) + geom_line(aes(x=Year, y=res.per)) + scale_x_continuous(name="",breaks = seq(1980,2030,by=3)) + ylab("Fully-Recruited Biomass \nProcess Error (%)") -->

<!-- p.res.annual <- plot_grid(p.res.abs.an,p.res.per.an,ncol=1) -->

<!-- if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_PE_time_series.png"),p.res.annual,base_width = 6,base_height = 8) -->
<!-- if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_PE_time_series.png"),p.res.annual,base_width = 6,base_height = 8) -->

<!-- # Now plot the Process Errror spatially -->


<!-- bd.brk <- pretty(Bdiff.bbn.20$B.diff) -->
<!-- bd.lab <- bd.brk#signif(exp(b.brk),digits=2) -->

<!-- spatial.Bdiff.plot<- ggplot() + geom_sf(data=Bdiff.bbn.20,aes(fill=B.diff/1000),color='grey')+ -->
<!--                                 facet_wrap(~Year,ncol=5)+  -->
<!--                                 # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) + -->
<!--                                 # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) + -->
<!--                                 scale_fill_distiller(type = 'div',breaks = bd.brk, labels=bd.lab, name="Process \nError \n(tonnes x 1000)",palette = "RdBu") +  -->
<!--                                 theme(axis.text.x=element_text(angle=-45,hjust=0)) -->
<!-- if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_PE.png"),spatial.Bdiff.plot,base_width = 12,base_height = 16) -->
<!-- if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_PE.png"),spatial.Bdiff.plot,base_width = 12,base_height = 16) -->

<!-- pb.brk <- pretty(Bdiff.bbn.20$B.per.diff) -->
<!-- pb.lab <- pb.brk#signif(exp(b.brk),digits=2) -->

<!-- spatial.Bdiff.per.plot<- ggplot() + geom_sf(data=Bdiff.bbn.20,aes(fill=B.per.diff),color='grey')+ -->
<!--                                     facet_wrap(~Year,ncol=5)+  -->
<!--                                     # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) + -->
<!--                                     # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) + -->
<!--                                     scale_fill_distiller(type = 'div',breaks = pb.brk, labels=pb.lab, name="Process \nError \n(%)",palette = "RdBu") +  -->
<!--                                     theme(axis.text.x=element_text(angle=-45,hjust=0)) -->
<!-- if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_PE_per.png"),spatial.Bdiff.per.plot,base_width = 12,base_height = 16) -->
<!-- if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_PE.per.png"),spatial.Bdiff.per.plot,base_width = 12,base_height = 16) -->

<!-- ``` -->

<!--chapter:end:tmp-analysis.Rmd-->

# Introduction

The last full assessment for the Offshore Scallop fishery occurred in 2013, and focused on Scallop Fishing Area (SFA) 27A (Georges Bank) and SFA 26A [Browns Bank north, @hubleyGeorgesBankBrowns2014]. Annual Science Response Updates through the Canadian Science Advisory Secretariat for these two stocks have occurred since. However, the offshore scallop fishery consists of 9 stocks in total. The SFA 26 management unit also includes stocks in Browns Bank South (26B) and German Bank (26C), SFA 27 includes a Georges Bank 'b' (27B) stock, and SFA 25, known as the Eastern Scotian Shelf is split into SFA 25A, which includes the Sable (25A-Sab) and Middle Bank (25A-Mid) stocks, and the Banquereau stock in SFA 25B [see Table 2 in @keyserFrameworkDevelopmentScallop2020].

This research document focuses on the development of new stock assessment methodologies for the Sable Bank portion of SFA 25A (referred to as SFA 25A hereafter) and SFA 26A. A history of the survey and fishery in SFA 25, SFA 26, and SFA 27B can be found in @keyserFrameworkDevelopmentScallop2020. The primary fishing area within SFA 26 is SFA 26A, while the Sable Bank portion of SFA 25A has been the most consistently fished area within SFA 25 [@keyserFrameworkDevelopmentScallop2020]. A Bayesian State-Space Delay difference model (BSSM) has been used to assess the status of SFA 26A for over a decade [@jonsenGeorgesBankScallop2009; @hubleyGeorgesBankBrowns2014], but no analytical models have ever been developed for SFA 25A.

Here we develop a modified version of the BSSM proposed by @jonsenGeorgesBankScallop2009 for these two stocks. In addition, we evaluate the population dynamics of these two stocks using a Spatially Explicit Assessment Model (SEAM); this model takes advantage of advances in computing power and the development of new statistical methods while retaining the same conceptual delay-difference population dynamics framework [@mcdonaldExplicitIncorporationSpatial2021]. The biomass estimates from non-spatial delay difference models (e.g. BSSM) provide biased biomass estimates, this bias is related to the assumption that fishing effort is distributed evenly across the domain of a stock; simulation studies have shown SEAM effectively eliminates this bias [@mcdonaldExplicitIncorporationSpatial2021]. In addition, SEAM requires fewer assumptions than BSSM while providing a more detailed understanding of biomass, exploitation, natural mortality, and recruitment throughout the assessed area.

The objectives of this document are:

-   Develop stock assessment models for SFA 26A (Browns Bank north), and within the survey domain of the Sable Bank stock in SFA 25A
-   Compare the results a non-spatial Bayesian state space model (BSSM) to a Spatially Explicit Assessment Model (SEAM) for each of these stocks
-   Evaluate the performance of the models using diagnostics such as residuals, retrospective analyses, and one-year ahead predictions

# Population Models

## Delay-difference Model

Here we evaluate the application of two modified delay-difference models [@derisoHarvestingStrategiesParameter1980; @schnuteGeneralTheoryAnalysis1985;@smithImpactSurveyDesign2014], a non-spatial model (BSSM) and a spatial model (SEAM). These models have parameters for natural mortality, recruitment, and growth, the complexity of the population dynamics is intermediary between a fully age-structured model and a simple Surplus production model. The underlying model formulation of the Delay-difference model used here is:

\begin{align}
B_{t} = e^{-m_{fr}} g_{fr,t} (B_{t-1} - C_{t-1}) + e^{-m_{r}} g_{r,t} R_{t-1}
\end{align}

In this formulation, the fully-recruited biomass is $B$, natural mortality is $m$, growth is $g$, landings are $C$, the recruits are $R$, and the $t$ index represents the annual time step, which goes from 1 to the number of years in the model. Where applicable, fully-recruited scallop are given the subscript $fr$, while recruits have the subscript $r$. Based on an analysis that combined meat weight shell height, ageing, and port sampling data for the SFA 25A and SFA 26A stocks, recruit sized scallop are here defined to be 75-89 mm, and fully-recruited scallop are defined as being greater or equal to 90 mm [@keyserFrameworkDevelopmentScallop2020].

The landings used in the model align with the survey season. The surveys of SFA 25A and SFA 26A normally occur in mid-late May, thus the fishery data is summarized in terms of a survey year, from June to May of the following year. For example, the removals from June 2010 to May 2011 are identified as fishing year 2010 removals, in the above model formulation, these removals are subtracted from the biomass estimated in the May 2010 survey. The assumption implicit in this formulation is that all removals happen immediately after the survey occurs. The data for these models were from years 1994 to 2022. There was no survey in SFA 25A in 2015 or 2020, while in SFA 26A the 2015 survey was delayed until August and no survey occurred in 2020. The fishery data for SFA 26A in 2015 took into account the delay in the survey in this year. The landings within both SFA 25A and SFA 26A are subset to the survey domain, but fishery activity can occur outside of the survey areas. In SFA 25A, `r sab.per.catch`% of the landings for the area come from within the SFA 25A survey domain. In SFA 26A, on average `r bbn.per.catch`% of the landings comes from within the SFA 26A survey domain.

## Non-spatial Bayesian State Space Model (BSSM)

The Bayesian non-spatial state space model (BSSM) used here is based on @jonsenGeorgesBankScallop2009 with revisions to the framework shown in @hubleyGeorgesBankBrowns2014. The data inputs used for this model are fully-recruited biomass, recruit biomass, landings (meat weight), clapper (empty paired shells; representative of natural mortality) number, total number of scallop (clappers + live), fully-recruited growth, and recruit growth; all of which are calculated annually [@keyserFrameworkDevelopmentScallop2020]. The fully-recruited biomass, recruit biomass, clapper number, and total number of scallop are single stratified indices calculated for the whole bank [@keyserFrameworkDevelopmentScallop2020].

The original model formulation of BSSM included an index of catch per unit effort (CPUE) from fishery data [@jonsenGeorgesBankScallop2009; @hubleyGeorgesBankBrowns2014]. However, due to challenges with model convergence there was an undocumented change to the model that was implemented to the CPUE index component of the model [for original formulation see @jonsenGeorgesBankScallop2009; @hubleyGeorgesBankBrowns2014]. Changes in the dynamics of the fishery suggested that the CPUE index is not reflective of the status of the stock. The coefficient of variation (CV) of the CPUE term has been inflated since approximately 2012 to down-weight the influence of this term in the model. Here we have removed the fishery index from the model entirely. No other changes have been made to the BSSM model formulation found in @hubleyGeorgesBankBrowns2014.

Since the development of these models it has been observed that there are many more priors in these models that have not been fully documented [@yinIdentifiableStatespaceModels2019]. The undocumented priors are annual priors for both fully-recruit and recruit natural mortality, and recruit biomass:

\begin{align}
r_{t} \sim lognormal(0,1) \\
m_{fr,t} \sim lognormal(-2,2) \\
m_{r,t} \sim lognormal(-2,2)
\end{align}

Where $r$ is the recruit biomass estimate which has been scaled by a parameter $K$ and $m$ is the instantaneous natural mortality of recruit ($r$) and fully-recruited ($fr$) scallop. This results in three additional posteriors being estimated each year and results in a more highly parameterized model than previously documented. These priors are likely masking identifiability and estimability issues in the underlying model and may also result in complex interactions between a series of weakly informative priors that results in a highly constrained model [@yinIdentifiableStatespaceModels2019]. Here, for the BSSM model, the MCMC sampling was undertaken using 8 chains, 375,000 iterations, and a burn-in period of 300,000. The highest $\hat{r}$ values for any parameter were `r sab.rhat` and `r bbn.rhat` for SFA 25A and SFA 26A respectively, while the lowest effective sample sizes were `r sab.neff` (SFA 25A) and `r bbn.neff` (SFA 26A).

{=html}
<!-- 
Identifiability means you can't estimate a parameter given your data, no matter how much data you have.  Estimability is that you can't get a good estimate of a parameter given the amount of data you have, but if you had more 'years' (for example) of this data you may be able to estimate the parameter.
!-->

## Spatially Explicit Assessment Model (SEAM)

The Spatially Explicit Assessment Model (SEAM) retains the delay-difference framework and is based on a version of BSSM that required no priors [@yinIdentifiableStatespaceModels2019]. However, subsequent research has shown that knowledge of the catchability parameter is necessary to provide realistic estimates of biomass in these models [@mcdonaldExplicitIncorporationSpatial2021]. Simulation studies have provided evidence for a temporal bias in the biomass estimates when using a non-spatial delay difference model, this bias is driven by fishery removals being spread unevenly across space [@mcdonaldExplicitIncorporationSpatial2021]. These simulations indicated that SEAM could effectively deal with heterogeneous fishery removals and largely eliminated this bias [@mcdonaldExplicitIncorporationSpatial2021]. Fishery removals from the Offshore Scallop fishery are not homogeneous as the fishery tends to target areas with higher scallop biomass densities [@keithEvaluatingSocioeconomicConservation2020]. Simulation studies have also indicated that natural mortality and recruitment estimates from both the non-spatial and spatial models can be confounded, but this has no impact on the overall biomass estimates and the models provide a good estimate of the overall productivity of the system if catchability is parameterized properly [@mcdonaldExplicitIncorporationSpatial2021].

The data inputs for SEAM include the same variables used in BSSM. However, SEAM uses the data at the survey tow level rather than creating a summarized index for the entire model area each year, the one exception is for the growth terms which are identical to the growth terms used in BSSM and have no spatial component [@keyserFrameworkDevelopmentScallop2020]. As a result of this, SEAM requires the spatial location of the survey tows and fishery catch. Thus the survey related input data used in the SEAM model are the tow specific values for fully-recruited biomass, recruit biomass, clapper number, and total number of scallop. The fishery catch is spatially referenced based on the reported locations in logbook entries and have been recorded every 6 hours since 2009, before this the logbook entries were recorded once every 24 hours.

SEAM is a state-space model (as is BSSM) and is represented by two stochastic processes, $\pmb{X}_{s,t}, t= 1,...,T$ ($t$ is time in years) and $s = 1,...,S$ ($s$ is the spatial location); these represent an unobserved dynamic state process that represents the population dynamics in space (at locations $s$) and time (time steps $t$) and the observation process $\pmb{Y}_{s,t}$ which links the observations to the population dynamic process. A p-vector $\theta \in \Theta \subseteq \mathbb{R}^p$ is used to combine the model parameters, with fixed covariates indicated by $\pmb{z}_{s,t}$.

$\theta$ is vector of fixed effects while $\pmb{X}_{s,t}$ is a vector of random effects which are predicted from estimates of $\theta$. In years with data the underlying processes (fully-recruited biomass, recruit biomass, and natural mortality) are considered to be predicted, while years without data (e.g., 2020) are considered projections. In these projection years, the projections are obtained by moving the process equations forward one year. The projections represent the predicted mean and uncertainty.

The variables used in the model are combined into a joint likelihood $L(\cdot)$ and marginal log-likelihood $\mathcal{L}(\cdot)$.


\begin{align}
L(\theta,\pmb{Y}_{1:T} , \pmb{X}_{1:T} = \prod_{s=1}^S p(\pmb{Y}_{s,1}| 
    \pmb{X}_{s,1},\theta) \prod_{t=2}^T p(\pmb{Y}_{s,t}|\ \pmb{X}_{s,t},\theta) 
    \times p(\pmb{X}_{s,t} | \pmb{X}_{s,t-1},\theta)
\end{align}


\begin{align}
\mathcal{L}(\theta,\pmb{Y}_{1:S,1:T}) = log \int L(\theta,\pmb{Y}_{1:S,1:T},\pmb{X}_{1:S,1:T})d\pmb{X}_{1:S,1:T}
\end{align}

These high dimension integrals are solved using the Laplace approximation implemented within the TMB package in R, which has been shown to be computationally highly efficient without a loss of accuracy [@kristensenTMBAutomaticDifferentiation2016; @auger-methemSpatiotemporalModellingMarine2017].

The spatial Delay difference model formulation is


\begin{align}
B_{s,t} = (e^{-m_{s,t}} g_{fr,t} (B_{s,t-1} - C_{s,t-1}) + e^{-m_{s,t}} g_{r,t} R_{s,t-1}) e^{\Omega{^{B}_{s,t}}}
\end{align}

Here $B_{s,t}$ are the commercial biomass densities, $m_{s,t}$ are the instantaneous natural mortalities, $C_{s,t-1}$ are the commercial landings densities, $R_{s,t-1}$ are the recruit biomass densities, $g_{fr,t}$ is the fully-recruited growth rate, and $g_{r,t}$ is the recruit growth rate. The spatial field for fully-recruited biomass is $\Omega{^{B}_{s,t}}$; this field is modelled as a Gaussian Markov Random Field (GMRF) which simplifies to a mean zero multivariate normal distribution using a Stochastic Partial Differential Equation (SPDE). The covariance matrix uses a Matérn covariance function:


\begin{align}
Matérn(s,s') = \lambda^2 \frac{1}{\Gamma(\nu)2^{\nu-1}}(\psi d(s,s'))^\nu K_\nu(\psi d(s,s'))
\end{align}

Where $\lambda^2$ is the spatial variance, $\nu$ is the smoothness parameter and is set at 1, $\psi$ is the range parameter and gives an estimate of the range at which two points become uncorrelated, $\Gamma$ is the gamma function, $K$ is a Bessel function of the second kind, and d(s,s') is the Euclidean distance between locations $s$ and $s'$.

As the traditional Matern function assumes isotropy (i.e., the spatial decorrelation range is the same in all directions), a matrix $H^B$ is estimated alongside the Matern which allows for geometric anisotropy.

\begin{align}
\Sigma(s,s') = Matérn(\parallel H^B(s-s') \parallel)
\end{align}

The recruits and natural mortality are modeled as lognormal random walks that incorporate spatial autocorrelation via their error structures ($\Omega{^{R}_{s,t}}$ and $\Omega{^{m}_{s,t}}$) using GMRFs. For these fields the mean level has to be estimated in year 1.

\begin{align}
R_{s,t} = R_{s,t-1}e^{\Omega{^{R}_{s,t}}}
\end{align}


\begin{align}
m_{s,t} = m_{s,t-1}e^{\Omega{^{m}_{s,t}}}
\end{align}

The above process equations are linked to the observations through three equations.


\begin{align}
I_{i,s,t} | (I_{i,s,t} > 0) = \frac{q_{I(s)}B_{s,t}}{p_{I}} \epsilon_{i,s,t} \;,\; \epsilon_{i,s,t} \stackrel{Ind}{\sim} u\ell N(\sigma^{2}_{\epsilon})
\end{align}


\begin{align}
I^{R}_{i,s,t} | (I^{R}_{i,s,t}) >0 = \frac{q_{R} R_{s,t}} {p^{R}_{I}} \nu_{i,s,t} \;,\; \nu_{i,s,t} \stackrel{Ind}{\sim} u\ell N(\sigma^{2}_{\nu})
\end{align}


\begin{align}
L_{i,s,t} = Bin(n_{i,s,t} , m_{s,t}S)
\end{align}

The observed fully-recruited biomass ($I_{i,s,t}$) in tow $i$, location $s$, and year $t$ is linked to the actual unobserved fully-recruited biomass density $B_{s,t}$ scaled by the fully-recruited catchability ($q_{I(s)}$) and adjusted by the probability of capturing fully-recruited scallop ($p_I$). The error term ($\epsilon_{i,s,t}$) is lognormally distributed with a variance of $\sigma^{2}_{\epsilon}$. The $p_{I}$ term is used to account for tows with no fully-recruited scallop.

The observation equation for recruit scallop is analogous to the fully-recruited scallop observation equation, with recruit biomass represented by $I^{R}_{i,s,t}$, a non-spatial recruit catchability term $q_R$ and a probability of of capturing recruits ($p^{R}_{I}$) with an error term ($\nu_{i,s,t}$) that is lognormally distributed with a variance of $\sigma^{2}_{\nu}$. The $p^{R}_{I}$ term is used to account for tows with no recruit scallop.

The final observation equation links the number of clappers ($L_{i,s,t}$) to the instantaneous natural mortality ($m_{s,t}$) using a binomial model which is scaled by the catchability of the clappers ($S$). This clapper model is a simplification of the clapper model used in BSSM [@smithScallopProductionArea2002; @hubleyGeorgesBankBrowns2014]. The natural mortality of fully- recruited and recruit scallop was assumed to be the same (i.e. $M_{fr} = M_{r}$) for SEAM. Finally, the mean estimate for natural mortality in year one was set to 0.2.

### Knots

Instead of modelling the random fields at every location, knots are used as a piece-wise constant approximation which help to facilitate computation. The knot locations were determined using a $k$-means clustering algorithm [@mcdonaldExplicitIncorporationSpatial2021; @thorsonGeostatisticalDeltageneralizedLinear2015]. The clustering algorithm used the survey data to identify the optimal clustering patterns. For SFA 25A ten knots were chosen (Figure \@ref(fig:sfa-25a-knot-fig)), while for SFA 26A twenty knots were chosen (Figure \@ref(fig:sfa-26a-knot-fig)). For SFA 26A this results in an average of five tows within each knot in recent years, while in SFA 25A this results in 10 tows on average per knot (based on surveys with 100 tows). The number of knots used is a trade-off between spatial resolution and data availability [@mcdonaldExplicitIncorporationSpatial2021], fewer knots were used in SFA 25A due to the limited fishery catch in the area in several years. The impact of the number of knots on model output was assessed, but did not substantially change the results; the results for a 20 knot model for SFA 25A and a 10 knot model for SFA 26A can be found in Appendix \@ref(app:A).

## Catchability

For both SEAM and BSSM catchability needs to be informed. For SEAM this helps to minimize bias in the biomass estimates [@mcdonaldExplicitIncorporationSpatial2021], while in BSSM it is one of the many required priors. For all the models we used a $\beta(20,40)$ which is the same as the prior applied in the 26A stock assessment model (Figure \@ref(fig:catch-prior-fig), also see Figure 17 in @hubleyGeorgesBankBrowns2014).

For SEAM the fully- recruited catchability can vary at each knot or be fixed across the modelling domain. In the model used herein the fully-recruited catchability was allowed to vary at each knot. The recruit catchability is fixed across the model domain and was set to be `r mn.prior` (the mean of the beta distribution). A model in which fully-recruited catchability did not vary spatially was tested but had little impact on productivity parameters (natural mortality and recruitment) and overall biomass estimates, thus this model is not further discussed.

## Retrospecitve Analyses

For both SEAM and BSSM retrospective analyses were undertaken by sequentially removing one year of data, the retrospective analyses were undertaken using terminal years from 2005-2021. The retrospective metrics were calculated for fully-recruited biomass, recruit biomass, and natural mortality. Each retrospective model (e.g., the model run from 1994-2015) will be referred to as the *2015 retrospective model* and the estimates are compared to the model run to 2022 (referred to as the *Full model*).

The calculations for the retrospective metrics are similar for fully-recruited biomass, recruit biomass, and natural mortality; the equations used for the calculations using fully-recruited biomass are presented as an example.


\begin{align}
BD_{t,retro} = B_{tot,t,retro} - B_{tot,t,full}
\end{align}

Here $BD_{t,retro}$ is the difference between the retrospective model biomass in year $t$ ($B_{tot,t,retro}$) and the full model biomass in the same year ($B_{tot,t,full}$). The relative biomass difference $RBD_{t,retro}$ is calculated as


\begin{align}
RBD_{t,retro} = (B_{tot,t,retro} - B_{tot,t,full}) /  B_{tot,t,full}
\end{align}

A simple measure of retrospective model bias ($MR_{ny}$, known as Mohn's rho) can be calculated from $RBD_{t,retro}$ using different numbers of years ($ny$). Here we will calculate $MR_5$ using the most recent 5 years of data, and $MR_{all}$ using all the years [2005-2021, @mohnRetrospectiveProblemSequential1999].


\begin{align}
MR_{ny} =  \frac{\sum^{ny}_1 RBD_{t,retro}}{ny}
\end{align}

## Residuals

For SEAM we calculated conditionally independent residuals [@thygesenValidationEcologicalState2017] for the observed fully-recruited and recruit biomass using the observation equations and the fitted values in each knot. The survey tow observations for fully-recruited and recruit biomass are measured as a biomass density ($\frac{kg}{km^2}$). The $q$-corrected model fully-recruited biomass density used for the residual calculation, it is calculated as:


\begin{align}
FRD_{s,t} = BD_{s,t} \times q_{I(s)} / p_I
\end{align}

The q-corrected model recruit biomass density used for the residual calculation is:


\begin{align}
RD_{s,t} = RD_{s,t} \times q_{R} / p^{R}_{I}
\end{align}

<!-- The S-corrected natural mortality used for the residual calculation is: -->

<!-- \begin{align} -->

<!-- NM_{s,t} =  1-e^{-m_{s,t} \times S} -->

<!-- \end{align} -->

The residuals are then calculated as the difference between the log of each non-zero observation and the log q-corrected model estimates with the log-transformation bias correction at each knot in a year.


\begin{align}
R_{fr,s,t} =  log(I_{i,s,t}) - log(FRD_{s,t}) + \frac{\sigma^{2}_{\epsilon}}{2}
\end{align}


\begin{align}
R_{r,s,t} = log(IR_{i,s,t}) - log(FRD_{s,t} ) + \frac{\sigma^{2}_{\nu}}{2}
\end{align}

In BSSM the residuals for fully-recruited and recruit biomass were calculated directly in the model using each of the retained MCMC samples [@jonsenGeorgesBankScallop2009; @hubleyGeorgesBankBrowns2014]; these residuals are not conditionally independent. 

<!-- In BSSM the residuals for fully-recruited and recruit biomass were calculated directly in the model using each of the retained MCMC samples [@jonsenGeorgesBankScallop2009;@hubleyGeorgesBankBrowns2014]. Unlike the residuals in SEAM, the BSSM residuals are not true residuals as they are not conditionally independent [Cite Anders] -->

<!-- \begin{align} -->

<!-- R_{nm,s,t} = \frac{L_{i,s,t}}{N_{i,s,t}} - NM_{s,t} -->

<!-- \end{align} -->

<!-- where $N_{i,s,t}$ is the total number of scallop in tow $i$, knot $s$, year $t$. -->

## Process Error and Random Fields

The difference between the model fully-recruited biomass estimate and the fully-recruited biomass estimate from the process component of a model is referred to herein as the process error. For BSSM the process error is calculated within the model as the difference between the model output fully-recruited biomass estimate and the process model fully-recruited biomass estimate on the log scale. A standardized process error term is also calculated in BSSM by dividing by the process standard error, a negative value indicates a year in which the final model estimate was lower than the process equation fully-recruited biomass estimate.

In SEAM, the process error for fully-recruited biomass is represented through the random field $\Omega{^{B}_{s,t}}$, it also represents the log difference between the fully-recruited biomass and the process model fully-recruited biomass estimate, but is calculated at each knot in a year (and interpolated throughout the remained of the domain). A negative values indicates a knot in which the final model estimate was lower than the process equation fully-recruited biomass estimate. In addition to the process error random field, the random fields for recruit biomass $\Omega{^{r}_{s,t}}$ and natural mortality $\Omega{^{m}_{s,t}}$ are also presented.

## One-Year Ahead Projections and Decision Tables

The assessment process for modelled stocks requires a prediction of fully-recruited biomass in the upcoming year so that stock status can be ascertained, the projections are used to developed decision tables and provide science advice for the modelled scallop stocks in Fisheries and Oceans Canada (DFO) Maritimes Region [e.g., @hubleyGeorgesBankBrowns2014; @dfoStockStatusUpdate2023a]. Using the results from the retrospective analyses the one-year projection method can be used to compare to the actual biomass estimated from the model once the model data are available. For example, the 2010 model can be used to predict the fully-recruited biomass in 2011 (conditioned on the actual landings between June 2010 and May 2011). This one-year ahead projection can then be compared to the realized estimates of fully-recruited biomass estimates for 2011 from the 2011 model. This procedure is repeated for each year in which retrospective data are available.

For BSSM the default method used for the one-year ahead projections and decision tables in BSSM are unchanged from previously developed methods [@jonsenGeorgesBankScallop2009; @hubleyGeorgesBankBrowns2014]. We refer to this method as the *Previous year* method as the terminal year estimates of fully-recruited biomass, recruit biomass, growth terms, and natural mortality are used in combination with the expected removals in the upcoming year to predict the biomass in the following year. 

SEAM calculates the fully-recruited biomass for the one-year ahead projections at each knot with the projection year treated as a year with no data and no landings. The projection results obtained directly from SEAM are referred to as the *Spatial* method results. In addition to this *Spatial* method, we also developed simplified one-year projections using a non-spatial version of the process equation and the process parameters (i.e. fully-recruited biomass, recruit biomass, natural mortality, landings, and the growth terms) to estimate the fully-recruited biomass in the projection year ($PB_{fr,t+1}$):

\begin{align}
PB_{fr,t+1} = (e^{-m_{t}} g_{fr,t} (B_{fr,t} - C_{tot,t}) + e^{-m_{t}} g_{r,t} R_{tot,t}) 
\end{align}

By using the most recent year model estimates from SEAM for $m_{t}$, $R_{tot,t}$, $g_{fr,t}$, and $g_{r,t}$ this method is analogous to the default *Previous year* method used in BSSM.  
 
For both SEAM and BSSM, six additional non-spatial methods of projecting biomass forward were evaluated and compared. The *No fully-recruited growth* method set fully-recruited growth $g_{fr,t}$ to 1, and the *No growth* method set both $g_{fr,t}$ and recruit growth $g_{r,t}$ to 1, both of these methods used the most recent year model estimates for natural mortality $m_{t}$ and recruit biomass $R_{tot,t}$. The *Zero productivity* method set $R_{tot,t}$ and $m_{t}$ to 0, and both $g_{fr,t}$ and $g_{r,t}$ to 1. A *Median productivity* method used the time-series median for model estimates of $m_{t}$, $R_{tot,t}$, $g_{fr,t}$, and $g_{r,t}$ for the fully-recruited biomass projections. The *Median recruit* method used the median recruitment in the time series for $R_{tot,t}$, while using the most recent year model estimates for $m_{t}$, $g_{fr,t}$, and $g_{r,t}$.. The *Median mortality* method used the median natural mortality for $m_{t}$, while using the most recent year model estimates $R_{tot,t}$, $g_{fr,t}$, and $g_{r,t}$.

For the non-spatial projection methods developed for SEAM, uncertainty was propagated to the prediction year ($t+1$) for $B_{fr,t}$, $R_{tot, t}$, and $m_{t}$ using a log-normal distribution and the standard errors estimated for each productivity parameter in the terminal year from the model. For SEAM the methods in which $R_{tot, t}$, and $m_{t}$ are set to their median, the standard errors are also set to their medians. For each projection year evaluated using the non-spatial projection methods, 1 million realizations were run. For BSSM the realizations for the median scenarios simple use the median time series value. 

For scallop stocks in the DFO Maritimes Region, decision tables are used to provide science advice [e.g., @dfoStockStatusUpdate2023; @dfoStockStatusUpdate2023a; @dfoScallopPlacopectenMagellanicus2023]. These tables use the one year ahead projections from the most recent assessment model to provide fully-recruited biomass estimates using a range of landings scenarios. To further compare BSSM and SEAM, based on the results of the one-year ahead projection analysis, decision tables for the year 2023 were developed for SFA 25A and SFA 26A using the 2022 output using the *no growth* method.

# Results

## Non-Spatial Bayesian State Space Model (BSSM)

### SFA 25A

For BSSM, fully-recruited biomass was elevated throughout much of the first decade of the 2000s, it peaked at `r max.b.sab.bssm` tonnes (t) in `r max.b.sab.bssm.y` and has been in decline since 2008 with the lowest fully-recruited biomass observed (`r min.b.sab.bssm` t) in `r min.b.sab.bssm.y` (Figure \@ref(fig:sfa-25-bssm-bm-fig)). Recruit biomass was elevated throughout the early 2000s, it peaked in `r max.r.sab.bssm.y` at `r max.r.sab.bssm` t; recruit biomass has been relatively high since 2017 after a prolonged period of low recruit biomass (Figure \@ref(fig:sfa-25-bssm-rec-fig)). Natural mortality (instantaneous) in SFA 25A was highly variable, with several years experiencing natural mortality in excess of 0.2 (Figure \@ref(fig:sfa-25-bssm-fr-nm-fig) and Figure \@ref(fig:sfa-25-bssm-rec-nm-fig)). The years of high natural mortality were spasmodic without any discernible temporal pattern for fully-recruited scallop, while recruit natural mortality has been estimated to be relatively low (recruit median m = `r sab.last.10.rec.nm`) since 2011 (Figure \@ref(fig:sfa-25-bssm-fr-nm-fig) and Figure \@ref(fig:sfa-25-bssm-rec-nm-fig)). The catchability for the area was very similar to the catchability prior (median = `r sab.med.q`), indicating there was little information in the data to inform the catchability in BSSM in SFA 25A (Figure \@ref(fig:sfa-25-bssm-q-fig)). Fishing mortality has never exceeded `r max.sab.fm` and has been below `r max.recent.sab.fm` since 2007 (Figure \@ref(fig:sfa-25-bssm-fm-fig)). Additional model parameter estimates are provided in Table \@ref(tab:sfa-25-bssm-param-table).

### SFA 26A

For BSSM there was a five year period in the late 1990s and early 2000s in which the full-recruited biomass for the area was elevated (Figure \@ref(fig:sfa-26-bssm-bm-fig)). Fully-recruited biomass has generally declined since the maximum biomass observed (`r max.b.bbn.bssm` tonnes) in `r max.b.bbn.bssm.y` with the lowest biomass observed in `r min.b.bbn.bssm.y` (`r min.b.bbn.bssm` tonnes; Figure \@ref(fig:sfa-26-bssm-bm-fig)). Two large recruitment pulses were evident using BSSM, one in the late 1990s and early 2000s, and a second similarly sized recruitment event observed around 2010 (Figure \@ref(fig:sfa-26-bssm-rec-fig)). The natural mortality (instantaneous) estimates in SFA 26A tended to be relatively high, with several years experiencing natural mortality rates in excess of 0.2, although the natural mortality estimates have been low (fully-recruited median m = `r bbn.last.5.rec.nm`) since 2018 (Figure \@ref(fig:sfa-26-bssm-fr-nm-fig) and Figure \@ref(fig:sfa-26-bssm-rec-nm-fig)). The catchability estimate was `r bbn.med.q`, which was above the mean of catchability prior (Figure \@ref(fig:sfa-26-bssm-q-fig)). The maximum estimated fishing mortality in SFA 26A was `r max.bbn.fm` (Figure \@ref(fig:sfa-26-bssm-fm-fig)). Additional model parameter estimates are provided in Table \@ref(tab:sfa-26-bssm-param-table)

## Spatially Explicit Asssessment Model (SEAM)

### SFA 25A

The fully-recruited biomass estimates from SEAM indicated that biomass was elevated throughout much of the first decade of the 2000s (Figure \@ref(fig:sfa-25-bm-fig)). Fully-recruited biomass has been in decline since the maximum biomass was observed (`r max.b.sab` tonnes) in `r max.b.sab.y`, with the minimum biomass observed (`r min.b.sab` tonnes) in `r min.b.sab.y`, this decline occurred despite fishing mortality remaining low throughout this period (Figure \@ref(fig:sfa-25-fm-fig)). The southern and western portions of SFA 25A tended to have higher fully-recruited biomass densities than more northern areas until the early to mid-2010s, in more recent years this pattern reversed and the most southwestern knot frequently had the lowest biomass density observed (Figure \@ref(fig:sfa-25-spat-bm-fig)). The estimated catchability for fully-recruited scallop was highly variable throughout SFA 25A, ranging from `r min.q.sab` in the southwest to `r max.q.sab` in the northeast (Figure \@ref(fig:sfa-25-catchy-fig)).

The elevated fully-recruited biomass in the early 2000s was driven by a relatively large recruitment event which lasted from 2000 to 2006 (Figure \@ref(fig:sfa-25-rec-fig)). There was a slight increase in recruit biomass since 2018. Spatially, recruit biomass has tended to be higher in the the southwestern portion of the bank, this was most noticeable in the early 2000s and to a lesser extent since 2018 (Figure \@ref(fig:sfa-25-spat-rec-fig)). While the elevated recruit biomass resulted in elevated full-recruited biomass in the early 2000s, this has not been the case since 2018.

Natural mortality (proportional) in SFA 25A was highly variable, with several years experiencing instantaneous natural mortalities in excess of 0.2 (Figure \@ref(fig:sfa-25-nm-fig)). The years of high natural mortality were spasmodic without any discernible temporal pattern, though they do occasionally last for 2 years. The southern regions of SFA 25A tended to have a higher natural mortality than northern areas, especially in more recent years (Figure \@ref(fig:sfa-25-spat-nm-fig)). The regions with the highest natural mortalities were generally the areas with the highest recruit biomass densities (Figure \@ref(fig:sfa-25-spat-nm-fig) and Figure \@ref(fig:sfa-25-spat-bm-fig)). These results align with the observed shell height frequency figures for this area, which indicated scallop were growing to recruit sizes in relatively large numbers, but were disappearing before reaching fully-recruited size since approximately 2018 [see Figures 57 and 69, @keyserFrameworkDevelopmentScallop2020].

Fishing mortality (instantaneous) in SFA 25A has been relatively low throughout the history of the fishery, ranging between `r min.f.sab` and `r max.f.sab` (Figure \@ref(fig:sfa-25-fm-fig)). Fishing mortality was generally higher in the late 1990s and early 2000s, since this time fishing mortality has generally been in decline and fishing mortality in the last 2 years has been near 0 (Figure \@ref(fig:sfa-25-spat-fm-fig)). The fishing mortality in the northwest portion of the bank was relatively consistent until the late 2010s, while the number of unfished knots increased starting in the early 2010s (grey knots, Figure \@ref(fig:sfa-25-spat-fm-fig)).

The phase plot shows that the exploitation rate has remained low for SFA 25A throughout the time series, with some of the lowest exploitation rates occuring while fully-recruited biomass has declined over the last 15 years (Figure \@ref(fig:sfa-25-kobe-fig)). There was no relationship between the change in biomass and exploitation rate throughout the modelled period in SFA 25A (Figure \@ref(fig:sfa-25-jem-fig)). Finally, the modelled exploitation rate for SFA 25A was correlated ($\rho$= `r sab.rel.f.cor`, p \< 0.001) to the relative exploitation rate derived in @keyserFrameworkDevelopmentScallop2020 (Figure \@ref(fig:sfa-25-rel-f-fig)).

### SFA 26A

The fully-recruited biomass estimates from SEAM indicated a 5 year period in the late 1990s and early 2000s in which the biomass for the area was elevated (Figure \@ref(fig:sfa-26-bm-fig)). Fully-recruited biomass has generally declined since the maximum biomass observed (`r max.b.bbn` tonnes) in `r max.b.bbn.y` with the lowest biomass observed in `r min.b.bbn.y` (`r min.b.bbn` tonnes), there has been a slight increase in biomass since this time (Figure \@ref(fig:sfa-26-bm-fig)). Spatially, since the late 1990s the highest biomass densities were consistently observed in the northern portion of the bank, with high biomass densities also observed in the south-central portion of the bank (Figure \@ref(fig:sfa-26-spat-bm-fig)). The lowest catchabilities were observed in a band across the north-central portion of the bank, with catchabilities ranging between `r min.q.bbn` and `r max.q.bbn` throughout the model area (Figure \@ref(fig:sfa-26-catchy-fig)).

The elevated fully-recruited biomass in the late 1990s was driven by the largest recruitment event observed in SFA 26A between 1999-2002 (Figure \@ref(fig:sfa-26-rec-fig)). Approximately a decade later there was a relatively large recruitment event which was associated with a less pronounced increase in fully-recruited biomass starting in 2010. Recruit biomass has been consistently low for the last 10 years. The knots with the highest recruit biomass densities align both in time and space with the knots with high fully-recruited biomass, high recruit biomass densities were observed throughout the bank between 2000 and 2002 and again from 2009-2011 (Figure \@ref(fig:sfa-26-spat-rec-fig)). Between 2014 and 2016 more localized recruitment events were observed in the northern portion of the bank, these recruitment events have likely contributed to the relatively high biomass density in these cells in recent years, despite relatively high exploitation rates in these knots (Figure \@ref(fig:sfa-26-spat-rec-fig) and Figure \@ref(fig:sfa-26-spat-fm-fig)).

Natural mortality has been relatively low and stable in SFA 26A, with natural mortality varying between `r min.m.bbn` and `r max.m.bbn` (Figure \@ref(fig:sfa-26-nm-fig)). Natural mortality was somewhat higher between 1994 and 2002 and there was a small increase in natural mortality observed in the early and mid 2010s, but since 2018 natural mortality has been below average (Figure \@ref(fig:sfa-26-nm-fig)). No areas have consistently higher rates of natural mortality, in years in which natural mortality was elevated it tends to be higher throughout most of the model domain (Figure \@ref(fig:sfa-26-spat-nm-fig)).

Fishing mortality (instantaneous) has varied between `r min.f.bbn` and `r max.f.bbn` in SFA 26A (Figure \@ref(fig:sfa-26-fm-fig)). Fishing mortality has been below average since the highest observed fishing mortality in 2017, with the 2022 fishing mortality the lowest observed in over a decade. Spatially, fishing mortality tended to be somewhat higher in the northern most central portion of the bank with some knots in this area generally seeing some fishing (Figure \@ref(fig:sfa-26-spat-fm-fig)). Other areas tended to be fished more sporadically, with periods in which there was little to no fishing activity in a knot for 1-2 years (Figure \@ref(fig:sfa-26-spat-fm-fig)).

The phase plot shows that fully-recruited biomass declined whenever the exploitation rate was elevated and there has been little change in fully-recruited biomass since 2016 despite a great deal of variation in the exploitation rate (Figure \@ref(fig:sfa-26-kobe-fig)). The fully-recruited biomass has declined whenever the exploitation rate in SFA 26A exceeded approximately 10% (Figure \@ref(fig:sfa-26-jem-fig)). Finally, the modelled exploitation rate for SFA 26A was correlated ($\rho$= `r bbn.rel.f.cor`, p \< 0.001) to the relative exploitation rate derived in @keyserFrameworkDevelopmentScallop2020 (Figure \@ref(fig:sfa-26-rel-f-fig)).

## Process Error and Random Fields

### SFA 25A

The BSSM process error for the fully-recruited biomass in SFA 25A has generally been negative since 2005, this indicated that the process equation tended to over-estimate the fully-recruited biomass observed (Figure \@ref(fig:sfa-25-bssm-PE-ts-fig)). Similarly for SEAM, the process error random fields are generally skewed towards negative values (Figures \@ref(fig:sfa-25-rf-bm-fig) and \@ref(fig:sfa-25-med-seam-pe-fig)). The process error tends to be lower in the southeastern portion of the bank, especially in recent years, while the northeast and southwest tended to to be higher (Figure \@ref(fig:sfa-25-rf-bm-fig)). In any given year these patterns can be substantially different from these general trends (Figure \@ref(fig:sfa-25-rf-bm-fig)). 

The error trends for recruit biomass tends to be slightly higher in the southeastern portion of the bank in recent years. As with the fully-recruited error structure, there was substantial inter-annual variability in these patterns (Figure \@ref(fig:sfa-25-rf-rec-fig)). Similarly for natural mortality, the was a great deal of inter-annual variability in the patterns, but the southeastern portion of the bank often has higher values than other areas on the bank (Figure \@ref(fig:sfa-25-rf-nm-fig)). Other model parameters can be found in Table \@ref(tab:sfa-25-param-table).

### SFA 26A

The BSSM process error for the fully-recruited biomass in SFA 26A has been negative since 2010, this indicated that the process equation tended to over-estimate the fully-recruited biomass observed (Figure \@ref(fig:sfa-26-bssm-PE-ts-fig)). Similarly for SEAM, the process error random fields are skewed towards negative values (Figures \@ref(fig:sfa-26-rf-bm-fig) and \@ref(fig:sfa-26-med-seam-pe-fig)). The process error is quite variable between and within years and results no consistent spatial patterns in the field (Figure \@ref(fig:sfa-26-rf-bm-fig)).  

A lack of a consistent spatial structure was also evident in the recruit biomass random field (Figure \@ref(fig:sfa-26-rf-rec-fig)). For the natural mortality random field there is a more defined structure, with the central portion of the bank tending to have more inter-annual variability than the edges (Figure \@ref(fig:sfa-26-rf-nm-fig)). Other model parameters can be found in Table \@ref(tab:sfa-26-param-table).

### Model Residuals

In SFA 25A, the BSSM fully-recruited and recruit biomass residuals were quite variable, there was a slight trend in which the residuals were slightly more positive when the model estimated biomass was elevated (Figures \@ref(fig:sfa-25-bssm-resid-I-fig) - \@ref(fig:sfa-25-bssm-resid-IR-fig)). In SFA 26A, the BSSM fully-recruited and recruit biomass residuals were quite variable, for the recruit biomass residuals the residuals increase as the model estimated recruit biomass increased (Figures \@ref(fig:sfa-26-bssm-resid-I-fig) - \@ref(fig:sfa-26-bssm-resid-IR-fig)).

For SEAM in both SFA 25A and SFA 26A, the fully-recruited biomass residual variability was similar across the range of modelled fully-recruited biomass estimates. The variability of the recruit residuals did not change with increasing recruit biomass. (Figures \@ref(fig:sfa-25-resid-I-fig) - \@ref(fig:sfa-26-resid-IR-fig)). While difficult to see , there was some bias in the recruit residuals at lower recruit biomass as low residuals are less common than expected (Figures \@ref(fig:sfa-25-resid-IR-fig) and \@ref(fig:sfa-26-resid-IR-fig)). The residuals from SEAM for both stocks do deviate from normality as the distributions of the observations (on the log-scale) were left skewed (Figures \@ref(fig:sfa-25-resid-qq-I-fig) - \@ref(fig:sfa-26-resid-qq-IR-fig)).

<!--Natural mortality residuals can't be done by hand, would require new code in TMB #Similarly, the natural mortality.... -->

## Retrospective Analyses

### SFA 25A

The BSSM SFA 25A retrospective analysis indicated minimal retrospective bias for the fully-recruited biomass estimates, the 5 year Mohn's rho ($MR_5$) was `r mr.b.bssm.sab.5`, while the overall Mohn's rho ($MR_{all}$) was `r mr.b.bssm.sab.all` (Figure \@ref(fig:sfa-25-bssm-retro-bm-fig)). This biomass difference was positive in most years, indicating that the biomass estimates in the full model were lower than the terminal year biomass estimates for models with fewer years of data, since 2018 this pattern has been stronger than in most previous years (Table \@ref(tab:sfa-25-bssm-bias-table)).

For recruit biomass, $MR_5$ (`r mr.r.bssm.sab.5`) and $MR_{all}$ (`r mr.r.bssm.sab.all`) were also relatively low. This biomass difference was negative in most years, indicating that the recruit biomass estimates in the full model were higher than the terminal year biomass estimates for models with fewer years of data. However, since 2018 the differences have been positive and relatively large (Table \@ref(tab:sfa-25-bssm-bias-table) and Figure \@ref(fig:sfa-25-bssm-retro-rec-fig)).

The natural mortality retrospective patterns were larger than either of the biomass's, the $MR_5$ was `r mr.m.bssm.sab.5` while the $MR_{all}$ was `r mr.m.bssm.sab.all`. The natural mortality retrospective tends to be negative in most years, but this trend has reversed since 2019 (Table \@ref(tab:sfa-25-bssm-bias-table) and Figure \@ref(fig:sfa-25-bssm-retro-nm-fig)).

Similarly, the retrospective analysis for SEAM indicated relatively low bias in the fully-recruited biomass estimates, the 5 year Mohn's rho ($MR_5$) was `r mr.b.sab.5`, while the overall Mohn's rho ($MR_{all}$) was `r mr.b.sab.all` (Figure \@ref(fig:sfa-25-retro-bm-fig)). This biomass difference was negative in most years, indicating that the biomass estimates in the full model were higher than the terminal year biomass estimates for models with fewer years of data (Table \@ref(tab:sfa-25-bias-table)).

For recruit biomass, $MR_5$ (`r mr.r.sab.5`) and $MR_{all}$ (`r mr.r.sab.all`) were higher than for fully-recruited biomass. In the majority of years the biomass estimates from the full model were lower than the terminal year biomass estimates for models with fewer years of data (Table \@ref(tab:sfa-25-bias-table)). In addition, since 2003 the recruit biomass estimates from the full model were among the lowest observed of any of the models used in the retrospective analysis (Figure \@ref(fig:sfa-25-retro-rec-fig)).

The natural mortality retrospective patterns were more variable than either of the biomass's, the $MR_5$ was `r mr.m.sab.5` while the $MR_{all}$ was `r mr.m.sab.all`. This is, in large part, due to the variability of the metric with relatively large, usually negative, variability between years (Table \@ref(tab:sfa-25-bias-table) and Figure \@ref(fig:sfa-25-retro-nm-fig)).

### SFA 26A

The BSSM SFA 26A retrospective analysis also indicated minimal retrospective bias for the fully-recruited biomass estimates, although the estimates were higher in SFA 26A as the 5 year Mohn's rho ($MR_5$) was `r mr.b.bssm.bbn.5`, while the overall Mohn's rho ($MR_{all}$) was `r mr.b.bssm.bbn.all` (Figure \@ref(fig:sfa-26-bssm-retro-bm-fig)). The biomass difference was positive every year, indicating that the biomass estimates in the full model were lower than the terminal year biomass estimates for models with fewer years of data (Table \@ref(tab:sfa-26-bssm-bias-table)).

For recruit biomass $MR_5$ (`r mr.r.bssm.bbn.5`) and $MR_{all}$ (`r mr.r.bssm.bbn.all`) were also relatively low. The recruit biomass retro was always positive indicating that the recruit biomass estimates in the full model were lower than the terminal year biomass estimates for models with fewer years of data (Table \@ref(tab:sfa-26-bssm-bias-table) and Figure \@ref(fig:sfa-26-bssm-retro-rec-fig)).

The natural mortality retrospective patterns were larger than either of the biomass's, the $MR_5$ was `r mr.m.bssm.bbn.5` while the $MR_{all}$ was `r mr.m.bssm.bbn.all`. The natural mortality retrospective was negative in every year in the analysis (Table \@ref(tab:sfa-25-bssm-bias-table) and Figure \@ref(fig:sfa-25-bssm-retro-nm-fig)).

Similarly, the SEAM SFA 26A retrospective analysis indicated relatively low bias in the fully-recruited biomass estimates, the 5 year Mohn's rho ($MR_5$) was `r mr.b.bbn.5`, while the overall Mohn's rho ($MR_{all}$) was `r mr.b.bbn.all` (Figure \@ref(fig:sfa-26-retro-bm-fig)). This biomass difference has generally been positive since 2010, indicating that the biomass estimates in the full model were lower than the terminal year biomass estimates for models with fewer years of data during this period (Table \@ref(tab:sfa-26-bias-table)).

For recruit biomass $MR_5$ (`r mr.r.bbn.5`) and $MR_{all}$ (`r mr.r.bbn.all`) were higher than for fully-recruited biomass. In the majority of years the biomass estimates from the full model were lower than the terminal year biomass estimates for models with fewer years of data (Table \@ref(tab:sfa-26-bias-table)). In addition, the recruit biomass estimates from the full model were among the lowest observed of any of the models used in the retrospective analysis, with a trend towards lower recruit biomass estimates evident in the retrospective models since 2010 (Figure \@ref(fig:sfa-26-retro-rec-fig)).

The natural mortality retrospective analyses indicated that $MR_5$ was `r mr.m.bbn.5`, while the $MR_{all}$ was `r mr.m.bbn.all` , the natural mortality estimates from the full model area also among the lowest observed, with a general trend towards lower natural mortality estimates recently (Figure \@ref(fig:sfa-26-retro-nm-fig)). The similarity of the recruit biomass and natural mortality retrospective results was likely related to the difficulty of separating these two components of productivity [@mcdonaldExplicitIncorporationSpatial2021; @mcdonaldIncorporatingIntraannualVariability2022].

## Prediction Evaluations and Decision Tables

### SFA 25A

The prediction evaluations for BSSM indicated that the *previous year* method to project biomass one-year ahead tends to result in an over-estimate of fully-recruited biomass in the projection year (Figure \@ref(fig:sfa-25-bssm-pred-eval-ts-fig)). The *no growth* and *zero productivity* methods tended to provide the least biased fully-recruited biomass estimates (Figure \@ref(fig:sfa-25-bssm-pred-eval-violin-fig)). The BSSM decision tables using the *no growth* method indicated that in 2023 with no fishing the fully-recruited biomass in SFA 25A would likely increase by `r sab.bssm.dt.delta.b`% (Table \@ref(tab:sfa-25-bssm-dt)); the observed fully-recruited survey biomass index for 2023 (unpublished data) increased by approximately 16% from 2022.

For SEAM the projections tended to over-estimate the fully-recruited biomass in the projection year (Figure \@ref(fig:sfa-25-pred-eval-ts-fig)). The non-spatial projection methods tended to perform somewhat better, with the *no growth* and *zero surplus production* methods tending to provide the least biased fully-recruited biomass estimates (Figure \@ref(fig:sfa-25-pred-eval-violin-fig)). The SEAM decision tables using the *no growth* method indicated that in 2023 with no fishing the fully-recruited biomass in SFA 25A would likely increase by `r  sab.dt.delta.b`% (Table \@ref(tab:sfa-25-seam-dt)), close to the observed increase of 16%.

### SFA 26A

The prediction evaluations for BSSM indicated that the using the *previous year* method to project biomass one-year ahead tends to result in an over-estimate of fully-recruited biomass in the projection year (Figure \@ref(fig:sfa-26-bssm-pred-eval-ts-fig)). The *no growth* and *zero productivity* methods tended tends to provide the least biased fully-recruited biomass estimates (Figure \@ref(fig:sfa-26-bssm-pred-eval-violin-fig)). The BSSM decision tables using the *no growth* method indicated that in 2023 with no fishing the fully-recruited biomass in SFA 26A would likely decline by `r bbn.bssm.dt.delta.b`% (Table \@ref(tab:sfa-26-bssm-dt)); the latest stock assessment indicated an increase in fully-recruited biomass in 2023 of approximately 6% with landings of 227 tonnes (June 2022-May 2023); however, this biomass increase was attributed to a significant and unexpected increase in scallop condition in 2023 [@dfoStockStatusUpdate2024].

For SEAM the *spatial* method projections tended to over-estimate the fully-recruited biomass in the projection year (Figure \@ref(fig:sfa-26-pred-eval-ts-fig)). The *no growth* and *zero surplus production* methods again tended to provide the least biased fully-recruited biomass estimates (Figure \@ref(fig:sfa-26-pred-eval-violin-fig)). The decision tables using the *no growth* method indicated that in 2023 with no landings the fully-recruited biomass in SFA 26A would experience a very small increase of approximately `r bbn.dt.delta.b`% (Table \@ref(tab:sfa-26-seam-dt)); the latest stock assessment indicated an increase in fully-recruited biomass in 2023 of approximately 6% with landings of 227 tonnes (June 2022-May 2023); however this biomass increase was attributed to a significant and unexpected increase in scallop condition (the size of the meat for a given shell height) in 2023 [@dfoStockStatusUpdate2024].

## Summary Comparison of SEAM and BSSM

### SFA 25A

In SFA 25A the median fully-recruited biomass estimates in SEAM were approximately `r -med.per.b.sab.seam.bssm`% higher than that estimated by BSSM. This was primarily due to SEAM fully-recruited biomass estimates being substantially higher for most of the first 20 years, this trend has reversed in recent years (Figure \@ref(fig:sfa-25-bssm-seam-bm-fig)). This is, in part, due to recruitment in the early 2000s being much higher in SEAM than BSSM, whereas recruitment in BSSM has been estimated to be higher for the last 6 years (Figure \@ref(fig:sfa-25-bssm-seam-rec-fig)). Both models indicated that recruitment has been relatively strong in recent years, but this has not translated into fully-recruited biomass in either model. Natural mortality estimates were somewhat higher in BSSM; the median natural mortality for SEAM was `r med.m.sab.seam`, while it was `r med.m.fr.sab.bssm` for fully-recruited scallop in BSSM (Figure \@ref(fig:sfa-25-bssm-seam-bm-fig)). The retrospective analyses indicated that both BSSM and SEAM had relatively small fully-recruited biomass retrospective patterns. The one-year projected biomasses using the default method for both BSSM and SEAM substantially over-estimated the realized biomass, but this bias was largely overcome by using either the *no growth* or *zero productivity* methods for the projections.

### SFA 26A

In SFA 26A the median fully-recruited biomass estimates in SEAM were approximately `r -med.per.b.bbn.seam.bssm`% higher than that estimated by BSSM (Figure \@ref(fig:sfa-26-bssm-seam-bm-fig) ). The largest differences between the models were observed in the first 5 years of the model, with the smallest differences observed during the early 2000s when the biomass was at or near the maximum observed (Figure \@ref(fig:sfa-26-bssm-seam-bm-fig)). The recruit biomass estimates were similar between BSSM and SEAM in most years, but in 2009 and 2010 the BSSM model estimates were approximately twice as large as the estimates from SEAM (Figure \@ref(fig:sfa-26-bssm-seam-rec-fig)). The median natural mortality estimates in SEAM were substantially lower (`r med.m.bbn.seam`) than the fully-recruited natural mortality estimates in BSSM (`r med.m.fr.bbn.bssm`; Figure \@ref(fig:sfa-26-bssm-seam-nm-fig)). The retrospective analyses indicated that both BSSM and SEAM had relatively small fully-recruited biomass retrospective patterns. The one-year projected biomass's using the default method for both BSSM and SEAM substantially over-estimated the realized biomass, but this bias was largely overcome by using either the *no growth* or *zero productivity* methods for the projections.

# Conclusions

Overall the two modelling frameworks provided broadly similar results, but there were differences in the productivity parameters between the models. The biomass estimates for SEAM tended to be higher than observed for BSSM, these differences were related to both differences in catchability estimates and the effects of accounting for spatial patterns in the data. In SFA 26A, the relative changes in fully-recruited biomass over time were similar between the model frameworks, while in SFA 25A the relative changes in fully-recruited biomass were smaller for BSSM. The exploitation rate in SFA 25A has been low throughout the time frame covered by the model and the fishery has had little impact on the stock dynamics. In SFA 26A, there is evidence that the fishery does impact the stock dynamics, for this stock the fully-recruited biomass declined whenever the exploitation rate exceeded approximately 10%.

In both SFA 25A and SFA 26A both BSSM and SEAM provided fully-recruited biomass estimates with acceptable retrospective patterns. The retrospective patterns for the recruit biomass and natural mortality provide additional evidence for the difficulty of independently estimating these productivity parameters; here we see the retrospective patterns tend to change in the same direction. For example, when the recruitment retrospective indicates the recruit biomass estimate was higher for a given year, the natural mortality retrospective also tends to be higher. This aligns with the evidence that SEAM provides a reasonable estimate of the net productivity of the system, but disentangling the recruitment and natural mortality components is challenging [@mcdonaldExplicitIncorporationSpatial2021; @mcdonaldIncorporatingIntraannualVariability2022].

For both modelling frameworks the evidence from several lines of reasoning (e.g., process error and one-year predictions) suggest that the process component of the model tends to over-estimate the observed fully-recruited biomass from year to year. The process error term in BSSM and the random field in SEAM compensate for this when data (e.g., a survey) are available. The challenge arises when attempting to make future predictions using the default model parameterizations as this usually results in an over-estimate of the fully-recruited biomass for the following year. This pattern was observed in SFA 26A for the prediction evaluations undertaken using BSSM previously [e.g., Table 9, @hubleyGeorgesBankBrowns2014]. Here we tested several methods to determine their utility in reducing this prediction bias; the *no growth* and *zero productivity* methods were the most effective means of reducing the bias. The *no growth* method has the advantage of being able to track large recruitment or mortality events and as such we suggest this method is preferable to the *zero productivity* method for use in decision tables and projecting biomass into future years.

Overall, this analyses concludes that both the BSSM and SEAM frameworks provide a reasonable modelling platform to assess the status of the SFA 25A and SFA 26A stocks. However, the lack of a relationship between fully-recruited biomass and fishing mortality in SFA 25A highlights challenges under DFO's precautionary approach, since at the core of this approach there is an assumption that changes in fishing mortality will impact the stock dynamics. However, with due care and scrutiny either the BSSM or SEAM framework could be used for both SFA 25A and SFA 26A to support effective fisheries management decisions moving forward.

While both methods would be appropriate frameworks for the provision of science advice, the use of the SEAM framework for both stocks is recommended moving forward. The BSSM framework has known estimability and identifiability issues [@yinIdentifiableStatespaceModels2019], and while the model has proven a useful tool for providing science advice for scallop fisheries in the Maritime Region for over 20 years [e.g., @smithScallopProductionAreas2003], we believe it's utility moving forward is more limited. The SEAM framework 1) has favourable statistical properties, 2) provides all of the information that the BSSM framework provides, 3) provides additional understanding of the stock dynamics (e.g., the spatial fields), and 4) is the focus of an ongoing research program. Overall, the SEAM framework has greater potential to further improve our understanding of the population dynamics of sea scallop.

# Future Research

I DON'T MIND SCRAPING THIS ALTOGETHER

Gear selectivity (and catchability) is a function of the vessel, fishing gear, scallop size and density, and bottom habitat. For scallop dredge fisheries the vessel effects are often less influential than in trawl fisheries; as a result much of the focus on catchability estimates focus on the gear configuration, scallop size and density, and the bottom habitat [@millerEstimationCaptureEfficiency2019; @ romanSelectivityTwoCommercial2019; @romanExaminationVesselEffect2022]. Many selectivity studies have been undertaken on sea scallop using New Bedford dredges similar to what is used on Canadian Offshore Scallop survey [@delargyGlobalReviewCatch2022], but no selectivity studies have been undertaken using the current Canadian Offshore Scallop survey gear configuration. Without these studies we rely on studies using similar gear in other jurisdictions, however these studies provide relatively wide bounds on the potential range of catchability for sea scallop fisheries [@delargyGlobalReviewCatch2022]. 

The residual analysis indicated that the residuals do not fully conform to the assumed normal distribution (on the log scale). There is a great deal of flexibility in the distributional assumptions in the underlying modelling platform [Template Model Builder, @kristensenTMBAutomaticDifferentiation2016] and this platform could be used to develop more flexible distributions such as the skew-normal or combinations of distributions (e.g., a combination of the t-distribution with a normal distribution) for these models.

<!-- To fully capture the variability of catchability in the survey requires the development of a comparative survey SOMETHING SOMETHING. A better understanding of variability in catchability that accounts for scallop size, density, and bottom type would help better parameterize these models and should help reduce the confounding between natural mortality and recruit biomass and lead to improved estimates of these two productivity parameters. The SEAM model has been generalized to account for bottom habitat through the catchability parameter[@mcdonaldIntegratingHabitatFeatures2023], but to properly parameterize such a model would require at sea experimentation to better understand of the variability of selectivity and catchability in this survey. -->

<!-- The surveys count and measure the shell height of all scallop caught in a normal tow (the exception being when encountering large catches which can require sub-sampling). On every second tow a subset of the scallop are weighed and their shell heights measured to the nearest millimeter. As such, the total biomass of each tow are not directly measured, but are calculated by combining the numbers, shell heights, and the relationship between meat weight and shell height (FREYA). Given these estimates occur outside of the model framework, the error from this portion of the analysis is not fully propagated into the models. Integration of this component of the analysis into the model should provide a more complete understanding of the uncertainty in our data, it may also facilitate the development of a model estimate of scallop numbers (in addition to the biomass estimates). -->

<!-- Video based methods have been integrated into the assessment of scallop stocks throughout the world [CITE]. Over the last decade, industry led drop-camera surveys have taken place regularly for some stocks within Canadian waters (e.g., SFA 26A and SFA 27). The integration of these data into SEAM would provide additional information that could improve our understanding of population dynamics. These data could also be beneficial in years in which trawl survey data were unavailable. However, if these data were integrated into the SEAM framework, it would need to be undertaken so that the model results were robust to the loss of the drop-camera data. -->

<!-- There remains a great deal of research to undertake when using a spatial model framework. There is uncertainty in the exact location of the fishing effort as the vessels have the potential to move significant distances. In addition, the change in frequency of reporting in 2009 will result in a loss of precision in our understanding of the fishing locations before 2009. The use of knots helps to ameliorate these challenges as the size of the knots is much larger than a typical scallop bed, and the fishery tends to stay in areas with relatively high catch rates for a prolonged periods of time. The change in the frequency of reporting did not have a describable impact on the retrospective patterns in the models nor the relative size of the Process error within the knots, but undoubtedly there is some fishing activity that is allocated to incorrect locations.  The use of VMS data, which has a polling frequency of 1 hour, could be incorporated to refine the location of fishing activity, but the ongoing availability of these data along with challenges of linking removals to VMS polling precluded using these data at this time. ADD SOMETHING about VMS and GPS and ability to better know where we were in the world. -->

<!-- The first year spatial fields cannot be interpreted as the spatial fields were influenced by the initial conditions in the model [@mcdonaldExplicitIncorporationSpatial2021; @mcdonaldIncorporatingIntraannualVariability2022].  Given the length of the time series and the interest of these models in understanding current conditions, the initial year estimates were not particularly salient to the results here.  If the initial year results were of interest, they should be interpreted with care.  -->

<!-- The relative biomass change over time is similar when model parameters were varied (e.g. the number of knots, catchabilities, initial conditions). The productivity parameters (natural mortality and recruitment) were influenced by changes in the model parameterization, which is to be expected given the likely confounding between these parameters [@mcdonaldExplicitIncorporationSpatial2021; @mcdonaldIncorporatingIntraannualVariability2022]. This suggests that the models do capture the population dynamics appropriately, but, as with any model of this type, the input parameterization of the model will have a substantial impact on our understanding of absolute estimates and system productivity. For example, changing the catchability 'prior' will lead to different estimates of the total fully-recruited biomass, recruit biomass, and natural mortality, but the relative changes over time will be similar as long as reasonably informed decisions were made. -->

<!--chapter:end:tmp-01-text.Rmd-->

<!-- Do not edit this file! -->

\clearpage

# REFERENCES {-}

<!--chapter:end:tmp-02-references.Rmd-->

---
output: html_document
editor_options: 
  chunk_output_type: console
---
\clearpage
\newpage

# Tables {-}

```{r include=F, echo=F}
require(tidyverse)
require(csasdown)
require(kableExtra)
require(officedown)
require(officer)
require(flextable)



# These are the tables I want to make.
# clean things up...
# Parameter tables 
# First Sable and BSSM, here pulling this for parameters with only a single estimate
extract.bssm <- which(rownames(sab.bssm.mod.out$summary) %in% c("sigma","S","q","ikappa.rho2","ikappa.tau2",'logK'))
sab.bssm.parm.table <- data.frame(sab.bssm.mod.out$summary[extract.bssm,c("mean","sd")])
names(sab.bssm.parm.table) <- c("Estimate","Standard Error")
sab.bssm.parm.table$Estimate <- round(sab.bssm.parm.table$Estimate,digits=2)
sab.bssm.parm.table$`Standard Error`<- round(sab.bssm.parm.table$`Standard Error`,digits=3)

# SEAM...  get these from sdrep so we can get the standard errors reported as well.
sab.10.parm.table <- summary(sab.10$sdrep)
# Names we want to extract...
extract <- rownames(sab.10.parm.table)[c(1:13,24)]
sab.10.parm.table <- data.frame(sab.10.parm.table[extract,])
names(sab.10.parm.table) <- c("Estimate","Standard Error")
sab.10.parm.table$Estimate <- round(sab.10.parm.table$Estimate,digits=3)
sab.10.parm.table$`Standard Error`<- round(sab.10.parm.table$`Standard Error`,digits=3)

# Now BBn and BSSM, here pulling this for parameters with only a single estimate
extract.bssm <- which(rownames(bbn.bssm.mod.out$summary) %in% c("sigma","S","q","ikappa.rho2","ikappa.tau2",'logK'))
bbn.bssm.parm.table <- data.frame(bbn.bssm.mod.out$summary[extract.bssm,c("mean","sd")])
names(bbn.bssm.parm.table) <- c("Estimate","Standard Error")
bbn.bssm.parm.table$Estimate <- round(bbn.bssm.parm.table$Estimate,digits=2)
bbn.bssm.parm.table$`Standard Error`<- round(bbn.bssm.parm.table$`Standard Error`,digits=3)


# BBn
bbn.20.parm.table <- summary(bbn.20$sdrep)
# Names we want to extract...
extract <- rownames(bbn.20.parm.table)[c(1:12,33)]
bbn.20.parm.table <- data.frame(bbn.20.parm.table[extract,])
names(bbn.20.parm.table) <- c("Estimate","Standard Error")
bbn.20.parm.table$Estimate <- round(bbn.20.parm.table$Estimate,digits=3)
bbn.20.parm.table$`Standard Error`<- round(bbn.20.parm.table$`Standard Error`,digits=3)




# BSSM bias table...

bias.sab.clean <- bias.sab[,-ncol(bias.sab)]
bias.sab.clean[,c(2,4,5,6)] <- round(bias.sab.clean[,c(2,4,5,6)],digits=2)
bias.sab.clean[,c(1,3)] <- round(bias.sab.clean[,c(1,3)],digits=0)
# Now get beter names
names(bias.sab.clean) <- c("Biomass retro","Relative Biomass retro",
                           "Recruit retro","Relative Recruit retro",
                           "Natural Mortality retro","Relative Natural Mortality retro")

bias.sab.bssm.clean <- bias.bssm.sab[,-ncol(bias.bssm.sab)]
bias.sab.bssm.clean[,c(2,4,5,6)] <- round(bias.sab.bssm.clean[,c(2,4,5,6)],digits=2)
bias.sab.bssm.clean[,c(1,3)] <- round(bias.sab.bssm.clean[,c(1,3)],digits=0)
# Now get beter names
names(bias.sab.bssm.clean) <- c("Biomass retro","Relative Biomass retro",
                           "Recruit retro","Relative Recruit retro",
                           "Natural Mortality retro","Relative Natural Mortality retro")     

                      
# Same for bbn....
bias.bbn.clean <- bias.bbn[,-ncol(bias.bbn)]
bias.bbn.clean[,c(2,4,5,6)] <- round(bias.bbn.clean[,c(2,4,5,6)],digits=2)
bias.bbn.clean[,c(1,3)] <- round(bias.bbn.clean[,c(1,3)],digits=0)
# Now get beter names
names(bias.bbn.clean) <- c("Biomass retro","Relative Biomass retro",
                           "Recruit retro","Relative Recruit retro",
                           "Natural Mortality retro","Relative Natural Mortality retro")

bias.bbn.bssm.clean <- bias.bssm.bbn[,-ncol(bias.bssm.bbn)]
bias.bbn.bssm.clean[,c(2,4,5,6)] <- round(bias.bbn.bssm.clean[,c(2,4,5,6)],digits=2)
bias.bbn.bssm.clean[,c(1,3)] <- round(bias.bbn.bssm.clean[,c(1,3)],digits=0)
# Now get beter names
names(bias.bbn.bssm.clean) <- c("Biomass retro","Relative Biomass retro",
                           "Recruit retro","Relative Recruit retro",
                           "Natural Mortality retro","Relative Natural Mortality retro")     



opts <- options(knitr.kable.NA = "")

```


\newpage
```{r sfa-25-bssm-param-table,include=T,echo=F}
csas_table(sab.bssm.parm.table,caption="Selected parameter estimates and their standard errors from BSSM in SFA-25a")
```



\newpage
```{r sfa-26-bssm-param-table,include=T,echo=F}
csas_table(bbn.bssm.parm.table,caption="Selected parameter estimates and their standard errors from BSSM in SFA-26a")

```


\newpage
```{r sfa-25-param-table,include=T,echo=F}
csas_table(sab.10.parm.table,caption="Selected parameter estimates and their standard errors from SEAM in SFA-25a")
```


\newpage
```{r sfa-26-param-table,include=T,echo=F}
csas_table(bbn.20.parm.table,caption="Selected parameter estimates and their standard errors from SEAM in SFA-26a")
```


\newpage
```{r sfa-25-bssm-bias-table,include=T,echo=F}
csas_table(bias.sab.bssm.clean,caption ="Annual retrospecitve results from BSSM in SFA 25A.  Positive values indicate the retrospective
                              model estimates were higher than that base model. The Biomass retro and Recruit retro are in tonnes.
                             The relative metrics are proportional differences between the retrospective model and the base model.
                             The year represents the terminal year used to compare with the base model.")

```


\newpage
```{r sfa-25-bias-table,include=T,echo=F}
csas_table(bias.sab.clean,caption ="Annual retrospecitve results from SEAM in SFA 25A.  Positive values indicate the retrospective
                              model estimates were higher than that base model. The Biomass retro and Recruit retro are in tonnes.
                             The relative metrics are proportional differences between the retrospective model and the base model.
                             The year represents the terminal year used to compare with the base model.")
```


\newpage
```{r sfa-26-bssm-bias-table,include=T,echo=F}
csas_table(bias.bbn.bssm.clean,caption ="Annual retrospecitve results from BSSM in SFA 26A.  Positive values indicate the retrospective
                              model estimates were higher than that base model. The Biomass retro and Recruit retro are in tonnes.
                             The relative metrics are proportional differences between the retrospective model and the base model.
                             The year represents the terminal year used to compare with the base model.")

```


\newpage
```{r sfa-26-bias-table,include=T,echo=F}
csas_table(bias.bbn.clean, caption ="Annual retrospecitve results from SEAM in SFA 26A.  Positive values indicate the retrospective
                              model estimates were higher than that base model. The Biomass retro and Recruit retro are in tonnes.
                             The relative metrics are proportional differences between the retrospective model and the base model.
                             The year represents the terminal year used to compare with the base model.")
```


\newpage
```{r sfa-25-bssm-dt,include=T,echo=F}
csas_table(sab.bssm.dt, caption ="Decision table using the 2022 BSSM output for SFA 25A to estimate fully-recruited biomass in 2023 using the no growth scenario")
```



\newpage
```{r sfa-25-seam-dt,include=T,echo=F}
csas_table(sab.dt$table, caption ="Decision table using the 2022 SEAM output for SFA 25A to estimate fully-recruited biomass in 2023 using the no growth scenario")
```


\newpage
```{r sfa-26-bssm-dt,include=T,echo=F}
csas_table(bbn.bssm.dt, caption ="Decision table using the 2022 BSSM output for SFA 26A to estimate fully-recruited biomass in 2023 using the no growth scenario")
```


\newpage
```{r sfa-26-seam-dt,include=T,echo=F}
csas_table(bbn.dt$table, caption ="Decision table using the 2022 SEAM output for SFA 26A to estimate fully-recruited biomass in 2023 using the no growth scenario")
```

<!--chapter:end:tmp-03-tables.Rmd-->

---
output:
  pdf_document:
    fig_caption: yes
    extra_dependencies: float
linkcolor: blue
params:
  bank: NA
  banknum: NA
  surv.year: NA
header-includes: \usepackage{float}
editor_options:
  chunk_output_type: console
---

```{r, include=F, echo=F}
knitr::opts_knit$set(eval.after = "fig.cap")
knitr::opts_chunk$set(fig.pos = 'H')
options(knitr.kable.NA = '')
require(tidyverse)
options(tinytex.verbose = TRUE)

```



\clearpage
\newpage



# Figures {-}


```{r sfa-25a-knot-fig, echo=F, fig.cap="SFA 25A knot locations used for SEAM (10 knots)"}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab_knots_fig_10_knots.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab_knots_fig_10_knots.png"))
```


\newpage
```{r sfa-26a-knot-fig, echo=F, fig.cap="SFA 26A knot locations used for SEAM (20 knots)"}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn_knots_fig_20_knots.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn_knots_fig_20_knots.png"))
```


\newpage
```{r catch-prior-fig, echo=F, fig.cap="Catchability distribution used for fully-recruited biomass in SEAM and as the catchability prior for BSSM."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Catchability_distribution.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Catchability_distribution_fr.png"))
```


<!-- Moving to SFA 25 BSSM Figures -->

\newpage
```{r sfa-25-bssm-bm-fig, echo=F, fig.cap="SFA 25A BSSM Fully-recruited Biomass, shaded area represents the 95\\% credible interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_Biomass.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_Biomass.png"))
```


\newpage
```{r sfa-25-bssm-rec-fig, echo=F, fig.cap="SFA 25A BSSM Recruit Biomass, shaded area represents the 95\\% credible interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_Recruits.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_Recruits.png"))
```


\newpage
```{r sfa-25-bssm-fr-nm-fig, echo=F, fig.cap="SFA 25A BSSM Fully-recruited natural mortality (instantaneous), shaded area represents the 95\\% credible interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_fr_nm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_fr_nm.png"))
```


\newpage
```{r sfa-25-bssm-rec-nm-fig, echo=F, fig.cap="SFA 25A BSSM Recruit natural mortality (instantaneous), shaded area represents the 95\\% credible interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_rec_nm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_rec_nm.png"))
```


\newpage
```{r sfa-25-bssm-q-fig, echo=F, fig.cap="SFA 25A BSSM catchability posterior (histogram) and prior (line)"}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_q.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_q.png"))
```


\newpage
```{r sfa-25-bssm-fm-fig, echo=F, fig.cap="SFA 25A BSSM fishing mortality (instantaneous), shaded area represents the 95\\% credible interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_fm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_fm.png"))
```

<!-- Moving to SFA 26 BSSM Figures -->

\newpage
```{r sfa-26-bssm-bm-fig, echo=F, fig.cap="SFA 26A BSSM Fully-recruited Biomass, shaded area represents the 95\\% credible interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_Biomass.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_Biomass.png"))
```


\newpage
```{r sfa-26-bssm-rec-fig, echo=F, fig.cap="SFA 26A BSSM Recruit Biomass, shaded area represents the 95\\% credible interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_Recruits.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_Recruits.png"))
```


\newpage
```{r sfa-26-bssm-fr-nm-fig, echo=F, fig.cap="SFA 26A BSSM Fully-recruited natural mortality (instantaneous), shaded area represents the 95\\% credible interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_fr_nm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_fr_nm.png"))
```


\newpage
```{r sfa-26-bssm-rec-nm-fig, echo=F, fig.cap="SFA 26A BSSM Recruit natural mortality (instantaneous), shaded area represents the 95\\% credible interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_rec_nm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_rec_nm.png"))
```


\newpage
```{r sfa-26-bssm-q-fig, echo=F, fig.cap="SFA 26A BSSM catchability posterior (histogram) and prior (line)"}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_q.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_q.png"))
```


<!-- Currently I don't have this figure shown --->
\newpage
```{r sfa-26-bssm-fm-fig, echo=F, fig.cap="SFA 26A BSSM fishing mortality (instantaneous), shaded area represents the 95\\% credible interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_fm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_fm.png"))
```

<!-- Now for SEAM 25 first-->

\newpage
```{r sfa-25-bm-fig, echo=F, fig.cap="SFA 25A SEAM Fully-recruited Biomass, shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Biomass_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Biomass_time_series.png"))
```


\newpage
```{r sfa-25-fm-fig, echo=F, fig.cap="SFA 25A SEAM fishing mortality (instantaneous), shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_fish_mort_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_fish_mort_time_series.png"))
```


\newpage
```{r sfa-25-spat-bm-fig, echo=F, fig.cap="SFA 25A SEAM annual spatial fully-recruited Biomass density estimate in each knot."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_biomass.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_biomass.png"))
```


\newpage
```{r sfa-25-catchy-fig, echo=F, fig.cap="SFA 25A SEAM spatial catchability estiamte for fully-recruited scallop."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_catchability.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_catchability.png"))
```


\newpage
```{r sfa-25-rec-fig, echo=F, fig.cap="SFA 25A SEAM Recruit Biomass, shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Recruit_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Recruit_time_series.png"))
```


\newpage
```{r sfa-25-spat-rec-fig, echo=F, fig.cap="SFA 25A SEAM annual spatial Recruit Biomass density estimate in each knot."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_recruits.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_recruits.png"))
```


\newpage
```{r sfa-25-nm-fig, echo=F, fig.cap="SFA 25A SEAM natural mortality (instantaneous), shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_nat_mort_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_nat_mort_time_series.png"))
```


\newpage
```{r sfa-25-spat-nm-fig, echo=F, fig.cap="SFA 25A SEAM annual spatial natural mortality (instantaneous)  in each knot."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_nm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_nm.png"))
```


\newpage
```{r sfa-25-spat-fm-fig, echo=F, fig.cap="SFA 25A SEAM annual spatial fishing mortality (instantaneous) in each knot."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_fm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_fm.png"))
```


<!---- The Kobe, relative F vs mod F, and Jem Plots will go here, need to be moved tho... --->

\newpage
```{r sfa-25-kobe-fig, echo=F, fig.cap="SFA 25A phase plot, Exploitation rate (proportional) is on the y-axis and biomass is on the x-axis. The numbers on the plot represent the year."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_kobe.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_kobe.png"))
```


\newpage
```{r sfa-25-jem-fig, echo=F, fig.cap="SFA 25A percent change in fully-recruited biomass versus exploitation rate. The numbers on the plot represent the year (e.g. 14 is the change in biomass from 2014-2015 and the associated exploitation rate). "}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_jem.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_jem.png"))
```


\newpage
```{r sfa-25-rel-f-fig, echo=F, fig.cap="SFA 25A relative fishing mortality vs model estimated fishing mortality. The numbers on the plot represent the year (e.g. 14 is the explotation rate for 2014-2015."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_rel_vs_mod_F.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_rel_vs_mod_F.png"))
```


<!-- Moving to SFA 26 SEAM Figures -->


\newpage
```{r sfa-26-bm-fig, echo=F, fig.cap="SFA 26A SEAM Fully-recruited Biomass, shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Biomass_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Biomass_time_series.png"))
```


\newpage
```{r sfa-26-spat-bm-fig, echo=F, fig.cap="SFA 26A SEAM annual spatial fully-recruited Biomass density estimate in each knot."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_biomass.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_biomass.png"))
```


\newpage
```{r sfa-26-catchy-fig, echo=F, fig.cap="SFA 26A SEAM spatial catchability estiamte for fully-recruited scallop."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_catchability.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_catchability.png"))
```


\newpage
```{r sfa-26-rec-fig, echo=F, fig.cap="SFA 26A SEAM Recruit Biomass, shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Recruit_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Recruit_time_series.png"))
```


\newpage
```{r sfa-26-spat-rec-fig, echo=F, fig.cap="SFA 26A SEAM annual spatial Recruit Biomass density estimate in each knot."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_recruits.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_recruits.png"))
```


\newpage
```{r sfa-26-spat-fm-fig, echo=F, fig.cap="SFA 26A SEAM annual spatial fishing mortality (instantaneous) in each knot."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_fm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_fm.png"))
```

\newpage
```{r sfa-26-nm-fig, echo=F, fig.cap="SFA 26A SEAM natural mortality (instantaneous), shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_nat_mort_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_nat_mort_time_series.png"))
```


\newpage
```{r sfa-26-spat-nm-fig, echo=F, fig.cap="SFA 26A SEAM annual spatial natural mortality (instantaneous)  in each knot."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_nm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_nm.png"))
```


\newpage
```{r sfa-26-fm-fig, echo=F, fig.cap="SFA 26A SEAM fishing mortality (instantaneous), shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_fish_mort_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_fish_mort_time_series.png"))
```



\newpage
```{r sfa-26-kobe-fig, echo=F, fig.cap= "SFA 26A phase plot, Exploitation rate (proportional) is on the y-axis and biomass is on the x-axis. The numbers on the plot represent the year."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_kobe.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_kobe.png"))
```


\newpage
```{r sfa-26-jem-fig, echo=F, fig.cap= "SFA 26A percent change in fully-recruited biomass versus exploitation rate. The numbers on the plot represent the year (e.g. 14 is the change in biomass from 2014-2015 and the associated exploitation rate)."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_jem.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_jem.png"))
```


<!-- Final thing we'll need to get in here is the Prediction Evaluation figures -->
\newpage
```{r sfa-26-rel-f-fig, echo=F, fig.cap= "SFA 26A relative fishing mortality vs model estimated fishing mortality. The numbers on the plot represent the year (e.g. 14 is the explotation rate for 2014-2015."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_rel_vs_mod_F.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_rel_vs_mod_F.png"))
```


<!-- Now for the Random fields, starting with SFA 25... -->

<!-- Now for the Process error Figures, starting with SFA 25... -->

\newpage
```{r sfa-25-bssm-PE-ts-fig, echo=F, out.width = "30%",fig.cap="SFA 25A BSSM annual process error, a) raw (log scale), b) standardized"}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSmodel/English/Sab_bssm_process_error.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSmodel/French/Sab_bssm_process_error.png"))
```



```{r sfa-25-rf-bm-fig, echo=F, fig.cap="SFA 25A SEAM annual random field for fully-recruited biomass."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_B_rf.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_B_rf.png"))
```


\newpage
```{r sfa-25-med-seam-pe-fig, echo=F, fig.cap="SFA 26A SEAM annual random field for fully-recruited biomass."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_seam_median_pe.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_seam_median_pe.png"))
```


\newpage
```{r sfa-25-rf-rec-fig, echo=F, fig.cap="SFA 25A SEAM annual random field for recruit biomass."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_R_rf.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_R_rf.png"))
```


\newpage
```{r sfa-25-rf-nm-fig, echo=F, fig.cap="SFA 25A SEAM annual random field for natural mortality."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_m_rf.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_m_rf.png"))
```


\newpage


<!-- Now SFA 26 Process error-->

\newpage
```{r sfa-26-bssm-PE-ts-fig, echo=F, out.width = "30%",fig.cap="SFA 25A BSSM annual process error, a) raw (log scale), b) standardized"}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSmodel/English/BBn_bssm_process_error.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSmodel/French/BBn_bssm_process_error.png"))
```


\newpage
```{r sfa-26-rf-bm-fig, echo=F, fig.cap="SFA 26A SEAM annual random field for fully-recruited biomass."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_B_rf.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_B_rf.png"))
```


\newpage
```{r sfa-26-med-seam-pe-fig, echo=F, fig.cap="SFA 26A SEAM annual random field for fully-recruited biomass."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_seam_median_pe.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_seam_median_pe.png"))
```


\newpage
```{r sfa-26-rf-rec-fig, echo=F, fig.cap="SFA 26A SEAM annual random field for recruit biomass."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_R_rf.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_R_rf.png"))
```


\newpage
```{r sfa-26-rf-nm-fig, echo=F, fig.cap="SFA 26A SEAM annual random field for natural mortality."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_m_rf.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_m_rf.png"))
```



<!-- \newpage -->
<!-- ```{r sfa-25-PE-ts-fig, echo=F, out.width = "30%",fig.cap="SFA 25A SEAM annual process error, a) difference from model (1000s of tonnes), b) absolute percent difference from model (%). Postive values indicate the model estimate is lower than expected."} -->
<!-- if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_PE_time_series.png")) -->
<!-- if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_PE_time_series.png")) -->
<!-- ``` -->


<!-- \newpage -->
<!-- ```{r sfa-25-PE-spat-fig, echo=F, fig.cap="SFA 25A SEAM annual process error (difference from model, in tonnes) calculated in each year for each knot. Postive values indicate the model estimate is lower than expected."} -->
<!-- if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_PE.png")) -->
<!-- if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_PE.png")) -->
<!-- ``` -->


<!-- \newpage -->
<!-- ```{r sfa-25-PE-per-spat-fig, echo=F, fig.cap="SFA 25A SEAM annual process error (percent difference from model) calculated in each year for each knot. Postive values indicate the model estimate is lower than expected."} -->
<!-- if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_PE_per.png")) -->
<!-- if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_PE_per.png")) -->
<!-- ``` -->




<!-- \newpage -->
<!-- ```{r sfa-26-PE-ts-fig, echo=F, out.width = "20%",fig.cap="SFA 26A SEAM annual process error, a) difference from model (1000s of tonnes), b) absolute percent difference from model (%). Postive values indicate the model estimate is lower than expected."} -->
<!-- if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_PE_time_series.png")) -->
<!-- if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_PE_time_series.png")) -->
<!-- ``` -->


<!-- \newpage -->
<!-- ```{r sfa-26-PE-spat-fig, echo=F, fig.cap="SFA 26A SEAM annual process error (difference from model, in tonnes) calculated in each year for each knot. Postive values indicate the model estimate is lower than expected."} -->
<!-- if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_PE.png")) -->
<!-- if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_PE.png")) -->
<!-- ``` -->


<!-- \newpage -->
<!-- ```{r sfa-26-PE-per-spat-fig, echo=F, fig.cap="SFA 26A SEAM annual process error (percent difference from model) calculated in each year for each knot. Postive values indicate the model estimate is lower than expected."} -->
<!-- if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_PE_per.png")) -->
<!-- if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_PE_per.png")) -->
<!-- ``` -->


<!---- Combining SFA 25 and 26 for the  residuals --->


\newpage
```{r sfa-25-bssm-resid-I-fig, echo=F, fig.cap="SFA 25A BSSM fully-recruited biomass residuals versus fitted values, a) raw residuals (log scale), b) standardized residuals."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSmodel/English/Sab_bssm_FR_resids.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSmodel/French/Sab_bssm_FR_resids.png"))
```


\newpage
```{r sfa-25-bssm-resid-IR-fig, echo=F, fig.cap="SFA 25A BSSM recruit biomass residuals versus fitted values, a) raw residuals (log scale), b) standardized residuals."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSmodel/English/Sab_bssm_rec_resids.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSmodel/French/Sab_bssm_rec_resids.png"))
```


\newpage
```{r sfa-26-bssm-resid-I-fig, echo=F, fig.cap="SFA 26A BSSM fully-recruited biomass residuals versus fitted values, a) raw residuals (log scale), b) standardized residuals."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSmodel/English/BBn_bssm_FR_resids.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSmodel/French/BBn_bssm_FR_resids.png"))
```


\newpage
```{r sfa-26-bssm-resid-IR-fig, echo=F, fig.cap="SFA 26A BSSM recruit biomass residuals versus fitted values, a) raw residuals (log scale), b) standardized residuals."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSmodel/English/BBn_bssm_rec_resids.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSmodel/French/BBn_bssm_rec_resids.png"))
```


\newpage
```{r sfa-25-resid-I-fig, echo=F, fig.cap="SFA 25A fully-recruited biomass standardized residuals versus fitted values (kg/sqkm) at each knot."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_I_resids.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_I_resids.png"))
```


\newpage
```{r sfa-25-resid-IR-fig, echo=F, fig.cap="SFA 25A recruit biomass standardized residuals versus fitted values (kg/sqkm) at each knot."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_IR_resids.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_IR_resids.png"))
```

\newpage
```{r sfa-26-resid-I-fig, echo=F, fig.cap="SFA 26A fully-recruited biomass standardized residuals versus fitted values (kg/sqkm) at each knot."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_I_resids.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_I_resids.png"))
```


\newpage
```{r sfa-26-resid-IR-fig, echo=F, fig.cap="SFA 26A recruit biomass standardized residuals versus fitted values (kg/sqkm) at each knot."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_IR_resids.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_IR_resids.png"))
```



\newpage
```{r sfa-25-resid-qq-I-fig, echo=F, fig.cap="SFA 25A a) fully-recruited biomass residual quantile plot, the line represents the expected value of the residual if it was normally distributed (log scale), and b) is a density plot showing the distribution of the observed survey fully-recruited biomass."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_I_qq.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_I_qq.png"))
```


\newpage
```{r sfa-25-resid-qq-IR-fig, echo=F, fig.cap="SFA 25A recruit biomass a) quantile plot, the line represents the expected value of an observation if it is normally distributed (log scale), and b) is a density plot showing the distribution of the observed survey recruit biomass."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_IR_qq.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_IR_qq.png"))
```


\newpage
```{r sfa-26-resid-qq-I-fig, echo=F, fig.cap="SFA 26A a) fully-recruited biomass residual quantile plot, the line represents the expected value of the residual if it was normally distributed (log scale), and b) is a density plot showing the distribution of the observed survey fully-recruited biomass."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_I_qq.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_I_qq.png"))
```


\newpage
```{r sfa-26-resid-qq-IR-fig, echo=F, fig.cap="SFA 26A a) recruit biomass residual quantile plot, the line represents the expected value of the residual if it was normally distributed (log scale), and b) is a density plot showing the distribution of the observed survey recruit biomass."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_IR_qq.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_IR_qq.png"))
```


<!-- The retrospective patterns first SFA 25, starting that with bssm-->


\newpage
```{r sfa-25-bssm-retro-bm-fig, echo=F, fig.cap="SFA 25A BSSM fully-recruited biomass (1000s of tonnes) retrospective time series.  Retrospective fully-recruited biomass was estimated using models with terminal years from 2005 to 2021."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/English/Sab_bssm_biomass_retro.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/French/Sab_bssm_biomass_retro.png"))
```


\newpage
```{r sfa-25-bssm-retro-rec-fig, echo=F, fig.cap="SFA 25A BSSM recruit biomass retrospective biomass (1000s of tonnes).  Retrospective recruit biomass was estimated using models with terminal years from 2005 to 2021."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/English/Sab_bssm_recruit_retro.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/French/Sab_bssm_recruit_retro.png"))
```


\newpage
```{r sfa-25-bssm-retro-nm-fig, echo=F, fig.cap="SFA 25A BSSM natural mortality retrospective analysis.  Retrospective natural mortality was estimated using models with terminal years from 2005 to 2021."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/English/Sab_bssm_nm_retro.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/French/Sab_bssm_nm_retro.png"))
```

\newpage
```{r sfa-25-retro-bm-fig, echo=F, fig.cap="SFA 25A fully-recruited biomass (1000s of tonnes) retrospective time series.  Retrospective fully-recruited biomass was estimated using models with terminal years from 2005 to 2021."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/English/Sab_biomass_retro.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/French/Sab_biomass_retro.png"))
```


\newpage
```{r sfa-25-retro-rec-fig, echo=F, fig.cap="SFA 25A recruit biomass retrospective biomass (1000s of tonnes).  Retrospective recruit biomass was estimated using models with terminal years from 2005 to 2021."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/English/Sab_recruit_retro.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/French/Sab_recruit_retro.png"))
```


\newpage
```{r sfa-25-retro-nm-fig, echo=F, fig.cap="SFA 25A natural mortality retrospective analysis.  Retrospective natural mortality was estimated using models with terminal years from 2005 to 2021."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/English/Sab_nm_retro.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/French/Sab_nm_retro.png"))
```

<!---- Now we have SFA 26 retros starting with BSSM--->

\newpage
```{r sfa-26-bssm-retro-bm-fig, echo=F, fig.cap="SFA 26A BSSM fully-recruited biomass (1000s of tonnes) retrospective time series.  Retrospective fully-recruited biomass was estimated using models with terminal years from 2005 to 2021."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/English/BBn_bssm_biomass_retro.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/French/BBn_bssm_biomass_retro.png"))
```


\newpage
```{r sfa-26-bssm-retro-rec-fig, echo=F, fig.cap="SFA 26A BSSM recruit biomass retrospective biomass (1000s of tonnes).  Retrospective recruit biomass was estimated using models with terminal years from 2005 to 2021."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/English/BBn_bssm_recruit_retro.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/French/BBn_bssm_recruit_retro.png"))
```


\newpage
```{r sfa-26-bssm-retro-nm-fig, echo=F, fig.cap="SFA 26A BSSM natural mortality retrospective analysis.  Retrospective natural mortality was estimated using models with terminal years from 2005 to 2021."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/English/BBn_bssm_nm_retro.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/SS_model/French/BBn_bssm_nm_retro.png"))
```



\newpage
```{r sfa-26-retro-bm-fig, echo=F, fig.cap="SFA 26A fully-recruited biomass (1000s of tonnes) retrospective time series.  Retrospective fully-recruited biomass was estimated using models with terminal years from 2005 to 2021."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_biomass_retro.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_biomass_retro.png"))
```


\newpage
```{r sfa-26-retro-rec-fig, echo=F, fig.cap="SFA 26A recruit biomass retrospective biomass (1000s of tonnes).  Retrospective recruit biomass was estimated using models with terminal years from 2005 to 2021."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_recruit_retro.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_recruit_retro.png"))
```


\newpage
```{r sfa-26-retro-nm-fig, echo=F, fig.cap="SFA 26A natural mortality retrospective analysis.  Retrospective natural mortality was estimated using models with terminal years from 2005 to 2021."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_nm_retro.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_nm_retro.png"))
```



<!---- The Prediction Evaluation figures --->
\newpage
```{r sfa-25-bssm-pred-eval-ts-fig, echo=F, fig.cap="SFA 25A (BSSM) difference between realized biomass and one-year projections using four different methods. A value of zero indicates the one-year projection biomass was the same as the realized, positive (negative) values indicate the one-year projection predicted the biomass to be higher (lower) than realized. a) is the difference in 1000s of tonnes  while b) is the percent difference. A description of the methods are outlined in the methods section. The blue dashed line represents no  biomass difference."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/English/Sab_bssm_PE_bm_ts_combo.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/French/Sab_bssm_PE_bm_ts_combo.png"))
```


\newpage
```{r sfa-25-bssm-pred-eval-violin-fig, echo=F, fig.cap="SFA 25A (BSSM) violin plots of the difference between realized biomass and one-year projections using four different methods. A value of zero indicates the one-year projection biomass was the same as the realized, positive (negative) values indicate the one-year projection predicted the biomass to be higher (lower) than realized. a) is absolute difference in 1000s of tonnes, b) is the difference in 1000s of tonnes, and c) is the percent difference. A description of the methods are outlined in the methods section. The blue dashed line represents no biomass difference."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/English/Sab_bssm_PE_biomass_violin.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/French/Sab_bssm_PE_biomass_violin.png"))
```


\newpage
```{r sfa-25-pred-eval-ts-fig, echo=F, fig.cap="SFA 25A (SEAM) difference between realized biomass and one-year projections for eight different methods using SEAM. A value of zero indicates the one-year projection biomass was the same as the realized, positive (negative) values indicate the one-year projection predicted the biomass to be higher (lower) than realized. a) is the difference in 1000s of tonnes  while b) is the percent difference. A description of the methods are outlined in the methods section. The blue dashed line represents no  biomass difference."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/",mod.select,"_",scenario.10,"/English/Sab_PE_bm_ts_combo.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/",mod.select,"_",scenario.10,"/French/Sab_PE_bm_ts_combo.png"))
```


\newpage
```{r sfa-25-pred-eval-violin-fig, echo=F, fig.cap="SFA 25A (SEAM) violin plots of the difference between realized biomass and one-year projections using eight different methods. A value of zero indicates the one-year projection biomass was the same as the realized, positive (negative) values indicate the one-year projection predicted the biomass to be higher (lower) than realized. a) is absolute difference in 1000s of tonnes, b) is the difference in 1000s of tonnes, and c) is the percent difference. A description of the methods are outlined in the methods section. The blue dashed line represents no biomass difference."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/",mod.select,"_",scenario.10,"/English/Sab_PE_biomass_violin.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Pred_eval/",mod.select,"_",scenario.10,"/French/Sab_PE_biomass_violin.png"))
```


\newpage
```{r sfa-26-bssm-pred-eval-ts-fig, echo=F, fig.cap= "SFA 26A (BSSM) difference between realized biomass and one-year projections using fpur different methods. A value of zero indicates the one-year projection biomass was the same as the realized, positive (negative) values indicate the one-year projection predicted the biomass to be higher (lower) than realized. a) is the difference in 1000s of tonnes  while b) is the percent difference. A description of the methods are outlined in the methods section. The blue dashed line represents no biomass difference."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/English/BBn_bssm_PE_bm_ts_combo.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/French/BBn_bssm_PE_bm_ts_combo.png"))
```


\newpage
```{r sfa-26-bssm-pred-eval-violin-fig, echo=F, fig.cap="SFA 26A (BSSM) violin plots of the difference between realized biomass and one-year projections using four different methods. A value of zero indicates the one-year projection biomass was the same as the realized, positive (negative) values indicate the one-year projection predicted the biomass to be higher (lower) than realized. a) is absolute difference in 1000s of tonnes, b) is the difference in 1000s of tonnes, and c) is the percent difference. A description of the methods are outlined in the methods section. The blue dashed line represents no biomass difference."}

if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/English/BBn_bssm_PE_biomass_violin.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/SS_model/French/BBn_bssm_PE_biomass_violin.png"))
```


\newpage
```{r sfa-26-pred-eval-ts-fig, echo=F, fig.cap= "SFA 26A (SEAM) difference between realized biomass and one-year projections using eight different methods. A value of zero indicates the one-year projection biomass was the same as the realized, positive (negative) values indicate the one-year projection predicted the biomass to be higher (lower) than realized. a) is the difference in 1000s of tonnes  while b) is the percent difference. A description of the methods are outlined in the methods section. The blue dashed line represents no biomass difference."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_PE_bm_ts_combo.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_PE_bm_ts_combo.png"))
```


\newpage
```{r sfa-26-pred-eval-violin-fig, echo=F, fig.cap="SFA 26A (SEAM) violin plots of the difference between realized biomass and one-year projections using eight different methods. A value of zero indicates the one-year projection biomass was the same as the realized, positive (negative) values indicate the one-year projection predicted the biomass to be higher (lower) than realized. a) is absolute difference in 1000s of tonnes, b) is the difference in 1000s of tonnes, and c) is the percent difference. A description of the methods are outlined in the methods section. The blue dashed line represents no biomass difference."}

if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_PE_biomass_violin.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Pred_eval/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_PE_biomass_violin.png"))
```


<!---- Finally The BSSM vs SEAM figures --->

\newpage
```{r sfa-25-bssm-seam-bm-fig, echo=F, fig.cap="SFA 25A fully-recruited biomass (1000s of tonnes) time series for BSSM (blue line is median, with a shaded 95\\% credible interval) and SEAM (red line is median, with shaded 95\\% confidence interval)."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_bssm_seam_bm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_bssm_seam_bm.png"))
```


\newpage
```{r sfa-25-bssm-seam-rec-fig, echo=F, fig.cap="SFA 25A recruit biomass (1000s of tonnes) time series for BSSM (blue line is median, with a shaded 95\\% credible interval) and SEAM (red line is median, with shaded 95\\% confidence interval)."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_bssm_seam_rec.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_bssm_seam_rec.png"))
```


\newpage
```{r sfa-25-bssm-seam-nm-fig, echo=F, fig.cap="SFA 25A natural mortality (instantaneous) time series for BSSM (blue line is median fully-recruited natural mortality, with a shaded 95\\% credible interval) and SEAM (red line is median natural mortality, with shaded 95\\% confidence interval)."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_bssm_seam_nm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_bssm_seam_nm.png"))
```


\newpage
```{r sfa-26-bssm-seam-bm-fig, echo=F, fig.cap= "SFA 26A fully-recruited biomass (1000s of tonnes) time series for BSSM (blue line is median, with a shaded 95\\% credible interval) and SEAM (red line is median, with shaded 95\\% confidence interval)."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_bssm_seam_bm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_bssm_seam_bm.png"))
```


\newpage
```{r sfa-26-bssm-seam-rec-fig, echo=F, fig.cap= "SFA 26A recruit biomass (1000s of tonnes) time series for BSSM (blue line is median, with a shaded 95\\% credible interval) and SEAM (red line is median, with shaded 95\\% confidence interval)."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_bssm_seam_rec.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_bssm_seam_rec.png"))
```


\newpage
```{r sfa-26-bssm-seam-nm-fig, echo=F, fig.cap= "SFA 26A natural mortality (instantaneous) time series for BSSM (blue line is median fully-recruited natural mortality, with a shaded 95\\% credible interval) and SEAM (red line is median natural mortality, with shaded 95\\% confidence interval)."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_bssm_seam_nm.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_bssm_seam_nm.png"))
```

<!--chapter:end:tmp-04-figures.Rmd-->

<!-- The following code should appear at the beginning of the first appendix.
After that, all subsequent sections will be turned into appendices. -->

`r if(knitr:::is_latex_output()) '\\Appendices'`

`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {A}'`

\newpage

# Knot Differences {#app:A}

## SFA 25a

The number of knots has a minimal impact the fully-recruited biomass estimates in SFA 25a, with an average annual biomass difference of `r abs(mn.b.knot.diff.sab)` tonnes (`r abs(mn.b.per.knot.diff.sab)`%) (Fig. \@ref(fig:sfa-25-bm-20-fig)). The overall recruit biomass estimates are also very similar between the 10 knot and 20 knot models with an average annual biomass difference of `r mn.r.knot.diff.sab` tonnes (`r mn.r.per.knot.diff.sab`%) (Fig. \@ref(fig:sfa-25-rec-20-fig)). However, the natural mortality estimates do differ substantially between the 10 and 20 knot models, with the natural mortality in the 10 knot model being higher than the 20 knot model; the natural mortality of the 10 knot model is on average `r mn.m.knot.diff.sab` (`r mn.m.per.knot.diff.sab`%) higher than the 20 knot model model (Fig. \@ref(fig:sfa-25-nm-20-fig)). The catchabilities were similar between the models, with the range of catchabilities of 20 knot model (`r min.q.sab.20` - `r max.q.sab.20`) being slightly wider than the 10 knot model (`r min.q.sab` - `r max.q.sab`).

## SFA 26a

The number of knots does impact the fully-recruited biomass estimates in SFA 26a, with the 10 knot model having a higher annual biomass estimate, on average the 10 knot model biomass is `r mn.b.knot.diff.bbn` tonnes (`r mn.b.per.knot.diff.bbn`%) higher than the 20 knot model (Fig. \@ref(fig:sfa-26-bm-10-fig)). The overall recruit biomass estimates are also higher in the 10 knot model, with recruit biomass `r mn.r.knot.diff.bbn` tonnes (`r mn.r.per.knot.diff.bbn`%) higher in the 10 knot model (Fig. \@ref(fig:sfa-26-rec-10-fig)). The natural mortality estimates  in the 10 knot model are higher than the 20 knot model; the natural mortality of the 10 knot model is on average `r mn.m.knot.diff.bbn` (`r mn.m.per.knot.diff.bbn`%) higher than the 20 knot model model (Fig. \@ref(fig:sfa-26-nm-10-fig)). The catchabilities are similar between the models, with the range of catchabilities of 20 knot model (`r min.q.bbn` - `r max.q.bbn`) being slightly wider than the 10 knot model (`r min.q.bbn.10` - `r max.q.bbn.10`).


## Figures

\newpage
```{r sfa-25-bm-20-fig, echo=F, fig.cap="SFA-25a SEAM fully-recruited biomass estimate using 20 knots, shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/English/Sab_Biomass_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/French/Sab_Biomass_time_series.png"))
```


\newpage
```{r sfa-25-rec-20-fig, echo=F, fig.cap="SFA-25a SEAM recruit biomass estimate using 20 knots, shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/English/Sab_Recruit_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/French/Sab_Recruit_time_series.png"))
```


\newpage
```{r sfa-25-nm-20-fig, echo=F, fig.cap="SFA-25a SEAM natural mortality (instantaneous) using 20 knots, shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/English/Sab_nat_mort_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/French/Sab_nat_mort_time_series.png"))
```


\newpage
```{r sfa-26-bm-10-fig, echo=F, fig.cap="SFA-26a SEAM fully-recruited biomass estimate using 10 knots, shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/English/BBn_Biomass_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/French/BBn_Biomass_time_series.png"))
```


\newpage
```{r sfa-26-rec-10-fig, echo=F, fig.cap="SFA-26a SEAM recruit biomass estimate using 10 knots, shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/English/BBn_Recruit_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/French/BBn_Recruit_time_series.png"))
```


\newpage
```{r sfa-26-nm-10-fig, echo=F, fig.cap="SFA-26a SEAM natural mortality (instantaneous) estimate using 10 knots, shaded area represents the 95\\% confidence interval."}
if(language== 'english') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/English/BBn_nat_mort_time_series.png"))
if(language== 'french') knitr::include_graphics(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/French/BBn_nat_mort_time_series.png"))
```

<!--chapter:end:tmp-05-appendix.Rmd-->

## Formatting to-do

- caption styles
- change colons in captions to periods
- bold table headers
- delete TOC
- move abstract up
- add title, author, etc.
- citation
- DRAFT watermark
- Bullets
- Body text style
- Crop old survey design figures  

<!--chapter:end:tmp-06-formatting.Rmd-->

