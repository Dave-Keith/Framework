---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r error-field-processing, echo=F, include=F, paged.print=FALSE,cache=F}
# For some stuff we need to drop the prediction year piece
drops <- length(pred.proc.sab.10$totals$totB)

# Get the error fields, adding in a lot of code here!!

# First get the mesh where we want it...
sab.10.mesh.sf <- inla.mesh2sf(sab.mesh.10$mesh)
sab.10.mesh.sf.triangles  <- sab.10.mesh.sf$triangles
sab.10.mesh.sf.triangles <- data.frame(sab.10.mesh.sf.triangles)
sab.10.mesh.sf.triangles$geometry <- sab.10.mesh.sf.triangles$geometry*1000
sab.10.mesh.sf.triangles <- st_as_sf(sab.10.mesh.sf.triangles)
st_crs(sab.10.mesh.sf.triangles) <- 32620
sab.10.mesh.sf  <- sab.10.mesh.sf$vertices
sab.10.mesh.sf$meshID <- 1:nrow(sab.10.mesh.sf)
sab.10.mesh.sf <- data.frame(sab.10.mesh.sf)
sab.10.mesh.sf$geometry <- sab.10.mesh.sf$geometry*1000
sab.10.mesh.sf <- st_as_sf(sab.10.mesh.sf)
# sab.grid.10 <- data.frame(sab.grid.10$grid)
# sab.grid.10$geometry <- sab.grid.10$geometry*1000
# sab.grid.10 <- st_as_sf(sab.grid.10)
# st_crs(sab.grid.10) <- 32620
#tst <- st_intersection(sab.10.mesh.sf,sab.grid.10)
# Now for BBn
# First get the mesh where we want it...
bbn.20.mesh.sf <- inla.mesh2sf(bbn.mesh.20$mesh)
bbn.20.mesh.sf.triangles  <- bbn.20.mesh.sf$triangles
bbn.20.mesh.sf.triangles <- data.frame(bbn.20.mesh.sf.triangles)
bbn.20.mesh.sf.triangles$geometry <- bbn.20.mesh.sf.triangles$geometry*1000
bbn.20.mesh.sf.triangles <- st_as_sf(bbn.20.mesh.sf.triangles)
st_crs(bbn.20.mesh.sf.triangles) <- 32620
bbn.20.mesh.sf  <- bbn.20.mesh.sf$vertices
bbn.20.mesh.sf$meshID <- 1:nrow(bbn.20.mesh.sf)
bbn.20.mesh.sf <- data.frame(bbn.20.mesh.sf)
bbn.20.mesh.sf$geometry <- bbn.20.mesh.sf$geometry*1000
bbn.20.mesh.sf <- st_as_sf(bbn.20.mesh.sf)



# First biomass for sable 10....
sab.10.B.field <- as.data.frame(sab.10$report$omega_B[,-drops])
names(sab.10.B.field) <- years
sab.10.B.field$meshID <- 1:nrow(sab.10.B.field)
sab.10.B.field <- sab.10.B.field %>% pivot_longer(!meshID)
# now let's join these...
sab.10.B.field <- merge(sab.10.mesh.sf,sab.10.B.field,by="meshID",)
st_crs(sab.10.B.field) <- 32620
sab.10.B.field <- st_join(sab.10.mesh.sf.triangles,sab.10.B.field)

# Now the recruits
sab.10.R.field <- as.data.frame(sab.10$report$omega_R) # no drop as we don't have this in year 30...
names(sab.10.R.field) <- years
sab.10.R.field$meshID <- 1:nrow(sab.10.R.field)
sab.10.R.field <- sab.10.R.field %>% pivot_longer(!meshID)
# now let's join these...
sab.10.R.field <- merge(sab.10.mesh.sf,sab.10.R.field,by="meshID",)
st_crs(sab.10.R.field) <- 32620
sab.10.R.field <- st_join(sab.10.mesh.sf.triangles,sab.10.R.field)

# Finally the natural mortality.
sab.10.m.field <- as.data.frame(sab.10$report$omega_m[,-drops])
names(sab.10.m.field) <- years
sab.10.m.field$meshID <- 1:nrow(sab.10.m.field)
sab.10.m.field <- sab.10.m.field %>% pivot_longer(!meshID)
# now let's join these...
sab.10.m.field <- merge(sab.10.mesh.sf,sab.10.m.field,by="meshID",)
st_crs(sab.10.m.field) <- 32620
sab.10.m.field <- st_join(sab.10.mesh.sf.triangles,sab.10.m.field)



# Now the same thing for BBn
# First Biomass field
bbn.20.B.field <- as.data.frame(bbn.20$report$omega_B[,-drops])
names(bbn.20.B.field) <- years
bbn.20.B.field$meshID <- 1:nrow(bbn.20.B.field)
bbn.20.B.field <- bbn.20.B.field %>% pivot_longer(!meshID)
# now let's join these...
bbn.20.B.field <- merge(bbn.20.mesh.sf,bbn.20.B.field,by="meshID",)
st_crs(bbn.20.B.field) <- 32620
bbn.20.B.field <- st_join(bbn.20.mesh.sf.triangles,bbn.20.B.field)

# Now the recruits
bbn.20.R.field <- as.data.frame(bbn.20$report$omega_R) # no drop as we don't have this in year 30...
names(bbn.20.R.field) <- years
bbn.20.R.field$meshID <- 1:nrow(bbn.20.R.field)
bbn.20.R.field <- bbn.20.R.field %>% pivot_longer(!meshID)
# now let's join these...
bbn.20.R.field <- merge(bbn.20.mesh.sf,bbn.20.R.field,by="meshID",)
st_crs(bbn.20.R.field) <- 32620
bbn.20.R.field <- st_join(bbn.20.mesh.sf.triangles,bbn.20.R.field)

# Finally the natural mortality.
bbn.20.m.field <- as.data.frame(bbn.20$report$omega_m[,-drops])
names(bbn.20.m.field) <- years
bbn.20.m.field$meshID <- 1:nrow(bbn.20.m.field)
bbn.20.m.field <- bbn.20.m.field %>% pivot_longer(!meshID)
# now let's join these...
bbn.20.m.field <- merge(bbn.20.mesh.sf,bbn.20.m.field,by="meshID",)
st_crs(bbn.20.m.field) <- 32620
bbn.20.m.field <- st_join(bbn.20.mesh.sf.triangles,bbn.20.m.field)



```



```{r analysis, echo=F, include=F, paged.print=FALSE,cache=F}

# Numbers for the text...
# For some stuff we need to drop the prediction year piece
drops <- length(pred.proc.sab.10$totals$totB)

# Maximum and min biomasses and years for sable
max.b.sab <- round(max(pred.proc.sab.10$totals$totB))
max.b.sab.y <- years[which(pred.proc.sab.10$totals$totB == max(pred.proc.sab.10$totals$totB))]
min.b.sab <- round(min(pred.proc.sab.10$totals$totB))
min.b.sab.y <- years[which(pred.proc.sab.10$totals$totB == min(pred.proc.sab.10$totals$totB))]
# for bbn
max.b.bbn <- round(max(pred.proc.bbn.20$totals$totB))
max.b.bbn.y <- years[which(pred.proc.bbn.20$totals$totB == max(pred.proc.bbn.20$totals$totB))]
min.b.bbn <- round(min(pred.proc.bbn.20$totals$totB))
min.b.bbn.y <- years[which(pred.proc.bbn.20$totals$totB == min(pred.proc.bbn.20$totals$totB))]

# Max and min catchabilities
min.q.sab <- round(min(q.spat.sab.10$qI),digits=2)
max.q.sab <- round(max(q.spat.sab.10$qI),digits=2)
min.q.bbn <- round(min(q.spat.bbn.20$qI),digits=2)
max.q.bbn <- round(max(q.spat.bbn.20$qI),digits=2)

# Recruitment numbers
rec.sab.since.07 <- round(max(pred.proc.sab.10$totals$totR[which(years == 2007):drops],na.rm=T),digits=0)


# natural mortality range
max.m.sab <- round(max(1-exp(-pred.proc.sab.10$totals$mean_m)),digits=2)
min.m.sab <- round(min(pred.proc.sab.10$totals$mean_m),digits=2)
# for bbn
max.m.bbn <- round(max(pred.proc.bbn.20$totals$mean_m),digits=2)
min.m.bbn <- round(min(pred.proc.bbn.20$totals$mean_m),digits=2)

# Fishing mortality
min.f.sab <- round(min(F.sab.10$FM,na.rm=T),digits=2)
max.f.sab <- round(max(F.sab.10$FM,na.rm=T),digits=2)
# bbn
min.f.bbn <- round(min(F.bbn.20$FM,na.rm=T),digits=2)
max.f.bbn <- round(max(F.bbn.20$FM,na.rm=T),digits=2)

# Key differences between 10 and 20 knot models...
# First Sable
knot.b.diff.sab <- pred.proc.sab.20$totals$totB[-drops] - pred.proc.sab.10$totals$totB[-drops]
mn.b.knot.diff.sab <- round(median(knot.b.diff.sab),digits=1)
mn.b.per.knot.diff.sab <- round(100*(median(knot.b.diff.sab / pred.proc.sab.10$totals$totB[-drops])),digits=1)
# recruits
knot.r.diff.sab <- pred.proc.sab.10$totals$totR[-drops] - pred.proc.sab.20$totals$totR[-drops]
mn.r.knot.diff.sab <- round(median(knot.r.diff.sab),digits=1)
mn.r.per.knot.diff.sab <- round(100*(median(knot.r.diff.sab / pred.proc.sab.10$totals$totR[-drops])),digits=1)

knot.m.diff.sab <- pred.proc.sab.10$totals$mean_m[-drops] - pred.proc.sab.20$totals$mean_m[-drops]
mn.m.knot.diff.sab <- round(median(knot.m.diff.sab),digits=2)
mn.m.per.knot.diff.sab <- round(100*(median(knot.m.diff.sab / pred.proc.sab.10$totals$mean_m[-drops])),digits=1)

min.q.sab.20 <- round(min(q.spat.sab.20$qI),digits=2)
max.q.sab.20 <- round(max(q.spat.sab.20$qI),digits=2)

# Now BBn

knot.b.diff.bbn <- pred.proc.bbn.10$totals$totB[-drops] - pred.proc.bbn.20$totals$totB[-drops] 
mn.b.knot.diff.bbn <- round(median(knot.b.diff.bbn),digits=1)
mn.b.per.knot.diff.bbn <- round(100*(median(knot.b.diff.bbn / pred.proc.bbn.20$totals$totB[-drops])),digits=1)
# recruits
knot.r.diff.bbn <- pred.proc.bbn.10$totals$totR[-drops] - pred.proc.bbn.20$totals$totR[-drops]
mn.r.knot.diff.bbn <- round(median(knot.r.diff.bbn),digits=1)
mn.r.per.knot.diff.bbn <- round(100*(median(knot.r.diff.bbn / pred.proc.bbn.20$totals$totR[-drops])),digits=1)

knot.m.diff.bbn <- pred.proc.bbn.10$totals$mean_m[-drops] - pred.proc.bbn.20$totals$mean_m[-drops]
mn.m.knot.diff.bbn <- round(median(knot.m.diff.bbn),digits=2)
mn.m.per.knot.diff.bbn <- round(100*(median(knot.m.diff.bbn / pred.proc.bbn.20$totals$mean_m[-drops])),digits=1)

min.q.bbn.10 <- round(min(q.spat.bbn.10$qI),digits=2)
max.q.bbn.10 <- round(max(q.spat.bbn.10$qI),digits=2)

# BSSM results
# SFA 25a Sable
sab.bssm.bm <- sab.bssm %>% dplyr::filter(term == "Biomass (tonnes)")
sab.bssm.rec <- sab.bssm %>% dplyr::filter(term == "Recruit Biomass (tonnes)")
sab.bssm.nm.fr <- sab.bssm %>% dplyr::filter(term == "FR Natural Mortality (90+ mm, instantaneous)")
sab.bssm.nm.rec <- sab.bssm %>% dplyr::filter(term == "Recruit Natural Mortality (75-90 mm, instantaneous)")
sab.bssm.fm <- sab.bssm %>% dplyr::filter(term == "Fishing Mortality (instantaneous)")

# biomass
max.b.sab.bssm <- round(max(sab.bssm.bm$med,na.rm=T),digits=0)
max.b.sab.bssm.y <- sab.bssm.bm$year[sab.bssm.bm$med == max(sab.bssm.bm$med,na.rm=T)]
min.b.sab.bssm <- round(min(sab.bssm.bm$med,na.rm=T),digits=0)
min.b.sab.bssm.y <- sab.bssm.bm$year[sab.bssm.bm$med == min(sab.bssm.bm$med,na.rm=T)]
# Recruits
max.r.sab.bssm <- round(max(sab.bssm.rec$med,na.rm=T),digits=0)
max.r.sab.bssm.y <- sab.bssm.rec$year[sab.bssm.rec$med == max(sab.bssm.rec$med,na.rm=T)]
min.r.sab.bssm <- round(min(sab.bssm.rec$med,na.rm=T),digits=0)
min.r.sab.bssm.y <- sab.bssm.rec$year[sab.bssm.rec$med == min(sab.bssm.rec$med,na.rm=T)]

# BBN
bbn.bssm.bm <- bbn.bssm %>% dplyr::filter(term == "Biomass (tonnes)")
bbn.bssm.rec <- bbn.bssm %>% dplyr::filter(term == "Recruit Biomass (tonnes)")
bbn.bssm.nm.fr <- bbn.bssm %>% dplyr::filter(term == "FR Natural Mortality (90+ mm, instantaneous)")
bbn.bssm.nm.rec <- bbn.bssm %>% dplyr::filter(term == "Recruit Natural Mortality (75-90 mm, instantaneous)")
bbn.bssm.fm <- bbn.bssm %>% dplyr::filter(term == "Fishing Mortality (instantaneous)")
# biomass
max.b.bbn.bssm <- round(max(bbn.bssm.bm$med,na.rm=T),digits=0)
max.b.bbn.bssm.y <- bbn.bssm.bm$year[bbn.bssm.bm$med == max(bbn.bssm.bm$med,na.rm=T)]
min.b.bbn.bssm <- round(min(bbn.bssm.bm$med,na.rm=T),digits=0)
min.b.bbn.bssm.y <- bbn.bssm.bm$year[bbn.bssm.bm$med == min(bbn.bssm.bm$med,na.rm=T)]
# Recruits
max.r.bbn.bssm <- round(max(bbn.bssm.rec$med,na.rm=T),digits=0)
max.r.bbn.bssm.y <- bbn.bssm.rec$year[bbn.bssm.rec$med == max(bbn.bssm.rec$med,na.rm=T)]
min.r.bbn.bssm <- round(min(bbn.bssm.rec$med,na.rm=T),digits=0)
min.r.bbn.bssm.y <- bbn.bssm.rec$year[bbn.bssm.rec$med == min(bbn.bssm.rec$med,na.rm=T)]

# catchability estimates....
sab.med.q <- round(median(sab.bssm.q$q,na.rm=T),digits=2)
bbn.med.q <- round(median(bbn.bssm.q$q,na.rm=T),digits=2)
# SEAM vs BSSM
# SFA 25a
# biomass differences...
sab.b.seam.bssm <- sab.bssm.bm$med - pred.proc.sab.10$totals$totB[-drops]
med.b.sab.seam.bssm <- round(median(sab.b.seam.bssm,na.rm=T),digits=0)
med.per.b.sab.seam.bssm <- round(median(100* (sab.b.seam.bssm / pred.proc.sab.10$totals$totB[-drops]),digits=0))
# recruit differences...
sab.r.seam.bssm <- sab.bssm.rec$med - pred.proc.sab.10$totals$totR[-drops]
med.r.sab.seam.bssm <- round(median(sab.r.seam.bssm,na.rm=T),digits=0)
med.per.r.sab.seam.bssm <- round(median(100* (sab.r.seam.bssm / pred.proc.sab.10$totals$totR[-drops]),digits=0))
# average natural mortality...
med.m.sab.seam <- round(median(1-exp(-pred.proc.sab.10$totals$mean_m)),digits=2)
med.m.fr.sab.bssm <- round(median(bbn.bssm.nm.fr$med),digits=2)
med.m.r.sab.bssm <- round(median(bbn.bssm.nm.rec$med),digits=2)
# BBn
# biomass differences...
bbn.b.seam.bssm <- bbn.bssm.bm$med - pred.proc.bbn.20$totals$totB[-drops]
med.b.bbn.seam.bssm <- round(median(bbn.b.seam.bssm,na.rm=T),digits=0)
med.per.b.bbn.seam.bssm <- round(median(100* (bbn.b.seam.bssm / pred.proc.bbn.20$totals$totB[-drops]),digits=0))
# recruit differences...
bbn.r.seam.bssm <- bbn.bssm.rec$med - pred.proc.bbn.20$totals$totR[-drops]
med.r.bbn.seam.bssm <- round(median(bbn.r.seam.bssm,na.rm=T),digits=0)
med.per.r.bbn.seam.bssm <- round(median(100* (bbn.r.seam.bssm / pred.proc.bbn.20$totals$totR[-drops]),digits=0))
# average natural mortality...
med.m.bbn.seam <- round(median(1-exp(-pred.proc.bbn.20$totals$mean_m)),digits=2)
med.m.fr.bbn.bssm <- round(median(bbn.bssm.nm.fr$med),digits=2)
med.m.r.bbn.bssm <- round(median(bbn.bssm.nm.rec$med),digits=2)

# Retrospecitves
# Sable
mr.b.sab.5 <- round(mr.sab$mr.B5,digits=2)
mr.b.sab.all <- round(mr.sab$mr.B,digits=2)
mr.r.sab.5 <- round(mr.sab$mr.R5,digits=2)
mr.r.sab.all <- round(mr.sab$mr.R,digits=2)
mr.m.sab.5 <- round(mr.sab$mr.m5,digits=2)
mr.m.sab.all <- round(mr.sab$mr.m,digits=2)

# BBn
mr.b.bbn.5 <- round(mr.bbn$mr.B5,digits=2)
mr.b.bbn.all <- round(mr.bbn$mr.B,digits=2)
mr.r.bbn.5 <- round(mr.bbn$mr.R5,digits=2)
mr.r.bbn.all <- round(mr.bbn$mr.R,digits=2)
mr.m.bbn.5 <- round(mr.bbn$mr.m5,digits=2)
mr.m.bbn.all <- round(mr.bbn$mr.m,digits=2)

# Get the biomass residuals annually....
# Sable

Bdiff.sab.10.y <- Bdiff.sab.10 %>% dplyr::group_by(Year) %>% dplyr::summarise(residual = sum(B.diff),
                                                                              mod.B = sum(B.mod),
                                                                              exp.B = sum(B.exp))
Bdiff.sab.10.y <- Bdiff.sab.10.y %>% dplyr::mutate(res.check = exp.B-mod.B,
                                                   res.per = 100*residual/mod.B)

min.sab.10.res <- round(min(Bdiff.sab.10.y$residual),digits=0)
max.sab.10.res <- round(max(Bdiff.sab.10.y$residual),digits=0)
med.sab.10.res <- round(median(abs(Bdiff.sab.10.y$residual)),digits=0)
med.sab.10.per.res <- round(median(abs(Bdiff.sab.10.y$res.per)),digits=0)
# BBn
Bdiff.bbn.20.y <- Bdiff.bbn.20 %>% dplyr::group_by(Year) %>% dplyr::summarise(residual = sum(B.diff),
                                                                              mod.B = sum(B.mod),
                                                                              exp.B = sum(B.exp))
Bdiff.bbn.20.y <- Bdiff.bbn.20.y %>% dplyr::mutate(res.check = exp.B-mod.B,
                                                   res.per = 100*residual/mod.B)

min.bbn.20.res <- round(min(Bdiff.bbn.20.y$residual),digits=0)
max.bbn.20.res <- round(max(Bdiff.bbn.20.y$residual),digits=0)
med.bbn.20.res <- round(median(abs(Bdiff.bbn.20.y$residual)),digits=0)
med.bbn.20.per.res <- round(median(abs(Bdiff.bbn.20.y$res.per)),digits=0)

# Other model output
# Sable
sab.10.B.range <- round(sab.10$report$Range_B,digits=0)
sab.10.R.range <- round(sab.10$report$Range_R,digits=0)
sab.10.m.range <- round(sab.10$report$Range_m,digits=0)

sab.10.parm.table <- data.frame(B0 = round(sab.10$report$B0,digits=0),
                                R0= round(sab.10$report$R0,digits=0),
                                m0 = round(sab.10$report$m0,digits=2),
                                qR = round(sab.10$report$qR,digits=2),
                                SigmaO_B=round(sab.10$report$SigmaO_B,digits=2),
                                SigmaO_R=round(sab.10$report$SigmaO_R,digits=2),
                                SigmaO_m=round(sab.10$report$SigmaO_m,digits=2),
                                p_I=round(sab.10$report$p_I,digits=2),
                                p_IR=round(sab.10$report$p_IR,digits=2),
                                kappa_B=round(sab.10$report$kappa_B,digits=3),
                                kappa_R=round(sab.10$report$kappa_R,digits=3),
                                kappa_m=round(sab.10$report$kappa_m,digits=3),
                                sigma_epsilon=round(sab.10$report$sigma_epsilon,digits=2),
                                sigma_upsilon=round(sab.10$report$sigma_upsilon,digits=2),
                                tau_B=round(sab.10$report$tau_B,digits=1),
                                tau_R=round(sab.10$report$tau_R,digits=1),
                                tau_m=round(sab.10$report$tau_m,digits=1))

# BBn
bbn.20.B.range <- round(bbn.20$report$Range_B,digits=0)
bbn.20.R.range <- round(bbn.20$report$Range_R,digits=0)
bbn.20.m.range <- round(bbn.20$report$Range_m,digits=0)

bbn.20.parm.table <- data.frame(B0 = round(bbn.20$report$B0,digits=0),
                                R0= round(bbn.20$report$R0,digits=0),
                                m0 = round(bbn.20$report$m0,digits=2),
                                qr = bbn.20$report$qR,
                                SigmaO_B=round(bbn.20$report$SigmaO_B,digits=2),
                                SigmaO_R=round(bbn.20$report$SigmaO_R,digits=2),
                                SigmaO_m=round(bbn.20$report$SigmaO_m,digits=2),
                                p_I=round(bbn.20$report$p_I,digits=2),
                                p_IR=round(bbn.20$report$p_IR,digits=2),
                                kappa_B=round(bbn.20$report$kappa_B,digits=3),
                                kappa_R=round(bbn.20$report$kappa_R,digits=3),
                                kappa_m=round(bbn.20$report$kappa_m,digits=3),
                                sigma_epsilon=round(bbn.20$report$sigma_epsilon,digits=2),
                                sigma_upsilon=round(bbn.20$report$sigma_upsilon,digits=2),
                                tau_B=round(bbn.20$report$tau_B,digits=1),
                                tau_R=round(bbn.20$report$tau_R,digits=1),
                                tau_m=round(bbn.20$report$tau_m,digits=1))


```

<!-- Make the figures -->

```{r catch-prior, echo=F,include=F}

prior <- data.frame(prior = dbeta(seq(0,1,by=0.01),20,40),x = seq(0,1,by=0.01))
prior.fig <- ggplot(prior) + geom_line(aes(y=prior,x=x)) + xlab("Fully-recruited catchability")  + scale_y_continuous(name = "", labels=NULL,breaks = NULL)

if(language == 'english') save_plot(filename = paste0(repo.loc,"Figures/Catchability_distribution.png"),prior.fig,base_width = 8,base_height = 6)
if(language == 'french') save_plot(filename = paste0(repo.loc,"Figures/Catchability_distribution_fr.png"),prior.fig,base_width = 8,base_height = 6)

```


```{r sfa25-seam, echo=F,include=F}

# Biomass
bm.ts.plot <- ggplot(pred.proc.sab.10$log_processes) + geom_line(aes(year,exp(log_B)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totB.LCI,ymax=totB.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + ylim(c(0,1.5e4)) + 
                                xlab("") + ylab("Fully Recruited Biomass (tonnes)") + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Biomass_time_series.png"),bm.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Biomass_time_series.png"),bm.ts.plot,base_width = 8,base_height = 6)

# Spatial biomass
#B
b.brk <- pretty(log(b.spat.sab.10$B))
b.lab <- signif(exp(b.brk),digits=2)

spatial.B.plot<- ggplot() + geom_sf(data=b.spat.sab.10 %>% dplyr::filter(Year != 2023),aes(fill=log(B)),color='grey')+
                            facet_wrap(~Year,ncol=5)+ 
                            #scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                            #scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                            scale_fill_viridis_c(breaks = b.brk, labels=b.lab,name="Biomass \nDensity \n(kg\U2022km\U207B\U00B2)",option = "A",begin=0.2) + 
                            theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_biomass.png"),spatial.B.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_biomass.png"),spatial.B.plot,base_width = 12,base_height = 16)

# Catchability

spatial.q.plot <- ggplot() + geom_sf(data=q.spat.sab.10,aes(fill=qI),col=NA)+
                             #scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                             #scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                             scale_fill_viridis_c(name="Ccatchability (qI)",option = "C",begin = 0.2,end =0.8) + 
                             theme(axis.text.x=element_text(angle=-45,hjust=0))
if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_catchability.png"),spatial.q.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_catchability.png"),spatial.q.plot,base_width = 8,base_height = 6)


# Recruit biomass
rec.ts.plot <- ggplot(pred.proc.sab.10$log_processes) + geom_line(aes(year,exp(log_R)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totR.LCI,ymax=totR.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Recruit Biomass (tonnes)") + ylim(c(0,1.9e3)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Recruit_time_series.png"),rec.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Recruit_time_series.png"),rec.ts.plot,base_width = 8,base_height = 6)


r.brk <- pretty(log(r.spat.sab.10$R))
r.lab <- signif(exp(r.brk),digits=2)
spatial.R.plot<-  ggplot() + geom_sf(data=r.spat.sab.10,aes(fill=log(R)),col='grey')+
                             facet_wrap(~Year,ncol=5)+ 
                             # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                             # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                             scale_fill_viridis_c(breaks = r.brk, labels = r.lab,name="Recruit \nDensity \n(kg\U2022km\U207B\U00B2)",end=0.8)+ 
                             theme(axis.text.x=element_text(angle=-45,hjust=0))
if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_recruits.png"),spatial.R.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/English/Sab_Spatial_recruits.png"),spatial.R.plot,base_width = 12,base_height = 16)

# Remove missing survey years


# Natural mortality time series...
mort.ts.plot <- ggplot(pred.proc.sab.10$log_processes) + geom_line(aes(year,exp(log_m)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=m.LCI,ymax=m.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Natural mortality (Instantaneous)") + ylim(c(0,1)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_nat_mort_time_series.png"),mort.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_nat_mort_time_series.png"),mort.ts.plot,base_width = 8,base_height = 6)


m.brk <- log(c(0.03,0.1,0.3,1))
#m.brk <- pretty(log(m.dat.plot$m))
m.lab <- signif(exp(m.brk),digits=2)

spatial.m.plot <-  ggplot() + geom_sf(data=m.spat.sab.10,aes(fill=log(m)),color='grey')+
                              facet_wrap(~Year,ncol=5)+
                              # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                              # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                              scale_fill_viridis_c(breaks = m.brk, labels = m.lab,name="Natural \nmortality \n(Instantaneous)",option = "B",direction =1,begin = 0.2,end=1) + theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_nm.png"),spatial.m.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_nm.png"),spatial.m.plot,base_width = 12,base_height = 16)

# Remove missing survey years

# Fishing mortality Time Series
exploit.plot <- ggplot(F.sab.10) + geom_line(aes(x=year,y=FM),linewidth = 1.5) + geom_ribbon(aes(ymin=exploit.LCI,ymax=exploit.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') +
                                   xlab("") + ylab("Fishing mortality (Instantaneous)") + ylim(c(0,0.06)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_fish_mort_time_series.png"),exploit.plot,base_width = 8,base_height = 6)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_fish_mort_time_series.png"),exploit.plot,base_width = 8,base_height = 6)


e.brk <- log(c(0.00015,0.001,0.005,0.02,0.08))
#e.brk <- pretty(log(F.dat.plot$exp.na))
e.lab <- signif(exp(e.brk),digits=2)

spatial.exploit.plot<- ggplot() + geom_sf(data=F.spat.sab.10,aes(fill=log(F.na)),color='grey') +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~Year,ncol=5) + scale_fill_viridis_c(breaks = e.brk,labels = e.lab,name="Fishing \nmortality \n(Instantaneous)",option = "D") + theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_FM.png"),spatial.exploit.plot,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_FM.png"),spatial.exploit.plot,base_width = 12,base_height = 16)

## 20 knots big 3 figures for comparison....

# Biomass
bm.20.ts.plot <- ggplot(pred.proc.sab.20$log_processes) + geom_line(aes(year,exp(log_B)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totB.LCI,ymax=totB.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + ylim(c(0,1.5e4)) + 
                                xlab("") + ylab("Fully Recruited Biomass (tonnes)") + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/English/Sab_Biomass_time_series.png"),bm.20.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/French/Sab_Biomass_time_series.png"),bm.20.ts.plot,base_width = 8,base_height = 6)

# Recruit biomass
rec.20.ts.plot <- ggplot(pred.proc.sab.20$log_processes) + geom_line(aes(year,exp(log_R)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totR.LCI,ymax=totR.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Recruit Biomass (tonnes)") + ylim(c(0,1.9e3)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/English/Sab_Recruit_time_series.png"),rec.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/French/Sab_Recruit_time_series.png"),rec.ts.plot,base_width = 8,base_height = 6)



# Natural mortality time series...
mort.20.ts.plot <- ggplot(pred.proc.sab.20$log_processes) + geom_line(aes(year,exp(log_m)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=m.LCI,ymax=m.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Natural mortality (Instantaneous)") + ylim(c(0,1)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/English/Sab_nat_mort_time_series.png"),mort.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"/French/Sab_nat_mort_time_series.png"),mort.ts.plot,base_width = 8,base_height = 6)



```



<!-- Now BBn -->



```{r sfa26-seam, echo=F,include=F}

# Biomass
bm.ts.plot <- ggplot(pred.proc.bbn.20$log_processes) + geom_line(aes(year,exp(log_B)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totB.LCI,ymax=totB.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + ylim(c(0,3.1e4)) + 
                                xlab("") + ylab("Fully Recruited Biomass (tonnes)") + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Biomass_time_series.png"),bm.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Biomass_time_series.png"),bm.ts.plot,base_width = 8,base_height = 6)

# Spatial biomass
#B
b.brk <- pretty(log(b.spat.bbn.20$B))
b.lab <- signif(exp(b.brk),digits=2)

spatial.B.plot<- ggplot() + geom_sf(data=b.spat.bbn.20 %>% dplyr::filter(Year != 2023),aes(fill=log(B)),color='grey')+
                            facet_wrap(~Year,ncol=5)+ 
                            #scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                            #scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                            scale_fill_viridis_c(breaks = b.brk, labels=b.lab,name="Biomass \nDensity \n(kg\U2022km\U207B\U00B2)",option = "A",begin=0.2) + 
                            theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_biomass.png"),spatial.B.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_biomass.png"),spatial.B.plot,base_width = 12,base_height = 16)

# Catchability

spatial.q.plot <- ggplot() + geom_sf(data=q.spat.bbn.20,aes(fill=qI),col=NA)+
                             #scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                             #scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                             scale_fill_viridis_c(name="Ccatchability (qI)",option = "C",begin = 0.2,end =0.8) + 
                             theme(axis.text.x=element_text(angle=-45,hjust=0))
if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_catchability.png"),spatial.q.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_catchability.png"),spatial.q.plot,base_width = 8,base_height = 6)


# Recruit biomass
rec.ts.plot <- ggplot(pred.proc.bbn.20$log_processes) + geom_line(aes(year,exp(log_R)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totR.LCI,ymax=totR.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Recruit Biomass (tonnes)") + ylim(c(0,7e3)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Recruit_time_series.png"),rec.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Recruit_time_series.png"),rec.ts.plot,base_width = 8,base_height = 6)


r.brk <- pretty(log(r.spat.bbn.20$R))
r.lab <- signif(exp(r.brk),digits=2)
spatial.R.plot<-  ggplot() + geom_sf(data=r.spat.bbn.20,aes(fill=log(R)),col='grey')+
                             facet_wrap(~Year,ncol=5)+ 
                             # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                             # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                             scale_fill_viridis_c(breaks = r.brk, labels = r.lab,name="Recruit \nDensity \n(kg\U2022km\U207B\U00B2)",end=0.8)+ 
                             theme(axis.text.x=element_text(angle=-45,hjust=0))
if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_recruits.png"),spatial.R.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/French/BBn_Spatial_recruits.png"),spatial.R.plot,base_width = 12,base_height = 16)

# Remove missing survey years


# Natural mortality time series...
mort.ts.plot <- ggplot(pred.proc.bbn.20$log_processes) + geom_line(aes(year,exp(log_m)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=m.LCI,ymax=m.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Natural mortality (Instantaneous)") + ylim(c(0,0.35)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_nat_mort_time_series.png"),mort.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_nat_mort_time_series.png"),mort.ts.plot,base_width = 8,base_height = 6)


m.brk <- log(c(0.03,0.1,0.3,1))
#m.brk <- pretty(log(m.dat.plot$m))
m.lab <- signif(exp(m.brk),digits=2)

spatial.m.plot <-  ggplot() + geom_sf(data=m.spat.bbn.20,aes(fill=log(m)),color='grey')+
                              facet_wrap(~Year,ncol=5)+
                              # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                              # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                              scale_fill_viridis_c(breaks = m.brk, labels = m.lab,name="Natural \nmortality \n(Instantaneous)",option = "B",direction =1,begin = 0.2,end=1) + theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_nm.png"),spatial.m.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_nm.png"),spatial.m.plot,base_width = 12,base_height = 16)

# Remove missing survey years

# Fishing mortality Time Series
exploit.plot <- ggplot(F.bbn.20) + geom_line(aes(x=year,y=FM),linewidth = 1.5) + geom_ribbon(aes(ymin=exploit.LCI,ymax=exploit.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') +
                                   xlab("") + ylab("Fishing mortality (Instantaneous)") + ylim(c(0,0.3)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_fish_mort_time_series.png"),exploit.plot,base_width = 8,base_height = 6)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_fish_mort_time_series.png"),exploit.plot,base_width = 8,base_height = 6)


e.brk <- pretty(log(F.spat.bbn.20$F.na))
e.lab <- signif(exp(e.brk),digits=2)
spatial.exploit.plot<- ggplot() + geom_sf(data=F.spat.bbn.20,aes(fill=log(F.na)),color='grey') +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~Year,ncol=5) + scale_fill_viridis_c(breaks = e.brk,labels = e.lab,name="Fishing \nmortality \n(Instantaneous)",option = "D") + theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_fm.png"),spatial.exploit.plot,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_fm.png"),spatial.exploit.plot,base_width = 12,base_height = 16)


# 10 knot competition


# Biomass
bm.10.ts.plot <- ggplot(pred.proc.bbn.10$log_processes) + geom_line(aes(year,exp(log_B)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totB.LCI,ymax=totB.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + ylim(c(0,3.1e4)) + 
                                xlab("") + ylab("Fully Recruited Biomass (tonnes)") + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/English/BBn_Biomass_time_series.png"),bm.10.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/French/BBn_Biomass_time_series.png"),bm.10.ts.plot,base_width = 8,base_height = 6)


# Recruit biomass
rec.10.ts.plot <- ggplot(pred.proc.bbn.10$log_processes) + geom_line(aes(year,exp(log_R)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=totR.LCI,ymax=totR.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Recruit Biomass (tonnes)") + ylim(c(0,7e3)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/English/BBn_Recruit_time_series.png"),rec.10.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/French/BBn_Recruit_time_series.png"),rec.10.ts.plot,base_width = 8,base_height = 6)



# Natural mortality time series...
mort.10.ts.plot <- ggplot(pred.proc.bbn.10$log_processes) + geom_line(aes(year,exp(log_m)),color='firebrick2',linewidth=1.5) + 
                                geom_ribbon(aes(ymin=m.LCI,ymax=m.UCI,x=year),alpha=0.2,fill='darkblue',color='darkblue') + 
                                xlab("") + ylab("Natural mortality (Instantaneous)") + ylim(c(0,0.35)) + scale_x_continuous(breaks = seq(1980,2030,by=3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/English/BBn_nat_mort_time_series.png"),mort.10.ts.plot,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"_vary_q=TRUE/French/BBn_nat_mort_time_series.png"),mort.10.ts.plot,base_width = 8,base_height = 6)


```



<!-- Sable BSSM model results -->


```{r sfa25-bssm, echo=F,include=F}

p.bssm.bm <- ggplot(sab.bssm %>% dplyr::filter(term == "Biomass (tonnes)"), aes(x=year,y=med)) + geom_line(linewidth=1.5,color='firebrick2') +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Fully Recruited Biomass (tonnes)") + xlab("")  + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,1.15e4))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_Biomass.png"),p.bssm.bm,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_Biomass.png"),p.bssm.bm,base_width = 8,base_height = 6)

# Just the recruits

p.bssm.rec <- ggplot(sab.bssm %>% dplyr::filter(term == "Recruit Biomass (tonnes)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Recruit Biomass (tonnes)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,2.5e3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_Recruits.png"),p.bssm.rec,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_Recruits.png"),p.bssm.rec,base_width = 8,base_height = 6)

# Natural mortality

p.bssm.nat.mort <- ggplot(sab.bssm %>% dplyr::filter(term == "FR Natural Mortality (90+ mm, instantaneous)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Natural Mortality (90+ mm, instantaneous)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,1.4))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_fr_nm.png"),p.bssm.nat.mort,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_fr_nm.png"),p.bssm.nat.mort,base_width = 8,base_height = 6)

p.bssm.rec.nat.mort <- ggplot(sab.bssm %>% dplyr::filter(term == "Recruit Natural Mortality (75-90 mm, instantaneous)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Natural Mortality (75-90 mm, instantaneous)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,1))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_rec_nm.png"),p.bssm.rec.nat.mort,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_rec_nm.png"),p.bssm.rec.nat.mort,base_width = 8,base_height = 6)

# Exploitation Rate

p.bssm.F <- ggplot(sab.bssm %>% dplyr::filter(term == "Fishing Mortality (instantaneous)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Fishing Mortality (instantaneous)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,0.08))


if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_fm.png"),p.bssm.F,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_fm.png"),p.bssm.F,base_width = 8,base_height = 6)

# BSSM catchability posterior and prior

p.bssm.q <- ggplot(sab.bssm.q,aes(x=q,after_stat(density))) + geom_histogram() + geom_line(data=prior,aes(y=prior,x=x)) + 
                                scale_x_continuous(name = "Catchability (q)", limits = c(0.1,0.7),breaks = seq(0,1,by=0.05)) + scale_y_continuous(name = "", labels=NULL,breaks = NULL) 

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/English/Sab_q.png"),p.bssm.q,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/SSModel/French/Sab_q.png"),p.bssm.q,base_width = 8,base_height = 6)


```


<!-- # Now for BBn SS Model results# -->

```{r sfa26-bssm, echo=F,include=F}

p.bssm.bm <- ggplot(bbn.bssm %>% dplyr::filter(term == "Biomass (tonnes)"), aes(x=year,y=med)) + geom_line(linewidth=1.5,color='firebrick2') +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Fully Recruited Biomass (tonnes)") + xlab("")  + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,2.5e4))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_Biomass.png"),p.bssm.bm,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_Biomass.png"),p.bssm.bm,base_width = 8,base_height = 6)

# Just the recruits

p.bssm.rec <- ggplot(bbn.bssm %>% dplyr::filter(term == "Recruit Biomass (tonnes)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Recruit Biomass (tonnes)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,7e3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_Recruits.png"),p.bssm.rec,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_Recruits.png"),p.bssm.rec,base_width = 8,base_height = 6)

# Natural mortality

p.bssm.nat.mort <- ggplot(bbn.bssm %>% dplyr::filter(term == "FR Natural Mortality (90+ mm, instantaneous)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Natural Mortality (90+ mm, instantaneous)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,0.9))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_fr_nm.png"),p.bssm.nat.mort,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_fr_nm.png"),p.bssm.nat.mort,base_width = 8,base_height = 6)

p.bssm.rec.nat.mort <- ggplot(bbn.bssm %>% dplyr::filter(term == "Recruit Natural Mortality (75-90 mm, instantaneous)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Natural Mortality (75-90 mm, instantaneous)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,3.3))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_rec_nm.png"),p.bssm.rec.nat.mort,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_rec_nm.png"),p.bssm.rec.nat.mort,base_width = 8,base_height = 6)

# Exploitation Rate

p.bssm.F <- ggplot(bbn.bssm %>% dplyr::filter(term == "Fishing Mortality (instantaneous)"), aes(x=year,y=med)) + geom_line(color='firebrick2',linewidth=1.5) +
  geom_ribbon(aes(x=year,ymin=lci,ymax=uci),fill='darkblue',color='darkblue',alpha = 0.2) + ylab("Fishing Mortality (instantaneous)") + xlab("") + 
  scale_x_continuous(breaks = seq(1980,2030,by=3)) + ylim(c(0,0.4))

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_fm.png"),p.bssm.F,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_fm.png"),p.bssm.F,base_width = 8,base_height = 6)

# BSSM catchability posterior and prior

p.bssm.q <- ggplot(bbn.bssm.q,aes(x=q,after_stat(density))) + geom_histogram() + geom_line(data=prior,aes(y=prior,x=x)) + 
                                scale_x_continuous(name = "Catchability (q)", limits = c(0.1,0.7),breaks = seq(0,1,by=0.05)) + scale_y_continuous(name = "", labels=NULL,breaks = NULL) 

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/English/BBn_q.png"),p.bssm.q,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/SSModel/French/BBn_q.png"),p.bssm.q,base_width = 8,base_height = 6)
```

<!-- # Next up we have the error structure figures for SFA-25a -->


```{r sfa25-error-field, echo=F,include=F}
# FR biomass
p.B.rf<- ggplot() + geom_sf(data=sab.10.B.field,aes(fill=value,color=value)) +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~name,ncol=5) + 
                                  scale_fill_viridis_c(name="Fully-recruited \nBiomass \nRandom Field",option = "D") + 
                                  scale_color_viridis_c(name="Fully-recruited \nBiomass \nRandom Field",option = "D") + 
                                  theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_B_rf.png"),p.B.rf,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_B_rf.png"),p.B.rf,base_width = 12,base_height = 16)

# Recruits
p.R.rf<- ggplot() + geom_sf(data=sab.10.R.field,aes(fill=value,color=value)) +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~name,ncol=5) + 
                                  scale_fill_viridis_c(name="Recruit Biomass \nRandom Field",option = "D") + 
                                  scale_color_viridis_c(name="Recruit Biomass \nRandom Field",option = "D") + 
                                  theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_R_rf.png"),p.R.rf,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_R_rf.png"),p.R.rf,base_width = 12,base_height = 16)

# mortality
p.m.rf<- ggplot() + geom_sf(data=sab.10.m.field,aes(fill=value,color=value)) +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~name,ncol=5) + 
                                  scale_fill_viridis_c(name="Natural mortality \nRandom Field",option = "D") + 
                                  scale_color_viridis_c(name="Natural mortality \nRandom Field",option = "D") + 
                                  theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_m_rf.png"),p.m.rf,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_m_rf.png"),p.m.rf,base_width = 12,base_height = 16)


```

<!-- Now BBn -->

```{r sfa26-error-field, echo=F,include=F}
# FR biomass
p.B.rf<- ggplot() + geom_sf(data=bbn.20.B.field,aes(fill=value,color=value)) +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~name,ncol=5) + 
                                  scale_fill_viridis_c(name="Fully-recruited \nBiomass \nRandom Field",option = "D") + 
                                  scale_color_viridis_c(name="Fully-recruited \nBiomass \nRandom Field",option = "D") + 
                                  theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_B_rf.png"),p.B.rf,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_B_rf.png"),p.B.rf,base_width = 12,base_height = 16)

# Recruits
p.R.rf<- ggplot() + geom_sf(data=bbn.20.R.field,aes(fill=value,color=value)) +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~name,ncol=5) + 
                                  scale_fill_viridis_c(name="Recruit Biomass \nRandom Field",option = "D") + 
                                  scale_color_viridis_c(name="Recruit Biomass \nRandom Field",option = "D") + 
                                  theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_R_rf.png"),p.R.rf,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_R_rf.png"),p.R.rf,base_width = 12,base_height = 16)

# mortality
p.m.rf<- ggplot() + geom_sf(data=bbn.20.m.field,aes(fill=value,color=value)) +
                                  # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                  # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                  facet_wrap(~name,ncol=5) + 
                                  scale_fill_viridis_c(name="Natural mortality \nRandom Field",option = "D") + 
                                  scale_color_viridis_c(name="Natural mortality \nRandom Field",option = "D") + 
                                  theme(axis.text.x=element_text(angle=-45,hjust=0))

if(language == 'english')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_m_rf.png"),p.m.rf,base_width = 12,base_height = 16)
if(language == 'french')  save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_m_rf.png"),p.m.rf,base_width = 12,base_height = 16)

```


<!-- Now we are off to the residuals, starting in SFA 25a -->

```{r sfa25-resids, echo=F,include=F}

# First the annual absolute and proportional residuals....

p.res.abs.an <- ggplot(Bdiff.sab.10.y) + geom_line(aes(x=Year, y=residual/1000)) + 
                                         scale_x_continuous(name="",breaks = seq(1980,2030,by=3),labels=NULL) + ylab("Fully-Recruited Biomass Residual (tonnes x 1000)") +
                                         theme(plot.margin = margin(0.25,0.25,0.25,0.4, "cm"))
p.res.per.an <- ggplot(Bdiff.sab.10.y) + geom_line(aes(x=Year, y=res.per)) + scale_x_continuous(name="",breaks = seq(1980,2030,by=3)) + ylab("Fully-Recruited Biomass Residual (%)")

p.res.annual <- plot_grid(p.res.abs.an,p.res.per.an,ncol=1)

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_resid_time_series.png"),p.res.annual,base_width = 6,base_height = 8)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_resid_time_series.png"),p.res.annual,base_width = 6,base_height = 8)

# Now plot the residuals spatially


bd.brk <- pretty(Bdiff.sab.10$B.diff)
bd.lab <- bd.brk#signif(exp(b.brk),digits=2)

spatial.Bdiff.plot<- ggplot() + geom_sf(data=Bdiff.sab.10,aes(fill=B.diff),color='grey')+
                                facet_wrap(~Year,ncol=5)+ 
                                # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                scale_fill_distiller(type = 'div',breaks = bd.brk, labels=bd.lab, name="Process \nResidual \n(tonnes)",palette = "RdBu") + 
                                theme(axis.text.x=element_text(angle=-45,hjust=0))
if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_res.png"),spatial.Bdiff.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_res.png"),spatial.Bdiff.plot,base_width = 12,base_height = 16)

pb.brk <- pretty(Bdiff.sab.10$B.per.diff)
pb.lab <- pb.brk#signif(exp(b.brk),digits=2)

spatial.Bdiff.per.plot<- ggplot() + geom_sf(data=Bdiff.sab.10,aes(fill=B.per.diff),color='grey')+
                                    facet_wrap(~Year,ncol=5)+ 
                                    # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                    # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                    scale_fill_distiller(type = 'div',breaks = pb.brk, labels=pb.lab, name="Process \nResidual \n(%)",palette = "RdBu") + 
                                    theme(axis.text.x=element_text(angle=-45,hjust=0))
if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/English/Sab_Spatial_res_per.png"),spatial.Bdiff.per.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.10,"/French/Sab_Spatial_res_per.png"),spatial.Bdiff.per.plot,base_width = 12,base_height = 16)

```


<!-- Now moving to the 26a residuals.... -->


```{r sfa26-resids, echo=F,include=F}

# First the annual absolute and proportional residuals....

p.res.abs.an <- ggplot(Bdiff.bbn.20.y) + geom_line(aes(x=Year, y=residual/1000)) + 
                                         scale_x_continuous(name="",breaks = seq(1980,2030,by=3),labels=NULL) + ylab("Fully-Recruited Biomass Residual (tonnes x 1000)") +
                                         theme(plot.margin = margin(0.25,0.25,0.25,0.4, "cm"))
p.res.per.an <- ggplot(Bdiff.bbn.20.y) + geom_line(aes(x=Year, y=res.per)) + scale_x_continuous(name="",breaks = seq(1980,2030,by=3)) + ylab("Fully-Recruited Biomass Residual (%)")

p.res.annual <- plot_grid(p.res.abs.an,p.res.per.an,ncol=1)

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_resid_time_series.png"),p.res.annual,base_width = 6,base_height = 8)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_resid_time_series.png"),p.res.annual,base_width = 6,base_height = 8)

# Now plot the residuals spatially


bd.brk <- pretty(Bdiff.bbn.20$B.diff)
bd.lab <- bd.brk#signif(exp(b.brk),digits=2)

spatial.Bdiff.plot<- ggplot() + geom_sf(data=Bdiff.bbn.20,aes(fill=B.diff),color='grey')+
                                facet_wrap(~Year,ncol=5)+ 
                                # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                scale_fill_distiller(type = 'div',breaks = bd.brk, labels=bd.lab, name="Process \nResidual \n(tonnes)",palette = "RdBu") + 
                                theme(axis.text.x=element_text(angle=-45,hjust=0))
if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_res.png"),spatial.Bdiff.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_res.png"),spatial.Bdiff.plot,base_width = 12,base_height = 16)

pb.brk <- pretty(Bdiff.bbn.20$B.per.diff)
pb.lab <- pb.brk#signif(exp(b.brk),digits=2)

spatial.Bdiff.per.plot<- ggplot() + geom_sf(data=Bdiff.bbn.20,aes(fill=B.per.diff),color='grey')+
                                    facet_wrap(~Year,ncol=5)+ 
                                    # scale_x_continuous(breaks = c(-61.66667,-61), labels = c("61° 40'W","61° W")) +
                                    # scale_y_continuous(breaks = c(43.33333, 43.666667, 44),labels = c("43°20'N","43°40'N","44°N")) +
                                    scale_fill_distiller(type = 'div',breaks = pb.brk, labels=pb.lab, name="Process \nResidual \n(%)",palette = "RdBu") + 
                                    theme(axis.text.x=element_text(angle=-45,hjust=0))
if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_Spatial_res_per.png"),spatial.Bdiff.per.plot,base_width = 12,base_height = 16)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/",mod.select,"_",scenario.20,"_vary_q=TRUE/French/BBn_Spatial_res.per.png"),spatial.Bdiff.per.plot,base_width = 12,base_height = 16)

```

<!-- And finally the retrospective figures, starting with SFA 25a -->


```{r sfa25-retros, echo=F,include=F}

cols <- c(rep('#005BBB',4),rep('firebrick2',4),rep('darkgrey',4),rep('#FFD500',3),'black')
points <- c(rep(21:24,4)) 
b.retro <- ggplot(data=retro.sab %>% dplyr::filter(years < 2015),aes(x= years, y = B/1000,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_line(data=retro.sab %>% dplyr::filter(years %in% 2016:2019),size=1)+
                                    geom_point(data=retro.sab %>% dplyr::filter(years %in% c(1994:2014,2016:2019,2021)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Fully-recruited biomass (tonnes x 1000)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/English/Sab_biomass_retro.png"),b.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/English/Sab_biomass_retro.png"),b.retro,base_width = 8,base_height = 6)


r.retro <- ggplot(data=retro.sab %>% dplyr::filter(years < 2015),aes(x= years, y = R,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_line(data=retro.sab %>% dplyr::filter(years %in% 2016:2019),size=1)+
                                    geom_point(data=retro.sab %>% dplyr::filter(years %in% c(1994:2014,2016:2019,2021)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Recruit biomass (tonnes)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/English/Sab_recruit_retro.png"),r.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/English/Sab_recruit_retro.png"),r.retro,base_width = 8,base_height = 6)


m.retro <- ggplot(data=retro.sab %>% dplyr::filter(years < 2015),aes(x= years, y = m,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                  geom_line(size=1) + 
                                  geom_line(data=retro.sab %>% dplyr::filter(years %in% 2016:2019),size=1)+
                                  geom_point(data=retro.sab %>% dplyr::filter(years %in% c(1994:2014,2016:2019,2021)),size=3) + 
                                  scale_shape_manual("",values = points) + 
                                  scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                  scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                  ylab("Natural mortality (instantaneous)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/English/Sab_nm_retro.png"),m.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/Sab/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.10,"/English/Sab_nm_retro.png"),m.retro,base_width = 8,base_height = 6)



```

<!-- And maybe finally, the retros for SFA 26 -->


```{r sfa26-retros, echo=F,include=F}

cols <- c(rep('#005BBB',4),rep('firebrick2',4),rep('darkgrey',4),rep('#FFD500',4),'black')
points <- rep(21:24,5) 

b.retro <- ggplot(data=retro.bbn %>% dplyr::filter(years < 2020),aes(x= years, y = B/1000,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_point(data=retro.bbn %>% dplyr::filter(!years %in% c(2020,2022)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    #geom_line(data=base.trend,aes(x=years, y = B,color=retro.year),size=1) +
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Fully recruited biomass (tonnes x 1000)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_biomass_retro.png"),b.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_biomass_retro.png"),b.retro,base_width = 8,base_height = 6)



r.retro <- ggplot(data=retro.bbn %>% dplyr::filter(years < 2020),aes(x= years, y = R/1000,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_point(data=retro.bbn %>% dplyr::filter(!years %in% c(2020,2022)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    #geom_line(data=base.trend,aes(x=years, y = B,color=retro.year),size=1) +
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Recruited biomass (tonnes x 1000)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_recruit_retro.png"),r.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_recruit_retro.png"),r.retro,base_width = 8,base_height = 6)


m.retro <- ggplot(data=retro.bbn %>% dplyr::filter(years < 2020),aes(x= years, y = m,group=retro.year,color=retro.year,shape = retro.year,fill = retro.year)) +
                                    geom_line(size=1) + 
                                    geom_point(data=retro.bbn %>% dplyr::filter(!years %in% c(2020,2022)),size=3) + 
                                    scale_shape_manual("",values = points) + 
                                    #geom_line(data=base.trend,aes(x=years, y = B,color=retro.year),size=1) +
                                    scale_color_manual("",values =cols) + scale_fill_manual("",values =cols) +
                                    scale_x_continuous(breaks = seq(1990,2030,by=3)) + xlab("") + 
                                    ylab("Natural mortality (instantaneous)")

if(language == 'english') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_nm_retro.png"),m.retro,base_width = 8,base_height = 6)
if(language == 'french') save_plot(paste0(repo.loc,"Figures/BBn/R_",R.size,"_FR_",FR.size,"/Retros/",mod.select,"_",scenario.20,"_vary_q=TRUE/English/BBn_nm_retro.png"),m.retro,base_width = 8,base_height = 6)



```